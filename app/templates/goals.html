{% extends "base.html" %}

{% block title %}‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container page-loading">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="target"></i>
                ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô{% if user %} - {{ user.display_name }}{% endif %}
            </h1>
            <p class="subtitle">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="goals-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i data-lucide="target"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="goals-count">0</div>
                <div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
            </div>
        </div>

        <div class="stat-card income">
            <div class="stat-icon">
                <i data-lucide="piggy-bank"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="total-saved">‡∏ø0</div>
                <div class="stat-label">‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
            </div>
        </div>

        <div class="stat-card expense">
            <div class="stat-icon">
                <i data-lucide="flag"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="avg-progress">0%</div>
                <div class="stat-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
        </div>
    </div>

    <!-- Goals List -->
    <div class="section">
        <div class="goals-list">
            <!-- Empty State -->
            <div class="empty-state">
                <i data-lucide="target"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</p>
                <p class="empty-subtitle">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</p>
            </div>
        </div>
    </div>

    <div class="footer-spacing"></div>
</div>

<!-- Floating Action Button -->
<div class="floating-action">
    <button class="btn-fab" id="add-goal-btn">
        <i data-lucide="plus"></i>
    </button>
</div>

<!-- Modal: Add/Edit Goal -->
<div class="modal" id="goal-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header income">
            <h2>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="goal-form">
            <input type="hidden" id="goal-edit-id">
            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ -->
            <div class="form-group">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                <input type="text" class="form-input" id="goal-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠ iPhone, ‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß"
                    required>
            </div>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ -->
            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="goal-amount" placeholder="50000" required>
                </div>
            </div>

            <!-- ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                <input type="number" class="form-input" id="goal-months" placeholder="6" min="1" max="120" value="6"
                    required>
                <small class="form-hint">‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</small>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Add Contribution -->
<div class="modal" id="contribute-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header income">
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="contribute-form">
            <input type="hidden" id="contribute-goal-id">
            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="contribute-amount" placeholder="5000"
                        required>
                </div>
            </div>
            <button type="submit" class="btn-primary">
                <i data-lucide="plus"></i>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Withdraw -->
<div class="modal" id="withdraw-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header expense">
            <h2>‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="withdraw-form">
            <input type="hidden" id="withdraw-goal-id">
            <div class="goal-current-info" id="withdraw-info"></div>
            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="withdraw-amount" placeholder="1000"
                        required>
                </div>
            </div>
            <button type="submit" class="btn-danger">
                <i data-lucide="minus"></i>
                <span>‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
            </button>
        </form>
    </div>
</div>

<!-- Footer Menu -->
{% set current_page = 'goals' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // Modal controls
    const goalModal = document.getElementById('goal-modal');
    const contributeModal = document.getElementById('contribute-modal');
    const addBtn = document.getElementById('add-goal-btn');

    function openModal(modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    document.querySelectorAll('.modal-close, .modal-overlay').forEach(el => {
        el.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal) closeModal(modal);
        });
    });

    // Load goals
    async function loadGoals() {
        try {
            const result = await API.get(buildApiUrl('savings-goals'));
            const goalsList = document.querySelector('.goals-list');

            if (result.savings_goals && result.savings_goals.length > 0) {
                renderGoals(result.savings_goals);
            } else {
                goalsList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="target"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</p>
                    <p class="empty-subtitle">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</p>
                    <button class="btn-primary" onclick="openModal(goalModal)">
                        <i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏Å
                    </button>
                </div>
            `;
                lucide.createIcons();
            }
        } catch (error) {
            console.error('Error loading goals:', error);
        }
    }

    function renderGoals(goals) {
        const goalsList = document.querySelector('.goals-list');

        // Update stats
        let totalSaved = 0;
        let totalProgress = 0;

        goals.forEach(goal => {
            totalSaved += goal.current_amount || 0;
            totalProgress += goal.progress_percentage || 0;
        });

        document.getElementById('goals-count').textContent = goals.length;
        document.getElementById('total-saved').textContent = '‡∏ø' + (totalSaved / 100).toLocaleString('th-TH');
        document.getElementById('avg-progress').textContent = Math.round(totalProgress / goals.length) + '%';

        // Render cards
        goalsList.innerHTML = goals.map(goal => {
            const current = (goal.current_amount || 0) / 100;
            const target = goal.target_amount / 100;
            const progress = goal.progress_percentage || 0;
            const isCompleted = goal.is_completed;
            const isOverdue = goal.is_overdue;
            const progressColor = progress >= 100 ? 'complete' : progress >= 80 ? 'warning' : 'normal';

            return `
            <div class="goal-card ${isCompleted ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${goal.id}">
                <div class="goal-card-header">
                    <div class="goal-main-info">
                        <div class="goal-icon-wrapper">
                            <i data-lucide="${isCompleted ? 'check-circle' : 'target'}"></i>
                        </div>
                        <div class="goal-title-section">
                            <h3 class="goal-title">${goal.name}</h3>
                            ${goal.days_remaining !== null && !isCompleted ? `
                                <span class="goal-subtitle ${isOverdue ? 'overdue' : ''}">
                                    <i data-lucide="calendar"></i>
                                    ${isOverdue ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${goal.days_remaining} ‡∏ß‡∏±‡∏ô`}
                                </span>
                            ` : ''}
                            ${isCompleted ? `
                                <span class="goal-subtitle success">
                                    <i data-lucide="trophy"></i>
                                    ‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="goal-menu-wrapper">
                        <button class="btn-menu" onclick="toggleGoalMenu('${goal.id}')" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
                            <i data-lucide="more-vertical"></i>
                        </button>
                        <div class="dropdown-menu" id="menu-${goal.id}">
                            ${!isCompleted ? `
                                <button class="menu-item primary" onclick="openContribute('${goal.id}'); closeAllMenus();">
                                    <i data-lucide="plus-circle"></i>
                                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span>
                                </button>
                            ` : ''}
                            ${!isCompleted && current > 0 ? `
                                <button class="menu-item warning" onclick="openWithdraw('${goal.id}', '${goal.name}', ${current}); closeAllMenus();">
                                    <i data-lucide="minus-circle"></i>
                                    <span>‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                                </button>
                            ` : ''}
                            <button class="menu-item" onclick="openEdit('${goal.id}', '${goal.name}', ${goal.target_amount}, ${goal.days_remaining || 30}); closeAllMenus();">
                                <i data-lucide="edit-2"></i>
                                <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                            </button>
                            <button class="menu-item danger" onclick="deleteGoal('${goal.id}'); closeAllMenus();">
                                <i data-lucide="trash-2"></i>
                                <span>‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="goal-amount-section">
                    <div class="amount-current">
                        <span class="amount-label">‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>
                        <span class="amount-value">‡∏ø${current.toLocaleString('th-TH', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="amount-target">
                        <span class="amount-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
                        <span class="amount-value">‡∏ø${target.toLocaleString('th-TH', {minimumFractionDigits: 2})}</span>
                    </div>
                </div>

                <div class="goal-progress-section">
                    <div class="progress-bar-large">
                        <div class="progress-fill-large ${progressColor}" style="width: ${Math.min(progress, 100)}%">
                            <span class="progress-percentage">${progress.toFixed(0)}%</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');

        lucide.createIcons();
    }

    // Menu toggle functions
    function toggleGoalMenu(goalId) {
        const menu = document.getElementById(`menu-${goalId}`);
        const isOpen = menu.classList.contains('show');

        // Close all menus first
        closeAllMenus();

        // Toggle current menu
        if (!isOpen) {
            menu.classList.add('show');
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.goal-menu-wrapper')) {
            closeAllMenus();
        }
    });

    // Open contribute modal
    function openContribute(goalId) {
        document.getElementById('contribute-goal-id').value = goalId;
        document.getElementById('contribute-amount').value = '';
        openModal(contributeModal);
    }

    // Open edit modal
    function openEdit(goalId, name, targetAmount, daysRemaining) {
        document.getElementById('goal-edit-id').value = goalId;
        document.getElementById('goal-name').value = name;
        document.getElementById('goal-amount').value = targetAmount / 100; // satang to baht
        document.getElementById('goal-months').value = Math.ceil(daysRemaining / 30) || 6;

        // Update modal header
        document.querySelector('#goal-modal .modal-header h2').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
        openModal(goalModal);
    }

    // Reset form when opening for add
    addBtn.addEventListener('click', () => {
        document.getElementById('goal-edit-id').value = '';
        document.getElementById('goal-form').reset();
        document.getElementById('goal-months').value = '6';
        document.querySelector('#goal-modal .modal-header h2').textContent = '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô';
        openModal(goalModal);
    });

    // Create/Update goal
    document.getElementById('goal-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        const editId = document.getElementById('goal-edit-id').value;
        const isEdit = !!editId;

        const payload = {
            name: document.getElementById('goal-name').value,
            target_amount: Math.round(parseFloat(document.getElementById('goal-amount').value) * 100),
            months: parseInt(document.getElementById('goal-months').value)
        };

        try {
            if (isEdit) {
                await API.put(buildApiUrl('savings-goals', editId), payload);
                showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
                await API.post(buildApiUrl('savings-goals'), payload);
                showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }
            closeModal(goalModal);
            document.getElementById('goal-form').reset();
            await loadGoals();
        } catch (error) {
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Add contribution
    document.getElementById('contribute-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        const goalId = document.getElementById('contribute-goal-id').value;
        const amount = Math.round(parseFloat(document.getElementById('contribute-amount').value) * 100);

        try {
            await API.post(buildApiUrl('savings-goals', goalId, 'contribute'), { amount });
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            closeModal(contributeModal);
            await loadGoals();
        } catch (error) {
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Withdraw modal
    const withdrawModal = document.getElementById('withdraw-modal');

    function openWithdraw(goalId, goalName, currentAmount) {
        document.getElementById('withdraw-goal-id').value = goalId;
        document.getElementById('withdraw-amount').value = '';
        document.getElementById('withdraw-info').innerHTML = `
            <div class="info-box">
                <strong>üéØ ${goalName}</strong><br>
                <span>‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏ø${currentAmount.toLocaleString('th-TH')}</span>
            </div>
        `;
        openModal(withdrawModal);
    }

    // Withdraw submit
    document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        const goalId = document.getElementById('withdraw-goal-id').value;
        const amount = Math.round(parseFloat(document.getElementById('withdraw-amount').value) * 100);

        try {
            await API.post(buildApiUrl('savings-goals', goalId, 'withdraw'), { amount });
            showToast('‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            closeModal(withdrawModal);
            await loadGoals();
        } catch (error) {
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Delete goal
    async function deleteGoal(goalId) {
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

        try {
            await API.delete(buildApiUrl('savings-goals', goalId));
            showToast('‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            await loadGoals();
        } catch (error) {
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    }

    // Load on page ready
    document.addEventListener('DOMContentLoaded', async () => {
        await loadGoals();

        const container = document.querySelector('.mobile-container');
        if (container) {
            container.classList.remove('page-loading');
            container.classList.add('fade-in');
        }

        lucide.createIcons();
    });
</script>

<style>
    /* Goals Stats */
    .goals-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        padding: 0 1rem;
        margin-bottom: 1rem;
    }

    /* ===== MINIMAL CARD DESIGN ===== */
    .goal-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 22px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        animation: fadeInUp 0.3s ease;
    }

    .goal-card:hover {
        border-width: 2px;
        padding: 21px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .goal-card.completed {
        border-color: var(--income-color);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.03) 0%, var(--card-bg) 100%);
    }

    .goal-card.overdue {
        border-color: var(--expense-color);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.03) 0%, var(--card-bg) 100%);
    }

    /* Card Header */
    .goal-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .goal-main-info {
        display: flex;
        gap: 12px;
        flex: 1;
        align-items: flex-start;
    }

    .goal-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: color-mix(in srgb, var(--income-color) 10%, transparent);
        border: 2px solid color-mix(in srgb, var(--income-color) 35%, var(--border-color) 65%);
        color: var(--income-color);
        flex-shrink: 0;
    }

    .goal-card.completed .goal-icon-wrapper {
        background: color-mix(in srgb, var(--income-color) 15%, transparent);
        border-color: var(--income-color);
        color: var(--income-color);
    }

    .goal-card.overdue .goal-icon-wrapper {
        background: color-mix(in srgb, var(--expense-color) 10%, transparent);
        border: 2px solid color-mix(in srgb, var(--expense-color) 35%, var(--border-color) 65%);
        color: var(--expense-color);
    }

    .goal-title-section {
        flex: 1;
        min-width: 0;
    }

    .goal-title {
        font-size: 19px;
        font-weight: 700;
        margin: 0 0 8px 0;
        color: var(--text-primary);
        line-height: 1.3;
    }

    .goal-subtitle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .goal-subtitle i {
        width: 14px;
        height: 14px;
    }

    .goal-subtitle.overdue {
        color: var(--expense-color);
    }

    .goal-subtitle.success {
        color: var(--income-color);
    }

    /* Menu Button & Dropdown */
    .goal-menu-wrapper {
        position: relative;
    }

    .btn-menu {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: none;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .btn-menu:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-menu:active {
        transform: scale(0.95);
    }

    .dropdown-menu {
        position: absolute;
        top: 42px;
        right: 0;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        min-width: 180px;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px) scale(0.95);
        transition: all 0.2s ease;
    }

    .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }

    .menu-item {
        width: 100%;
        padding: 12px 16px;
        border: none;
        background: transparent;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
        text-align: left;
        transition: all 0.15s ease;
    }

    .menu-item:first-child {
        border-radius: 12px 12px 0 0;
    }

    .menu-item:last-child {
        border-radius: 0 0 12px 12px;
    }

    .menu-item:hover {
        background: var(--bg-secondary);
    }

    .menu-item i {
        width: 18px;
        height: 18px;
    }

    .menu-item.primary {
        color: var(--income-color);
    }

    .menu-item.warning {
        color: #f59e0b;
    }

    .menu-item.danger {
        color: var(--expense-color);
    }

    /* Amount Section */
    .goal-amount-section {
        display: flex;
        justify-content: space-between;
        margin-bottom: 18px;
        padding: 18px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .amount-current,
    .amount-target {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        padding: 0 12px;
    }

    .amount-current {
        border-right: 1px solid var(--border-color);
    }

    .amount-label {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .amount-value {
        font-size: 19px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Progress Section */
    .goal-progress-section {
        margin-top: 18px;
    }

    .progress-bar-large {
        height: 42px;
        background: var(--bg-secondary);
        border-radius: 21px;
        overflow: visible;
        position: relative;
        border: 1px solid var(--border-color);
    }

    .progress-fill-large {
        height: 100%;
        border-radius: 21px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .progress-fill-large.normal {
        background: linear-gradient(90deg, var(--income-color), #34d399);
    }

    .progress-fill-large.warning {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .progress-fill-large.complete {
        background: linear-gradient(90deg, #10b981, #059669);
    }

    .progress-percentage {
        font-size: 15px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        z-index: 1;
    }

    /* Utility Classes */
    .form-hint {
        display: block;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .btn-danger {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background: var(--expense-color);
        color: white;
        transition: all 0.2s;
    }

    .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-2px);
    }

    .info-box {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        text-align: center;
    }

    .info-box strong {
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .info-box span {
        color: var(--text-secondary);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .goal-card {
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .goal-card:hover {
            padding: 17px;
        }

        .goal-icon-wrapper {
            width: 44px;
            height: 44px;
        }

        .goal-title {
            font-size: 17px;
        }

        .goal-subtitle {
            font-size: 13px;
        }

        .goal-amount-section {
            padding: 14px;
        }

        .amount-current,
        .amount-target {
            padding: 0 8px;
        }

        .amount-label {
            font-size: 12px;
        }

        .amount-value {
            font-size: 17px;
        }

        .progress-bar-large {
            height: 38px;
        }

        .progress-percentage {
            font-size: 14px;
        }

        .goals-stats {
            gap: 0.5rem;
            padding: 0 0.75rem;
        }

        .btn-menu {
            width: 34px;
            height: 34px;
            -webkit-tap-highlight-color: transparent;
        }

        .dropdown-menu {
            min-width: 160px;
        }
    }
</style>
{% endblock %}