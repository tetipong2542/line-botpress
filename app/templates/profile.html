{% extends "base.html" %}

{% block title %}‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="user"></i>
                ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</p>
        </div>
    </div>

    <!-- User Profile Section -->
    <div class="section">
        <div class="profile-card">
            <div class="profile-avatar">
                {% if user and user.picture_url %}
                <img src="{{ user.picture_url }}" alt="{{ user.display_name }}" class="profile-avatar-img">
                {% else %}
                <i data-lucide="user"></i>
                {% endif %}
            </div>
            <div class="profile-info">
                <h2>{% if user %}{{ user.display_name }}{% else %}Guest User{% endif %}</h2>
                <p class="profile-email">
                    {% if user and user.email %}
                    {{ user.email }}
                    {% elif user %}
                    LINE ID: {{ user.line_user_id[:8] }}...
                    {% else %}
                    ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Footer Menu) -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="settings"></i>
                ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
            </h2>
        </div>

        <div class="settings-list">
            <a href="/members" class="setting-item">
                <div class="setting-icon">
                    <i data-lucide="users"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
                    <div class="setting-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</div>
                </div>
            </a>

            <a href="/budgets" class="setting-item">
                <div class="setting-icon">
                    <i data-lucide="target"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
                    <div class="setting-desc">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
                </div>
            </a>

            <a href="/goals" class="setting-item">
                <div class="setting-icon">
                    <i data-lucide="piggy-bank"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div class="setting-desc">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                </div>
            </a>

            <a href="#" class="setting-item" id="notifications-settings">
                <div class="setting-icon">
                    <i data-lucide="bell"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                    <div class="setting-desc">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                </div>
            </a>

            <div class="setting-item" id="dark-mode-setting">
                <div class="setting-icon">
                    <i data-lucide="moon"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</div>
                    <div class="setting-desc">‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏°‡∏∑‡∏î</div>
                </div>
                <div class="setting-toggle">
                    <label class="switch">
                        <input type="checkbox" class="dark-mode-toggle" id="dark-mode-toggle-switch">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <a href="#" class="setting-item" id="about-app">
                <div class="setting-icon">
                    <i data-lucide="info"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏õ</div>
                    <div class="setting-desc">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 1.0.0</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Help Center -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="help-circle"></i>
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            </h2>
        </div>

        <div class="settings-list">
            <a href="/help" class="setting-item">
                <div class="setting-icon">
                    <i data-lucide="help-circle"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    <div class="setting-desc">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</div>
                </div>
            </a>
        </div>
    </div>

    <!-- LINE Chatbot Connection -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="message-square"></i>
                ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE Chatbot
            </h2>
        </div>

        <div class="settings-list">
            <!-- Connection Status -->
            <div class="setting-item" id="chatbot-status-item">
                <div class="setting-icon" style="background: linear-gradient(135deg, #06D6A0 0%, #10B981 100%);">
                    <i data-lucide="bot"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title" id="chatbot-status-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
                    <div class="setting-desc" id="chatbot-status-desc">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
                </div>
            </div>

            <!-- Generate Link Code Button -->
            <div class="setting-item" id="generate-link-code-btn" style="cursor: pointer;">
                <div class="setting-icon" style="background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);">
                    <i data-lucide="key"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
                    <div class="setting-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ 6 ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE Chatbot</div>
                </div>
                <div class="setting-chevron">
                    <i data-lucide="chevron-right"></i>
                </div>
            </div>

            <!-- Generated Code Display (hidden by default) -->
            <div class="setting-item" id="link-code-display" style="display: none; cursor: pointer;"
                onclick="copyLinkCode()">
                <div class="setting-icon" style="background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);">
                    <i data-lucide="copy"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title" id="link-code-text"
                        style="font-family: monospace; font-size: 18px; letter-spacing: 2px;">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ABC123</div>
                    <div class="setting-desc">üëÜ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó LINE</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Features (Export) -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="download"></i>
                ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </h2>
        </div>

        <div class="settings-list">
            <a href="/api/v1/export/csv" class="setting-item" id="export-csv">
                <div class="setting-icon">
                    <i data-lucide="file-spreadsheet"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</div>
                    <div class="setting-desc">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV</div>
                </div>
            </a>

            <a href="/api/v1/export/json" class="setting-item" id="export-json">
                <div class="setting-icon">
                    <i data-lucide="file-json"></i>
                </div>
                <div class="setting-info">
                    <div class="setting-title">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON</div>
                    <div class="setting-desc">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Logout Button -->
    <div class="section">
        <button class="btn-logout" id="logout-btn">
            <i data-lucide="log-out"></i>
            <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
        </button>
    </div>

    <!-- Footer -->
    <div class="section" style="text-align: center; padding: 20px 0;">
        <p style="font-size: 12px; color: var(--text-secondary);">
            ‡∏ó‡∏≥‡∏î‡πâ‡∏ß‡∏¢ ‚ù§Ô∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‚Ä¢ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 1.0.0
        </p>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Modal: Notification Settings -->
<div class="modal" id="notification-settings-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white;">
            <h2>
                <i data-lucide="bell"></i>
                ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            </h2>
            <button class="modal-close" style="color: white;">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Budget Alerts -->
            <div class="notification-section">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="target"></i>
                    ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                </h3>

                <div class="notification-toggle-item">
                    <div class="notification-toggle-info">
                        <div class="notification-toggle-title">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
                        <div class="notification-toggle-desc">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="budget-alerts-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="notification-settings-detail" id="budget-threshold-setting">
                    <label class="form-label">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ñ‡∏∂‡∏á</label>
                    <select class="form-select" id="budget-threshold">
                        <option value="50">50% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="70">70% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="80" selected>80% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="90">90% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                        <option value="100">100% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option>
                    </select>
                </div>
            </div>

            <!-- Recurring Reminders -->
            <div class="notification-section">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="refresh-cw"></i>
                    ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥
                </h3>

                <div class="notification-toggle-item">
                    <div class="notification-toggle-info">
                        <div class="notification-toggle-title">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                        <div class="notification-toggle-desc">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="recurring-reminders-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="notification-settings-detail" id="reminder-days-setting">
                    <label class="form-label">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                    <select class="form-select" id="reminder-days">
                        <option value="0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option>
                        <option value="1" selected>1 ‡∏ß‡∏±‡∏ô</option>
                        <option value="2">2 ‡∏ß‡∏±‡∏ô</option>
                        <option value="3">3 ‡∏ß‡∏±‡∏ô</option>
                        <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
                    </select>
                </div>
            </div>

            <!-- LINE Notifications -->
            <div class="notification-section">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="message-circle"></i>
                    ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE
                </h3>

                <div class="notification-toggle-item">
                    <div class="notification-toggle-info">
                        <div class="notification-toggle-title">‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE</div>
                        <div class="notification-toggle-desc">‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="line-notifications-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Save Button -->
            <div style="margin-top: 24px;">
                <button class="btn-primary" id="save-notification-settings">
                    <i data-lucide="check"></i>
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'profile' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // Notification Settings Modal
    const notificationModal = document.getElementById('notification-settings-modal');
    const notificationCloseBtn = notificationModal.querySelector('.modal-close');
    const notificationOverlay = notificationModal.querySelector('.modal-overlay');

    function openNotificationSettings() {
        notificationModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        loadNotificationPreferences();
    }

    function closeNotificationSettings() {
        notificationModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Open modal
    document.getElementById('notifications-settings').addEventListener('click', (e) => {
        e.preventDefault();
        openNotificationSettings();
    });

    // Close modal
    notificationCloseBtn.addEventListener('click', closeNotificationSettings);
    notificationOverlay.addEventListener('click', closeNotificationSettings);

    // Load notification preferences
    async function loadNotificationPreferences() {
        try {
            const response = await fetch('/api/v1/notifications/preferences');
            if (response.ok) {
                const result = await response.json();
                const prefs = result.preferences;

                // Update UI
                document.getElementById('budget-alerts-toggle').checked = prefs.budget_alerts;
                document.getElementById('budget-threshold').value = prefs.budget_threshold;
                document.getElementById('recurring-reminders-toggle').checked = prefs.recurring_reminders;
                document.getElementById('reminder-days').value = prefs.reminder_days_before;
                document.getElementById('line-notifications-toggle').checked = prefs.line_notifications;

                // Show/hide detail settings
                toggleBudgetThresholdSetting();
                toggleReminderDaysSetting();
            }
        } catch (error) {
            console.error('Error loading preferences:', error);
        }
    }

    // Toggle budget threshold setting
    document.getElementById('budget-alerts-toggle').addEventListener('change', toggleBudgetThresholdSetting);

    function toggleBudgetThresholdSetting() {
        const isEnabled = document.getElementById('budget-alerts-toggle').checked;
        const setting = document.getElementById('budget-threshold-setting');
        setting.style.display = isEnabled ? 'block' : 'none';
    }

    // Toggle reminder days setting
    document.getElementById('recurring-reminders-toggle').addEventListener('change', toggleReminderDaysSetting);

    function toggleReminderDaysSetting() {
        const isEnabled = document.getElementById('recurring-reminders-toggle').checked;
        const setting = document.getElementById('reminder-days-setting');
        setting.style.display = isEnabled ? 'block' : 'none';
    }

    // Save notification settings
    document.getElementById('save-notification-settings').addEventListener('click', async () => {
        const preferences = {
            budget_alerts: document.getElementById('budget-alerts-toggle').checked,
            budget_threshold: parseInt(document.getElementById('budget-threshold').value),
            recurring_reminders: document.getElementById('recurring-reminders-toggle').checked,
            reminder_days_before: parseInt(document.getElementById('reminder-days').value),
            line_notifications: document.getElementById('line-notifications-toggle').checked
        };

        try {
            const response = await fetch('/api/v1/notifications/preferences', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(preferences)
            });

            if (response.ok) {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ', 'success');
                closeNotificationSettings();
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        } catch (error) {
            console.error('Error saving preferences:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    window.location.href = '/';
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                }
            } catch (error) {
                console.error('Logout error:', error);
                // Fallback: redirect anyway
                window.location.href = '/';
            }
        }
    });

    // About App
    document.getElementById('about-app').addEventListener('click', (e) => {
        e.preventDefault();
        alert('üì± PromptJOD {‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏î}\n\n‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 1.0.0\n\n‡πÅ‡∏≠‡∏õ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î\n‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢\n\nMade with ‚ù§Ô∏è');
    });

    // Dark Mode Toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle-switch');
    if (darkModeToggle) {
        // Set initial state based on current theme
        darkModeToggle.checked = window.getCurrentTheme() === 'dark';

        // Add event listener
        darkModeToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                window.toggleDarkMode();
            } else {
                window.toggleDarkMode();
            }
        });
    }

    // Disabled features
    document.querySelectorAll('.setting-item.disabled').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const title = item.querySelector('.setting-title').textContent;
            const badge = item.querySelector('.feature-badge');

            if (badge.classList.contains('coming-soon')) {
                showToast(`üöÄ ${title}\n\n‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ\n‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà!`, 'info');
            } else if (badge.classList.contains('in-development')) {
                showToast(`üë®‚Äçüíª ${title}\n\n‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤\n‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ!`, 'info');
            }
        });
    });

    // ========================================
    // LINE Chatbot Connection
    // ========================================
    let currentLinkCode = null;

    // Check chatbot connection status on page load
    async function checkChatbotStatus() {
        try {
            const response = await fetch('/api/v1/user/link-status');
            if (response.ok) {
                const data = await response.json();
                const statusTitle = document.getElementById('chatbot-status-title');
                const statusDesc = document.getElementById('chatbot-status-desc');
                const generateBtn = document.getElementById('generate-link-code-btn');
                const statusIcon = document.querySelector('#chatbot-status-item .setting-icon');

                if (data.is_linked) {
                    statusTitle.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
                    statusDesc.textContent = '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE Chatbot ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ';
                    statusIcon.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                    generateBtn.style.display = 'none';
                } else {
                    statusTitle.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‚ö†Ô∏è';
                    statusDesc.textContent = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    statusIcon.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
                    generateBtn.style.display = 'flex';
                }
            }
        } catch (error) {
            console.error('Error checking chatbot status:', error);
        }
    }

    // Generate Link Code
    document.getElementById('generate-link-code-btn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/v1/user/link-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                const data = await response.json();

                if (data.already_linked) {
                    showToast('‚úÖ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    checkChatbotStatus();
                    return;
                }

                currentLinkCode = data.code;
                const linkText = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ${currentLinkCode}`;

                // Show the code display
                document.getElementById('link-code-text').textContent = linkText;
                document.getElementById('link-code-display').style.display = 'flex';

                // Reinitialize lucide icons
                if (window.lucide) lucide.createIcons();

                showToast(`üîë ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${currentLinkCode}\n\n‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ\n‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å`, 'success');
            } else {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        } catch (error) {
            console.error('Error generating link code:', error);
            showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        }
    });

    // Copy Link Code to Clipboard
    function copyLinkCode() {
        if (!currentLinkCode) return;

        const linkText = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ${currentLinkCode}`;

        navigator.clipboard.writeText(linkText).then(() => {
            showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!\n\nüì± ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó LINE Chatbot\nüìù ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "' + linkText + '"\nüöÄ ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
        }).catch(err => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = linkText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!\n\nüì± ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó LINE Chatbot\nüìù ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "' + linkText + '"\nüöÄ ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
        });
    }

    // Check status on page load
    checkChatbotStatus();
</script>
{% endblock %}