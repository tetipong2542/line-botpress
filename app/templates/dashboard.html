{% extends "base.html" %}

{% block title %}‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="sparkles"></i>
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ{% if user %}, {{ user.display_name }}{% endif %}!
            </h1>
            <p class="subtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏û</p><span style="color: blue; font-weight: 700;"> PromptJOD {‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏î}</span>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-section">
        <div class="summary-card income">
            <div class="summary-icon">
                <i data-lucide="trending-up"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="summary-amount" id="income-summary">‡∏ø0</div>
            </div>
        </div>

        <div class="summary-card expense">
            <div class="summary-icon">
                <i data-lucide="trending-down"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="summary-amount" id="expense-summary">‡∏ø0</div>
            </div>
        </div>

        <div class="summary-card balance">
            <div class="summary-icon">
                <i data-lucide="wallet"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="summary-amount" id="balance-amount">‡∏ø0</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn expense" id="btn-add-expense">
            <i data-lucide="minus-circle"></i>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
        </button>
        <button class="quick-action-btn income" id="btn-add-income">
            <i data-lucide="plus-circle"></i>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
        </button>
    </div>

    <!-- Recent Transactions -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="list"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            </h2>
        </div>

        <div class="transactions-list" id="transactions-list">
            <div class="empty-state">
                <i data-lucide="inbox"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>
        </div>
    </div>

    <!-- Bottom spacing for footer menu -->
    <div class="footer-spacing"></div>
</div>

<!-- Modal: Expense Category Selector (Bottom Sheet) -->
<div class="modal bottom-sheet" id="expense-category-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
        </div>
        <div class="bottom-sheet-body">
            <div class="category-grid">
                <div class="category-grid-item" data-category="food">
                    <div class="category-grid-icon">üçî</div>
                    <div class="category-grid-label">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                </div>
                <div class="category-grid-item" data-category="transport">
                    <div class="category-grid-icon">üöó</div>
                    <div class="category-grid-label">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</div>
                </div>
                <div class="category-grid-item" data-category="housing">
                    <div class="category-grid-icon">üè†</div>
                    <div class="category-grid-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢</div>
                </div>
                <div class="category-grid-item" data-category="utilities">
                    <div class="category-grid-icon">üí°</div>
                    <div class="category-grid-label">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</div>
                </div>
                <div class="category-grid-item" data-category="healthcare">
                    <div class="category-grid-icon">üè•</div>
                    <div class="category-grid-label">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                </div>
                <div class="category-grid-item" data-category="entertainment">
                    <div class="category-grid-icon">üé¨</div>
                    <div class="category-grid-label">‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</div>
                </div>
                <div class="category-grid-item" data-category="education">
                    <div class="category-grid-icon">üìö</div>
                    <div class="category-grid-label">‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
                </div>
                <div class="category-grid-item" data-category="shopping">
                    <div class="category-grid-icon">üõçÔ∏è</div>
                    <div class="category-grid-label">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</div>
                </div>
                <div class="category-grid-item" data-category="tax">
                    <div class="category-grid-icon">üí∞</div>
                    <div class="category-grid-label">‡∏†‡∏≤‡∏©‡∏µ/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</div>
                </div>
                <div class="category-grid-item" data-category="installment">
                    <div class="category-grid-icon">üí≥</div>
                    <div class="category-grid-label">‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div>
                </div>
                <div class="category-grid-item" data-category="other">
                    <div class="category-grid-icon">üì¶</div>
                    <div class="category-grid-label">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Income Category Selector (Bottom Sheet) -->
<div class="modal bottom-sheet" id="income-category-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
        </div>
        <div class="bottom-sheet-body">
            <div class="category-grid">
                <div class="category-grid-item" data-category="salary">
                    <div class="category-grid-icon">üí∞</div>
                    <div class="category-grid-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
                <div class="category-grid-item" data-category="bonus">
                    <div class="category-grid-icon">üéÅ</div>
                    <div class="category-grid-label">‡πÇ‡∏ö‡∏ô‡∏±‡∏™</div>
                </div>
                <div class="category-grid-item" data-category="other-income">
                    <div class="category-grid-icon">üìà</div>
                    <div class="category-grid-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Expense Transaction -->
<div class="modal" id="expense-form-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="expense-form">
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" class="form-input" id="expense-category-display" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" class="form-input" id="expense-date" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                <input type="time" class="form-input" id="expense-time" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <textarea class="form-textarea" id="expense-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏á" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="expense-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Add Income Transaction -->
<div class="modal" id="income-form-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header income">
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="income-form">
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" class="form-input" id="income-category-display" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" class="form-input" id="income-date" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                <input type="time" class="form-input" id="income-time" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <textarea class="form-textarea" id="income-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="income-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'home' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
// ===== MODAL SYSTEM =====
const modals = {
    expenseCategory: document.getElementById('expense-category-modal'),
    incomeCategory: document.getElementById('income-category-modal'),
    expenseForm: document.getElementById('expense-form-modal'),
    incomeForm: document.getElementById('income-form-modal')
};

let selectedCategory = null;
let selectedCategoryLabel = null;

// Helper functions
function openModal(modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modal) {
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

function closeAllModals() {
    Object.values(modals).forEach(modal => closeModal(modal));
}

// ===== QUICK ACTIONS =====
document.getElementById('btn-add-expense').addEventListener('click', () => {
    openModal(modals.expenseCategory);
});

document.getElementById('btn-add-income').addEventListener('click', () => {
    openModal(modals.incomeCategory);
});

// ===== CATEGORY SELECTION =====
// Category click handlers are now dynamically attached in loadCategories() and attachCategoryHandlers()
// This ensures categories are loaded from the database with proper IDs

// ===== SET DEFAULT DATE/TIME =====
function setDefaultDateTime(type) {
    const now = new Date();
    const date = now.toISOString().split('T')[0];
    const time = now.toTimeString().slice(0, 5);

    document.getElementById(`${type}-date`).value = date;
    document.getElementById(`${type}-time`).value = time;
}

// ===== CLOSE BUTTONS =====
document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
        closeAllModals();
    });
});

// ===== OVERLAY CLICKS =====
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', () => {
        closeAllModals();
    });
});

// ===== ESC KEY =====
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeAllModals();
    }
});

// ===== EXPENSE FORM SUBMISSION =====
document.getElementById('expense-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Validation
    const amount = parseFloat(document.getElementById('expense-amount').value);
    if (!selectedCategory) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Prepare data
    const date = document.getElementById('expense-date').value;
    const time = document.getElementById('expense-time').value;
    const occurred_at = `${date}T${time}:00`;

    const payload = {
        type: 'expense',
        category_id: selectedCategory,
        amount: Math.round(amount * 100), // Convert baht to satang
        occurred_at: occurred_at,
        note: document.getElementById('expense-note').value || null
    };

    try {
        let result;
        if (editingTransactionId) {
            // Update existing transaction
            result = await API.put(buildApiUrl('transactions', editingTransactionId), payload);
            showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            // Create new transaction
            result = await API.post(buildApiUrl('transactions'), payload);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Reset form and state
        document.getElementById('expense-form').reset();
        selectedCategory = null;
        selectedCategoryLabel = null;
        editingTransactionId = null;

        // Reset button text
        const submitBtn = document.querySelector('#expense-form button[type="submit"] span');
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        closeAllModals();

        // Reload dashboard
        await loadDashboard();

    } catch (error) {
        console.error('Transaction error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// ===== INCOME FORM SUBMISSION =====
document.getElementById('income-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Validation
    const amount = parseFloat(document.getElementById('income-amount').value);
    if (!selectedCategory) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Prepare data
    const date = document.getElementById('income-date').value;
    const time = document.getElementById('income-time').value;
    const occurred_at = `${date}T${time}:00`;

    const payload = {
        type: 'income',
        category_id: selectedCategory,
        amount: Math.round(amount * 100), // Convert baht to satang
        occurred_at: occurred_at,
        note: document.getElementById('income-note').value || null
    };

    try {
        let result;
        if (editingTransactionId) {
            // Update existing transaction
            result = await API.put(buildApiUrl('transactions', editingTransactionId), payload);
            showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            // Create new transaction
            result = await API.post(buildApiUrl('transactions'), payload);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Reset form and state
        document.getElementById('income-form').reset();
        selectedCategory = null;
        selectedCategoryLabel = null;
        editingTransactionId = null;

        // Reset button text
        const submitBtn = document.querySelector('#income-form button[type="submit"] span');
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        closeAllModals();

        // Reload dashboard
        await loadDashboard();

    } catch (error) {
        console.error('Transaction error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// ===== LOAD CATEGORIES =====
async function loadCategories() {
    try {
        const result = await API.get(buildApiUrl('categories'));

        if (result.categories && result.categories.length > 0) {
            const categories = result.categories;

            // Separate by type
            const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
            const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

            // Helper function to render icon (Lucide or Emoji)
            const renderIcon = (iconName, defaultIcon = 'folder') => {
                // Check if it's emoji (unicode character) or Lucide icon name
                const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName || '');

                if (isEmoji || !iconName) {
                    // Return emoji or default emoji
                    return iconName || 'üìÅ';
                } else {
                    // Return Lucide icon
                    return `<i data-lucide="${iconName}"></i>`;
                }
            };

            // Update expense category grid
            const expenseCategoryGrid = document.querySelector('#expense-category-modal .category-grid');
            if (expenseCategoryGrid) {
                expenseCategoryGrid.innerHTML = expenseCategories.map(cat => `
                    <div class="category-grid-item" data-category-id="${cat.id}">
                        <div class="category-grid-icon">${renderIcon(cat.icon, 'folder')}</div>
                        <div class="category-grid-label">${cat.name_th}</div>
                    </div>
                `).join('');

                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Re-attach click handlers
                attachCategoryHandlers('#expense-category-modal');
            }

            // Update income category grid
            const incomeCategoryGrid = document.querySelector('#income-category-modal .category-grid');
            if (incomeCategoryGrid) {
                incomeCategoryGrid.innerHTML = incomeCategories.map(cat => `
                    <div class="category-grid-item" data-category-id="${cat.id}">
                        <div class="category-grid-icon">${renderIcon(cat.icon, 'dollar-sign')}</div>
                        <div class="category-grid-label">${cat.name_th}</div>
                    </div>
                `).join('');

                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Re-attach click handlers
                attachCategoryHandlers('#income-category-modal');
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// ===== ATTACH CATEGORY CLICK HANDLERS =====
function attachCategoryHandlers(modalSelector) {
    const modal = document.querySelector(modalSelector);
    if (!modal) return;

    const categoryItems = modal.querySelectorAll('.category-grid-item');
    categoryItems.forEach(item => {
        item.addEventListener('click', () => {
            const categoryId = item.dataset.categoryId;
            const label = item.querySelector('.category-grid-label').textContent;
            const icon = item.querySelector('.category-grid-icon').textContent;

            selectedCategory = categoryId;
            selectedCategoryLabel = `${icon} ${label}`;

            // Show in next modal
            closeModal(modal);

            setTimeout(() => {
                if (modalSelector.includes('expense')) {
                    document.getElementById('expense-category-display').value = selectedCategoryLabel;
                    setDefaultDateTime('expense');
                    openModal(modals.expenseForm);
                } else {
                    document.getElementById('income-category-display').value = selectedCategoryLabel;
                    setDefaultDateTime('income');
                    openModal(modals.incomeForm);
                }
            }, 300);
        });
    });
}

// ===== DASHBOARD DATA =====
async function loadDashboard() {
    try {
        // Load summary and transactions in parallel
        const [summaryPromise, transactionsPromise] = await Promise.allSettled([
            loadMonthlySummary(),
            API.get(buildApiUrl('transactions') + '?per_page=10&page=1')
        ]);

        // Handle transactions
        if (transactionsPromise.status === 'fulfilled') {
            const result = transactionsPromise.value;
            if (result.transactions && result.transactions.length > 0) {
                renderTransactions(result.transactions);
            } else {
                // Show empty state
                const transactionsList = document.getElementById('transactions-list');
                transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="inbox"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
        // Don't show error toast on load - user might not have project yet
    }
}

// ===== LOAD MONTHLY SUMMARY =====
async function loadMonthlySummary() {
    try {
        // Get current month in YYYY-MM format
        const now = new Date();
        const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        const result = await API.get(buildApiUrl(`analytics/summary?month=${month}`));
        
        if (result.summary) {
            updateSummaryCards(result.summary);
        }
    } catch (error) {
        console.error('Error loading summary:', error);
        // Silently fail - cards will show ‡∏ø0
    }
}

// ===== UPDATE SUMMARY CARDS =====
function updateSummaryCards(summary) {
    // Format number with Thai locale
    const formatMoney = (amount) => {
        return amount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // Update Income
    const incomeEl = document.getElementById('income-summary');
    if (incomeEl && summary.income) {
        incomeEl.textContent = `‡∏ø${formatMoney(summary.income.formatted)}`;
    }

    // Update Expense
    const expenseEl = document.getElementById('expense-summary');
    if (expenseEl && summary.expense) {
        expenseEl.textContent = `‡∏ø${formatMoney(summary.expense.formatted)}`;
    }

    // Update Balance
    const balanceEl = document.getElementById('balance-amount');
    if (balanceEl && summary.balance) {
        balanceEl.textContent = `‡∏ø${formatMoney(summary.balance.formatted)}`;
        // Update color based on positive/negative
        const isPositive = summary.balance.total >= 0;
        balanceEl.style.color = isPositive ? 'var(--success, #10b981)' : 'var(--error, #ef4444)';
    }

    console.log('Summary loaded:', summary);
}

// ===== RENDER TRANSACTIONS =====
function renderTransactions(transactions) {
    const transactionsList = document.getElementById('transactions-list');

    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) {
            return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
        } else if (date.toDateString() === yesterday.toDateString()) {
            return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô';
        } else {
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        }
    };

    const formatAmount = (amount) => {
        return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const renderIcon = (iconName) => {
        const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName || '');
        if (isEmoji || !iconName) {
            return `<span class="transaction-icon-emoji">${iconName || 'üìÅ'}</span>`;
        } else {
            return `<i data-lucide="${iconName}"></i>`;
        }
    };

    transactionsList.innerHTML = transactions.map(tx => `
        <div class="transaction-item ${tx.type}" data-transaction-id="${tx.id}">
            <div class="transaction-icon ${tx.type}">
                ${renderIcon(tx.category?.icon)}
            </div>
            <div class="transaction-info">
                <div class="transaction-title">${tx.category?.name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div class="transaction-meta">
                    <span class="transaction-date">${formatDate(tx.occurred_at)}</span>
                    ${tx.note ? `<span class="transaction-note">${tx.note}</span>` : ''}
                </div>
            </div>
            <div class="transaction-amount ${tx.type}">
                ${tx.type === 'expense' ? '-' : '+'}‡∏ø${formatAmount(tx.amount)}
            </div>
            <div class="transaction-actions">
                <button class="btn-icon btn-edit" onclick="editTransaction('${tx.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                    <i data-lucide="edit-2"></i>
                </button>
                <button class="btn-icon btn-delete" onclick="deleteTransaction('${tx.id}')" title="‡∏•‡∏ö">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        </div>
    `).join('');

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// ===== EDIT TRANSACTION =====
let editingTransactionId = null;

async function editTransaction(transactionId) {
    try {
        // Fetch transaction details
        const result = await API.get(buildApiUrl('transactions', transactionId));
        const tx = result.transaction;

        editingTransactionId = transactionId;

        // Pre-fill form based on type
        if (tx.type === 'expense') {
            document.getElementById('expense-category-display').value = `${tx.category?.icon || 'üìÅ'} ${tx.category?.name_th || ''}`;
            selectedCategory = tx.category_id;

            const occuredDate = new Date(tx.occurred_at);
            document.getElementById('expense-date').valueAsDate = occuredDate;
            document.getElementById('expense-time').value = occuredDate.toTimeString().substr(0,5);
            document.getElementById('expense-note').value = tx.note || '';
            document.getElementById('expense-amount').value = (tx.amount / 100).toFixed(2);

            // Change button text to indicate editing
            const submitBtn = document.querySelector('#expense-form button[type="submit"] span');
            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';

            openModal(modals.expenseForm);
        } else {
            document.getElementById('income-category-display').value = `${tx.category?.icon || 'üí∞'} ${tx.category?.name_th || ''}`;
            selectedCategory = tx.category_id;

            const occuredDate = new Date(tx.occurred_at);
            document.getElementById('income-date').valueAsDate = occuredDate;
            document.getElementById('income-time').value = occuredDate.toTimeString().substr(0,5);
            document.getElementById('income-note').value = tx.note || '';
            document.getElementById('income-amount').value = (tx.amount / 100).toFixed(2);

            // Change button text
            const submitBtn = document.querySelector('#income-form button[type="submit"] span');
            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';

            openModal(modals.incomeForm);
        }
    } catch (error) {
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

// ===== DELETE TRANSACTION =====
async function deleteTransaction(transactionId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    try {
        await API.delete(buildApiUrl('transactions', transactionId));

        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');

        // Reload dashboard
        await loadDashboard();

    } catch (error) {
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
    }
}

// ===== DEEP LINKING SUPPORT =====
function handleDeepLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const modalType = urlParams.get('openModal');

    if (modalType === 'expense') {
        setTimeout(() => openModal(modals.expenseCategory), 100);
    } else if (modalType === 'income') {
        setTimeout(() => openModal(modals.incomeCategory), 100);
    }
}

// Load on page ready
document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories(); // Load categories first
    await loadDashboard();
    handleDeepLink();
});
</script>
{% endblock %}
