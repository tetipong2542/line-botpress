{% extends "base.html" %}

{% block title %}‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="sparkles"></i>
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ{% if user %}, {{ user.display_name }}{% endif %}!
            </h1>
            <p class="subtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏û</p><span class="brand-text"> PromptJOD {‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏î}</span>
        </div>
    </div>

    <!-- Summary Cards Skeleton -->
    <div class="summary-section" id="summary-skeleton">
        <div class="summary-card">
            <div class="skeleton skeleton-circle"></div>
            <div class="summary-content">
                <div class="skeleton skeleton-text" style="width: 70%;"></div>
                <div class="skeleton skeleton-text" style="width: 90%; height: 1.5rem;"></div>
            </div>
        </div>
        <div class="summary-card">
            <div class="skeleton skeleton-circle"></div>
            <div class="summary-content">
                <div class="skeleton skeleton-text" style="width: 70%;"></div>
                <div class="skeleton skeleton-text" style="width: 90%; height: 1.5rem;"></div>
            </div>
        </div>
        <div class="summary-card">
            <div class="skeleton skeleton-circle"></div>
            <div class="summary-content">
                <div class="skeleton skeleton-text" style="width: 70%;"></div>
                <div class="skeleton skeleton-text" style="width: 90%; height: 1.5rem;"></div>
            </div>
        </div>
    </div>

    <!-- Summary Cards (Real Data) -->
    <div class="summary-section hidden" id="summary-cards">
        <div class="summary-card income">
            <div class="summary-icon">
                <i data-lucide="trending-up"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="summary-amount" id="income-summary">‡∏ø0</div>
            </div>
        </div>

        <div class="summary-card expense">
            <div class="summary-icon">
                <i data-lucide="trending-down"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="summary-amount" id="expense-summary">‡∏ø0</div>
            </div>
        </div>

        <div class="summary-card balance">
            <div class="summary-icon">
                <i data-lucide="wallet"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="summary-amount" id="balance-amount">‡∏ø0</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn expense" id="btn-add-expense">
            <i data-lucide="minus-circle"></i>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
        </button>
        <button class="quick-action-btn income" id="btn-add-income">
            <i data-lucide="plus-circle"></i>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
        </button>
    </div>

    <!-- Quick Add Button -->
    <div class="section">
        <button class="btn-primary btn-block quick-add-btn" id="btn-quick-add">
            <i data-lucide="zap"></i>
            <span>‡∏à‡∏î‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</span>
        </button>
    </div>

    <!-- Insights Button -->
    <div class="section">
        <button class="btn-secondary btn-block" onclick="openInsightsModal()" id="btn-insights">
            <i data-lucide="sparkles"></i>
            <span>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å & ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
        </button>
    </div>

    <!-- AI Auto-Pilot Planner Button -->
    <div class="section">
        <button class="btn-ai-planner btn-block" onclick="openAIPlannerModal()" id="btn-ai-planner">
            <i data-lucide="wand-2"></i>
            <span>AI ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
            <span class="ai-badge">AI</span>
        </button>
    </div>

    <!-- AI Insights Card (Zero-Effort) -->
    <div class="section" id="ai-insights-section">
        <div class="ai-insights-card">
            <div class="ai-insights-header">
                <div class="ai-insights-title">
                    <i data-lucide="sparkles"></i>
                    <span>AI Insights</span>
                </div>
                <span class="ai-auto-badge">Auto</span>
            </div>
            <div id="ai-insights-content" class="ai-insights-content">
                <div class="ai-insights-loading">
                    <i data-lucide="loader" class="spinning"></i>
                    <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Month Comparison -->
    <div class="section" id="month-comparison-section" style="display: none;">
        <div class="comparison-card">
            <div class="comparison-header">
                <h3><i data-lucide="trending-up"></i> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ vs ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</h3>
            </div>
            <div class="comparison-grid">
                <div class="comparison-item income">
                    <span class="label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                    <div class="value-row">
                        <span class="amount" id="compare-income-amount">‡∏ø0</span>
                        <span class="change" id="compare-income-change"></span>
                    </div>
                </div>
                <div class="comparison-item expense">
                    <span class="label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                    <div class="value-row">
                        <span class="amount" id="compare-expense-amount">‡∏ø0</span>
                        <span class="change" id="compare-expense-change"></span>
                    </div>
                </div>
                <div class="comparison-item balance">
                    <span class="label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                    <div class="value-row">
                        <span class="amount" id="compare-balance-amount">‡∏ø0</span>
                        <span class="change" id="compare-balance-change"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Progress -->
    <div class="section" id="budget-progress-section" style="display: none;">
        <div class="section-header">
            <h2>
                <i data-lucide="target"></i>
                ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            </h2>
            <a href="/budgets" class="section-link">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
        </div>
        <div id="budget-progress-list" class="budget-quick-list">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Budget Alerts -->
    <div class="section" id="alerts-section" style="display: none;">
        <div id="alerts-list" class="alerts-list">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Quick Templates (1-tap transaction) -->
    <div class="section" id="quick-templates-section">
        <div class="section-header">
            <h2>
                <i data-lucide="zap"></i>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô
            </h2>
            <button class="btn-text" onclick="openCreateTemplateModal()">
                <i data-lucide="plus"></i>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
        </div>
        <div id="quick-templates-list" class="quick-templates-list">
            <!-- Populated by JavaScript -->
            <div class="quick-template-empty" id="quick-templates-empty">
                <i data-lucide="sparkles"></i>
                <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ template<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</span>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="list"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            </h2>
        </div>

        <!-- Transactions Skeleton -->
        <div class="transactions-list" id="transactions-skeleton">
            <div class="skeleton-card">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="skeleton skeleton-circle"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-text" style="width: 60%;"></div>
                        <div class="skeleton skeleton-text" style="width: 40%; height: 0.75rem;"></div>
                    </div>
                    <div class="skeleton skeleton-text" style="width: 80px; height: 1.25rem;"></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="skeleton skeleton-circle"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-text" style="width: 70%;"></div>
                        <div class="skeleton skeleton-text" style="width: 50%; height: 0.75rem;"></div>
                    </div>
                    <div class="skeleton skeleton-text" style="width: 80px; height: 1.25rem;"></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="skeleton skeleton-circle"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-text" style="width: 65%;"></div>
                        <div class="skeleton skeleton-text" style="width: 45%; height: 0.75rem;"></div>
                    </div>
                    <div class="skeleton skeleton-text" style="width: 80px; height: 1.25rem;"></div>
                </div>
            </div>
        </div>

        <!-- Transactions List (Real Data) -->
        <div class="transactions-list hidden" id="transactions-list">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Bottom spacing for footer menu -->
    <div class="footer-spacing"></div>
</div>

<!-- Modal: Add/Edit Transaction (Unified) -->
<div class="modal" id="transaction-form-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header" id="transaction-modal-header">
            <h2 id="transaction-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="transaction-form">
            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select class="form-select" id="transaction-type">
                    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                </select>
            </div>

            <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="form-select" id="transaction-category" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" id="expense-categories"></optgroup>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" id="income-categories"></optgroup>
                </select>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                    <input type="date" class="form-input" id="transaction-date" required>
                    <input type="time" class="form-input" id="transaction-time" required>
                </div>
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (with auto-complete) -->
            <div class="form-group">
                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <div class="autocomplete-wrapper">
                    <textarea class="form-textarea" id="transaction-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏á" rows="2"
                        autocomplete="off"></textarea>
                    <div id="note-suggestions" class="autocomplete-dropdown" style="display: none;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>

                <!-- Smart Amount Hint -->
                <div id="amount-hint" class="amount-hint" style="display: none;">
                    <i data-lucide="lightbulb"></i>
                    <span id="amount-hint-text"></span>
                </div>

                <!-- Quick Amount Buttons -->
                <div id="quick-amount-buttons" class="quick-amount-buttons" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>

                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="transaction-amount" placeholder="0.00"
                        step="0.01" required>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span id="transaction-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Insights & Analytics -->
<div class="modal" id="insights-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header insights">
            <h2>
                <i data-lucide="sparkles"></i>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å & ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            </h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- AI Financial Coach Section -->
            <div id="ai-coach-container" class="ai-coach-section">
                <div class="ai-coach-header">
                    <div class="ai-avatar">ü§ñ</div>
                    <div class="ai-intro">
                        <h3>AI Financial Coach</h3>
                        <span id="ai-coach-loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>
                    </div>
                </div>

                <!-- Motivational Message -->
                <div id="ai-motivational" class="ai-motivational" style="display: none;">
                    <i data-lucide="heart"></i>
                    <span id="ai-motivational-text"></span>
                </div>

                <!-- AI Insights -->
                <div id="ai-insights-list" class="ai-insights-list" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- AI Recommendations -->
                <div id="ai-recommendations-list" class="ai-recommendations-list" style="display: none;">
                    <h4><i data-lucide="lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h4>
                    <div id="ai-recommendations-content"></div>
                </div>

                <!-- AI Alerts -->
                <div id="ai-alerts-list" class="ai-alerts-list" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Spending Analysis -->
                <div id="ai-spending-analysis" class="ai-spending-analysis" style="display: none;">
                    <h4><i data-lucide="pie-chart"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h4>
                    <p id="ai-spending-text"></p>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Budget Alerts -->
            <div id="insights-alerts-container" style="display: none;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="alert-triangle"></i>
                    ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                </h3>
                <div class="insights-cards" id="insights-alerts">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Spending Trends -->
            <div id="insights-trends-container" style="display: none;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="trending-up"></i>
                    ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                </h3>
                <div id="insights-trends">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Smart Recommendations -->
            <div id="insights-recommendations-container" style="display: none;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="lightbulb"></i>
                    ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
                </h3>
                <div class="insights-cards" id="insights-recommendations">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Recurring Reminders -->
            <div id="insights-reminders-container" style="display: none;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text);">
                    <i data-lucide="bell"></i>
                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                </h3>
                <div class="insights-cards" id="insights-reminders">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Empty State -->
            <div id="insights-empty" class="empty-state" style="display: none;">
                <i data-lucide="search"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>
                <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</p>
            </div>
        </div>
    </div>
</div>

<!-- AI Planner Modal -->
<div class="modal" id="ai-planner-modal">
    <div class="modal-overlay" onclick="closeAIPlannerModal()"></div>
    <div class="modal-container modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">
                <i data-lucide="wand-2"></i>
                AI ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            </h2>
            <button class="modal-close" onclick="closeAIPlannerModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Loading State -->
            <div id="ai-planner-loading" class="ai-loading" style="display: none;">
                <div class="ai-loading-spinner"></div>
                <p>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô...</p>
            </div>

            <!-- AI Planner Content -->
            <div id="ai-planner-content" style="display: none;">
                <!-- Summary Card -->
                <div class="ai-summary-card" id="ai-plan-summary">
                    <i data-lucide="sparkles"></i>
                    <p id="ai-plan-summary-text">-</p>
                </div>

                <!-- Budget Plan -->
                <div class="ai-section">
                    <h3><i data-lucide="pie-chart"></i> ‡πÅ‡∏ú‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
                    <div id="ai-budget-list" class="ai-budget-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Recurring Expenses -->
                <div class="ai-section">
                    <h3><i data-lucide="repeat"></i> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</h3>
                    <div id="ai-recurring-list" class="ai-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Tax Estimation -->
                <div class="ai-section">
                    <h3><i data-lucide="receipt"></i> ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ</h3>
                    <div id="ai-tax-estimation" class="ai-tax-card">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Tips -->
                <div class="ai-section">
                    <h3><i data-lucide="lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</h3>
                    <div id="ai-tips-list" class="ai-tips">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="ai-planner-empty" style="display: none; text-align: center; padding: 40px;">
                <i data-lucide="database"
                    style="width: 48px; height: 48px; color: var(--text-secondary); margin-bottom: 16px;"></i>
                <p style="color: var(--text-secondary);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>
                <p style="color: var(--text-secondary); font-size: 14px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>

            <!-- Error State -->
            <div id="ai-planner-error" style="display: none; text-align: center; padding: 40px;">
                <i data-lucide="alert-circle"
                    style="width: 48px; height: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                <p id="ai-planner-error-text" style="color: #ef4444;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-ai-generate" id="btn-generate-plan" onclick="generateAIPlan()">
                <i data-lucide="wand-2"></i>
                <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡∏°‡πà</span>
            </button>
            <button class="btn-secondary" onclick="closeAIPlannerModal()">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'home' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // ===== MODAL SYSTEM =====
    const modal = document.getElementById('transaction-form-modal');
    const addExpenseBtn = document.getElementById('btn-add-expense');
    const addIncomeBtn = document.getElementById('btn-add-income');
    const quickAddBtn = document.getElementById('btn-quick-add');

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ö‡∏ö unified (type + categoryId ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
    let lastUsedTransaction = {
        type: null,
        categoryId: null
    };

    let categoriesCache = {
        expense: [],
        income: []
    };

    // Load last used transaction from localStorage
    function loadLastUsedTransaction() {
        try {
            const saved = localStorage.getItem('lastUsedTransaction');
            if (saved) {
                lastUsedTransaction = JSON.parse(saved);
            }
        } catch (e) {
            console.error('Failed to load last used transaction:', e);
        }
    }

    // Save last used transaction to localStorage
    function saveLastUsedTransaction(type, categoryId) {
        lastUsedTransaction = { type, categoryId };
        try {
            localStorage.setItem('lastUsedTransaction', JSON.stringify(lastUsedTransaction));
        } catch (e) {
            console.error('Failed to save last used transaction:', e);
        }
    }
    const closeBtn = modal.querySelector('.modal-close');
    const overlay = modal.querySelector('.modal-overlay');

    function openModal(type = null) {
        // Reset form
        document.getElementById('transaction-form').reset();

        // Set default date/time
        const now = new Date();
        document.getElementById('transaction-date').value = now.toISOString().split('T')[0];
        document.getElementById('transaction-time').value = now.toTimeString().slice(0, 5);

        // Set type if provided
        if (type) {
            document.getElementById('transaction-type').value = type;
        }

        // Update modal header color
        const modalHeader = document.getElementById('transaction-modal-header');
        const typeValue = type || document.getElementById('transaction-type').value;
        modalHeader.classList.remove('expense', 'income');
        modalHeader.classList.add(typeValue);

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Quick action buttons
    addExpenseBtn.addEventListener('click', () => openModal('expense'));
    addIncomeBtn.addEventListener('click', () => openModal('income'));

    quickAddBtn.addEventListener('click', () => {
        // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ (type + category)
        let type = lastUsedTransaction.type || 'expense';
        let categoryId = lastUsedTransaction.categoryId;

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ history ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏ä‡πâ category ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á expense
        if (!categoryId && categoriesCache.expense.length > 0) {
            type = 'expense';
            categoryId = categoriesCache.expense[0].id;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ expense category ‡πÉ‡∏ä‡πâ income category ‡πÅ‡∏ó‡∏ô
        if (!categoryId && categoriesCache.income.length > 0) {
            type = 'income';
            categoryId = categoriesCache.income[0].id;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏™‡∏î‡∏á error
        if (!categoryId) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
            return;
        }

        // Pre-fill form ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        document.getElementById('transaction-type').value = type;
        document.getElementById('transaction-category').value = categoryId;

        // Set ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const now = new Date();
        document.getElementById('transaction-date').value = now.toISOString().split('T')[0];
        document.getElementById('transaction-time').value = now.toTimeString().slice(0, 5);

        // Clear ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
        document.getElementById('transaction-amount').value = '';
        document.getElementById('transaction-note').value = '';

        // Filter categories ‡∏ï‡∏≤‡∏° type ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const expenseGroup = document.getElementById('expense-categories');
        const incomeGroup = document.getElementById('income-categories');
        if (type === 'expense') {
            if (expenseGroup) expenseGroup.style.display = '';
            if (incomeGroup) incomeGroup.style.display = 'none';
        } else {
            if (expenseGroup) expenseGroup.style.display = 'none';
            if (incomeGroup) incomeGroup.style.display = '';
        }

        // Update modal header
        const modalHeader = document.getElementById('transaction-modal-header');
        const modalTitle = document.getElementById('transaction-modal-title');

        if (modalHeader) {
            modalHeader.classList.remove('expense', 'income');
            modalHeader.classList.add(type);
        }
        if (modalTitle) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
            const selectedCategory = (type === 'expense' ? categoriesCache.expense : categoriesCache.income)
                .find(c => c.id === categoryId);
            const categoryName = selectedCategory ? selectedCategory.name_th : '';
            modalTitle.textContent = `‚ö° ‡∏à‡∏î‡πÄ‡∏£‡πá‡∏ß: ${categoryName}`;
        }

        // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡∏¢
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Delay focus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
        setTimeout(() => {
            document.getElementById('transaction-amount').focus();
        }, 100);
    });

    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    // ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // ===== SMART AMOUNT SUGGESTIONS =====
    let amountSuggestionsCache = {};

    async function loadAmountSuggestions(categoryId, type) {
        const hintEl = document.getElementById('amount-hint');
        const hintTextEl = document.getElementById('amount-hint-text');
        const quickButtonsEl = document.getElementById('quick-amount-buttons');

        // Reset
        hintEl.style.display = 'none';
        quickButtonsEl.style.display = 'none';

        if (!categoryId) return;

        // Check cache
        const cacheKey = `${categoryId}_${type}`;
        if (amountSuggestionsCache[cacheKey]) {
            displayAmountSuggestions(amountSuggestionsCache[cacheKey]);
            return;
        }

        try {
            const data = await API.get(buildApiUrl(`analytics/amount-suggestions?category_id=${categoryId}&type=${type}`));
            amountSuggestionsCache[cacheKey] = data;
            displayAmountSuggestions(data);
        } catch (error) {
            console.error('Error loading amount suggestions:', error);
        }
    }

    function displayAmountSuggestions(data) {
        const hintEl = document.getElementById('amount-hint');
        const hintTextEl = document.getElementById('amount-hint-text');
        const quickButtonsEl = document.getElementById('quick-amount-buttons');

        // Show hint if available
        if (data.category_hint) {
            hintTextEl.textContent = data.category_hint;
            hintEl.style.display = 'flex';
            lucide.createIcons();
        }

        // Show quick amount buttons
        if (data.suggestions && data.suggestions.quick_amounts_formatted) {
            const amounts = data.suggestions.quick_amounts_formatted;
            quickButtonsEl.innerHTML = amounts.map(amount => `
                <button type="button" class="quick-amount-btn" onclick="setQuickAmount(${amount})">
                    ‡∏ø${amount.toLocaleString('th-TH')}
                </button>
            `).join('');
            quickButtonsEl.style.display = 'flex';
        }
    }

    function setQuickAmount(amount) {
        document.getElementById('transaction-amount').value = amount;
        // Highlight the button
        document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // ===== AUTO-COMPLETE NOTES =====
    let noteDebounceTimer = null;
    let currentSuggestionIndex = -1;

    const noteInput = document.getElementById('transaction-note');
    const noteSuggestions = document.getElementById('note-suggestions');

    // Debounced search for notes
    noteInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();

        // Clear previous timer
        if (noteDebounceTimer) clearTimeout(noteDebounceTimer);

        // Hide suggestions if query is too short
        if (query.length < 2) {
            noteSuggestions.style.display = 'none';
            return;
        }

        // Debounce API call
        noteDebounceTimer = setTimeout(async () => {
            const categoryId = document.getElementById('transaction-category').value;
            await loadNoteSuggestions(query, categoryId);
        }, 300);
    });

    async function loadNoteSuggestions(query, categoryId) {
        try {
            let url = buildApiUrl(`notes/suggestions?q=${encodeURIComponent(query)}`);
            if (categoryId) url += `&category_id=${categoryId}`;

            const data = await API.get(url);
            displayNoteSuggestions(data.suggestions);
        } catch (error) {
            console.error('Error loading note suggestions:', error);
            noteSuggestions.style.display = 'none';
        }
    }

    function displayNoteSuggestions(suggestions) {
        if (!suggestions || suggestions.length === 0) {
            noteSuggestions.style.display = 'none';
            return;
        }

        noteSuggestions.innerHTML = suggestions.map((s, index) => `
            <div class="autocomplete-item" data-index="${index}" onclick="selectNoteSuggestion('${escapeHtml(s.note)}')">
                <span class="suggestion-text">${highlightMatch(s.note, noteInput.value)}</span>
                <span class="suggestion-count">${s.usage_count}x</span>
            </div>
        `).join('');

        noteSuggestions.style.display = 'block';
        currentSuggestionIndex = -1;
    }

    function selectNoteSuggestion(note) {
        noteInput.value = note;
        noteSuggestions.style.display = 'none';
        noteInput.focus();
    }

    function highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<strong>$1</strong>');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/'/g, "\\'");
    }

    // Keyboard navigation for suggestions
    noteInput.addEventListener('keydown', (e) => {
        const items = noteSuggestions.querySelectorAll('.autocomplete-item');
        if (items.length === 0 || noteSuggestions.style.display === 'none') return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, items.length - 1);
            updateSuggestionHighlight(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, 0);
            updateSuggestionHighlight(items);
        } else if (e.key === 'Enter' && currentSuggestionIndex >= 0) {
            e.preventDefault();
            const selectedItem = items[currentSuggestionIndex];
            if (selectedItem) {
                selectNoteSuggestion(selectedItem.querySelector('.suggestion-text').textContent);
            }
        } else if (e.key === 'Escape') {
            noteSuggestions.style.display = 'none';
        }
    });

    function updateSuggestionHighlight(items) {
        items.forEach((item, index) => {
            item.classList.toggle('highlighted', index === currentSuggestionIndex);
        });
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.autocomplete-wrapper')) {
            noteSuggestions.style.display = 'none';
        }
    });

    // Category change - load amount suggestions
    document.getElementById('transaction-category').addEventListener('change', (e) => {
        const categoryId = e.target.value;
        const type = document.getElementById('transaction-type').value;
        if (categoryId) {
            loadAmountSuggestions(categoryId, type);
        }
    });

    // Type change - update header color AND filter categories
    document.getElementById('transaction-type').addEventListener('change', (e) => {
        const type = e.target.value;
        const modalHeader = document.getElementById('transaction-modal-header');
        modalHeader.classList.remove('expense', 'income');
        modalHeader.classList.add(type);

        // Filter categories based on type
        const categorySelect = document.getElementById('transaction-category');
        const expenseGroup = document.getElementById('expense-categories');
        const incomeGroup = document.getElementById('income-categories');

        if (type === 'expense') {
            if (expenseGroup) expenseGroup.style.display = '';
            if (incomeGroup) incomeGroup.style.display = 'none';
        } else {
            if (expenseGroup) expenseGroup.style.display = 'none';
            if (incomeGroup) incomeGroup.style.display = '';
        }

        // Reset category selection and hide suggestions
        if (categorySelect) categorySelect.value = '';
        document.getElementById('amount-hint').style.display = 'none';
        document.getElementById('quick-amount-buttons').style.display = 'none';
    });

    // Load last used categories on page ready
    document.addEventListener('DOMContentLoaded', loadLastUsedTransaction);

    // ===== SET DEFAULT DATE/TIME =====
    function setDefaultDateTime(type) {
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);

        document.getElementById(`${type}-date`).value = date;
        document.getElementById(`${type}-time`).value = time;
    }

    // ===== FORM SUBMISSION =====
    document.getElementById('transaction-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');

        // Get form values
        const type = document.getElementById('transaction-type').value;
        const categoryId = document.getElementById('transaction-category').value;
        const amount = parseFloat(document.getElementById('transaction-amount').value);

        // Validation
        if (!categoryId) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
            return;
        }
        if (!amount || amount <= 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
        }

        // Prepare data
        const date = document.getElementById('transaction-date').value;
        const time = document.getElementById('transaction-time').value;
        const occurred_at = `${date}T${time}:00`;

        const payload = {
            type: type,
            category_id: categoryId,
            amount: amount, // Backend will convert to satang
            occurred_at: occurred_at,
            note: document.getElementById('transaction-note').value || null
        };

        // Use LoadingManager for automatic loading state management
        await LoadingManager.withLoading(
            async () => {
                let result;
                if (editingTransactionId) {
                    // Update existing transaction
                    result = await API.put(buildApiUrl('transactions', editingTransactionId), payload);
                    showToast(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó${type === 'expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                } else {
                    // Create new transaction
                    result = await API.post(buildApiUrl('transactions'), payload);
                    showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${type === 'expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                }

                // Save last used category for smart quick add
                saveLastUsedTransaction(type, categoryId);

                // Reset form and state
                document.getElementById('transaction-form').reset();
                editingTransactionId = null;

                // Reset modal title and button
                const modalTitle = document.getElementById('transaction-modal-title');
                const submitBtnText = document.getElementById('transaction-submit-text');
                if (modalTitle) modalTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                if (submitBtnText) submitBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

                closeModal();

                // Reload dashboard
                await loadDashboard(true);
            },
            {
                button: submitBtn,  // Automatic button loading state
                topBar: true        // Show top loading bar
            }
        );
    });

    // ===== LOAD CATEGORIES =====
    async function loadCategories() {
        try {
            const result = await API.get(buildApiUrl('categories'));

            if (result.categories && result.categories.length > 0) {
                const categories = result.categories;

                // Separate by type
                const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
                const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

                // Cache categories for quick add
                categoriesCache.expense = expenseCategories;
                categoriesCache.income = incomeCategories;

                // Helper to get icon display (emoji stays as is, Lucide shows as text for dropdown)
                const getIconDisplay = (icon) => {
                    // Check if it's emoji
                    const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(icon || '');
                    return isEmoji ? icon : 'üìÅ'; // Use folder emoji as fallback for Lucide icons in dropdown
                };

                const expenseGroup = document.getElementById('expense-categories');
                const incomeGroup = document.getElementById('income-categories');

                if (expenseGroup) {
                    expenseGroup.innerHTML = expenseCategories.map(cat =>
                        `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                    ).join('');
                }

                if (incomeGroup) {
                    incomeGroup.innerHTML = incomeCategories.map(cat =>
                        `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                    ).join('');
                }
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // ===== RESET SKELETONS (Show skeletons before reload) =====
    function resetSkeletons() {
        // Reset summary cards
        const summaryCards = document.getElementById('summary-cards');
        const summarySkeleton = document.getElementById('summary-skeleton');
        if (summaryCards && summarySkeleton) {
            summaryCards.classList.add('hidden');
            summaryCards.classList.remove('fade-in');
            summarySkeleton.classList.remove('hidden');
        }

        // Reset transactions
        const transactionsList = document.getElementById('transactions-list');
        const transactionsSkeleton = document.getElementById('transactions-skeleton');
        if (transactionsList && transactionsSkeleton) {
            transactionsList.classList.add('hidden');
            transactionsList.classList.remove('fade-in');
            transactionsSkeleton.classList.remove('hidden');
        }

        // Reset widgets (hide them for clean reload)
        const widgetSections = [
            'month-comparison-section',
            'budget-progress-section',
            'alerts-section'
        ];
        widgetSections.forEach(id => {
            const section = document.getElementById(id);
            if (section) {
                section.style.display = 'none';
                section.classList.remove('fade-in');
            }
        });
    }

    // ===== DASHBOARD DATA =====
    async function loadDashboard(showSkeleton = false) {
        try {
            // Show skeletons if this is a reload
            if (showSkeleton) {
                resetSkeletons();
            }

            // Load summary, widgets, and transactions in parallel
            const [summaryPromise, widgetsPromise, transactionsPromise] = await Promise.allSettled([
                loadMonthlySummary(),
                loadDashboardWidgets(),
                API.get(buildApiUrl('transactions') + '?per_page=10&page=1')
            ]);

            // Handle transactions
            if (transactionsPromise.status === 'fulfilled') {
                const result = transactionsPromise.value;
                if (result.transactions && result.transactions.length > 0) {
                    renderTransactions(result.transactions);
                } else {
                    // Hide skeleton
                    const skeleton = document.getElementById('transactions-skeleton');
                    if (skeleton) {
                        skeleton.classList.add('hidden');
                    }

                    // Show empty state
                    const transactionsList = document.getElementById('transactions-list');
                    transactionsList.classList.remove('hidden');
                    transactionsList.classList.add('fade-in');
                    transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="inbox"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>
                `;
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            } else {
                // Handle transaction fetch error
                const skeleton = document.getElementById('transactions-skeleton');
                const transactionsList = document.getElementById('transactions-list');
                if (skeleton) skeleton.classList.add('hidden');
                if (transactionsList) {
                    transactionsList.classList.remove('hidden');
                    transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="alert-circle"></i>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                        <p class="empty-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    </div>
                `;
                    lucide.createIcons();
                }
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        }
    }

    // ===== LOAD MONTHLY SUMMARY =====
    async function loadMonthlySummary() {
        try {
            // Get current month in YYYY-MM format
            const now = new Date();
            const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const result = await API.get(buildApiUrl(`analytics/summary?month=${month}`));

            if (result.summary) {
                updateSummaryCards(result.summary);
            }
        } catch (error) {
            console.error('Error loading summary:', error);
            // Silently fail - cards will show ‡∏ø0
        }
    }

    // ===== UPDATE SUMMARY CARDS =====
    function updateSummaryCards(summary) {
        // Format number with Thai locale
        const formatMoney = (amount) => {
            return amount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // Update Income
        const incomeEl = document.getElementById('income-summary');
        if (incomeEl && summary.income) {
            incomeEl.textContent = `‡∏ø${formatMoney(summary.income.formatted)}`;
        }

        // Update Expense
        const expenseEl = document.getElementById('expense-summary');
        if (expenseEl && summary.expense) {
            expenseEl.textContent = `‡∏ø${formatMoney(summary.expense.formatted)}`;
        }

        // Update Balance
        const balanceEl = document.getElementById('balance-amount');
        if (balanceEl && summary.balance) {
            balanceEl.textContent = `‡∏ø${formatMoney(summary.balance.formatted)}`;
            // Update color based on positive/negative
            const isPositive = summary.balance.total >= 0;
            balanceEl.style.color = isPositive ? 'var(--success, #10b981)' : 'var(--error, #ef4444)';
        }

        // Hide skeleton, show real cards with fade-in
        const skeleton = document.getElementById('summary-skeleton');
        const cards = document.getElementById('summary-cards');
        if (skeleton && cards) {
            skeleton.classList.add('hidden');
            cards.classList.remove('hidden');
            cards.classList.add('fade-in');
        }

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        console.log('Summary loaded:', summary);
    }

    // ===== GLOBAL ICON HELPER =====
    // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Lucide icon ‡∏´‡∏£‡∏∑‡∏≠ Emoji ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    function renderIcon(iconName, customClass = '') {
        const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName || '');
        if (isEmoji || !iconName) {
            return `<span class="icon-emoji ${customClass}">${iconName || 'üìÅ'}</span>`;
        } else {
            return `<i data-lucide="${iconName}" class="${customClass}"></i>`;
        }
    }

    // ===== RENDER TRANSACTIONS =====
    function renderTransactions(transactions) {
        const transactionsList = document.getElementById('transactions-list');

        const formatDate = (dateStr) => {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô';
            } else {
                return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
            }
        };

        const formatAmount = (amount) => {
            return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // ‡πÉ‡∏ä‡πâ global renderIcon function ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

        // Hide skeleton first
        const skeleton = document.getElementById('transactions-skeleton');
        if (skeleton) {
            skeleton.classList.add('hidden');
        }

        // Show transactions list
        transactionsList.classList.remove('hidden');
        transactionsList.classList.add('fade-in');

        transactionsList.innerHTML = transactions.map(tx => `
        <div class="transaction-item ${tx.type}" 
             data-transaction-id="${tx.id}"
             data-transaction='${JSON.stringify(tx).replace(/'/g, "&apos;")}'>
            <div class="transaction-icon ${tx.type}">
                ${renderIcon(tx.category?.icon)}
            </div>
            <div class="transaction-info">
                <div class="transaction-title">${tx.category?.name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div class="transaction-meta">
                    <span class="transaction-date">${formatDate(tx.occurred_at)}</span>
                    ${tx.note ? `<span class="transaction-note">${tx.note}</span>` : ''}
                </div>
            </div>
            <div class="transaction-amount ${tx.type}">
                ${tx.type === 'expense' ? '-' : '+'}‡∏ø${formatAmount(tx.amount)}
            </div>
            <div class="transaction-actions">
                <button class="btn-icon btn-edit" onclick="editTransaction('${tx.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                    <i data-lucide="edit-2"></i>
                </button>
                <button class="btn-icon btn-delete" onclick="deleteTransaction('${tx.id}')" title="‡∏•‡∏ö">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        </div>
    `).join('');

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // ===== EDIT TRANSACTION =====
    let editingTransactionId = null;

    function editTransaction(transactionId) {
        try {
            // Get transaction data from DOM (no API call needed!)
            const txElement = document.querySelector(`[data-transaction-id="${transactionId}"]`);
            if (!txElement) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
                return;
            }

            const tx = JSON.parse(txElement.dataset.transaction);
            editingTransactionId = transactionId;

            // Open modal first (this will reset the form)
            openModal();

            // Then pre-fill form with transaction data
            document.getElementById('transaction-type').value = tx.type;

            // Filter categories based on type BEFORE setting category value
            const expenseGroup = document.getElementById('expense-categories');
            const incomeGroup = document.getElementById('income-categories');

            if (tx.type === 'expense') {
                if (expenseGroup) expenseGroup.style.display = '';
                if (incomeGroup) incomeGroup.style.display = 'none';
            } else {
                if (expenseGroup) expenseGroup.style.display = 'none';
                if (incomeGroup) incomeGroup.style.display = '';
            }

            // Now set category value (after filtering)
            document.getElementById('transaction-category').value = tx.category_id;

            // Parse date properly
            const occuredDate = new Date(tx.occurred_at);
            const dateStr = occuredDate.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeStr = occuredDate.toTimeString().substr(0, 5); // HH:MM

            document.getElementById('transaction-date').value = dateStr;
            document.getElementById('transaction-time').value = timeStr;
            document.getElementById('transaction-note').value = tx.note || '';
            document.getElementById('transaction-amount').value = (tx.amount / 100).toFixed(2);

            // Update modal header
            const modalHeader = document.getElementById('transaction-modal-header');
            const modalTitle = document.getElementById('transaction-modal-title');
            const submitBtnText = document.getElementById('transaction-submit-text');

            if (modalHeader) {
                modalHeader.classList.remove('expense', 'income');
                modalHeader.classList.add(tx.type);
            }
            if (modalTitle) {
                modalTitle.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç${tx.type === 'expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'}`;
            }
            if (submitBtnText) {
                submitBtnText.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';
            }
        } catch (error) {
            console.error('Edit transaction error:', error);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    }

    // ===== DELETE TRANSACTION =====
    async function deleteTransaction(transactionId) {
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }

        // Use LoadingManager with top loading bar
        await LoadingManager.withLoading(
            async () => {
                await API.delete(buildApiUrl('transactions', transactionId));
                showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');

                // Reload dashboard
                await loadDashboard(true);
            },
            {
                topBar: true  // Show top loading bar during deletion
            }
        );
    }

    // ===== DEEP LINKING SUPPORT =====
    function handleDeepLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const modalType = urlParams.get('openModal');

        if (modalType === 'expense') {
            setTimeout(() => openModal(modals.expenseCategory), 100);
        } else if (modalType === 'income') {
            setTimeout(() => openModal(modals.incomeCategory), 100);
        }
    }

    // ===== LOAD DASHBOARD WIDGETS =====
    async function loadDashboardWidgets() {
        try {
            const result = await API.get(buildApiUrl('dashboard/widgets'));

            if (result) {
                // Render widgets
                renderMonthComparison(result.comparison, result.summary);
                renderBudgetProgress(result.top_budgets);
                renderBudgetAlerts(result.alerts);

                console.log('Dashboard widgets loaded:', result);
            }
        } catch (error) {
            console.error('Error loading widgets:', error);
            // Silently fail - widgets are optional
        }
    }

    // ===== RENDER MONTH COMPARISON =====
    function renderMonthComparison(comparison, summary) {
        if (!comparison) return;

        const section = document.getElementById('month-comparison-section');
        if (!section) return;

        const formatMoney = (amount) => {
            return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };

        const formatChange = (change) => {
            if (change.direction === 'same') return '';

            const arrow = change.direction === 'up' ? '‚Üë' : '‚Üì';
            const className = change.direction === 'up' ? 'up' : 'down';
            return `<span class="change-badge ${className}">${arrow} ${change.percentage}%</span>`;
        };

        // Update income
        document.getElementById('compare-income-amount').textContent = `‡∏ø${formatMoney(summary.income.total)}`;
        document.getElementById('compare-income-change').innerHTML = formatChange(comparison.income);

        // Update expense
        document.getElementById('compare-expense-amount').textContent = `‡∏ø${formatMoney(summary.expense.total)}`;
        document.getElementById('compare-expense-change').innerHTML = formatChange(comparison.expense);

        // Update balance
        document.getElementById('compare-balance-amount').textContent = `‡∏ø${formatMoney(summary.balance.total)}`;
        document.getElementById('compare-balance-change').innerHTML = formatChange(comparison.balance);

        // Show section with fade-in
        section.style.display = 'block';
        section.classList.add('fade-in');

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // ===== RENDER BUDGET PROGRESS =====
    function renderBudgetProgress(budgets) {
        if (!budgets || budgets.length === 0) return;

        const section = document.getElementById('budget-progress-section');
        const container = document.getElementById('budget-progress-list');

        if (!section || !container) return;

        container.innerHTML = budgets.map(budget => {
            const cat = budget.category || {};
            const usage = budget.usage_percentage || 0;
            const statusClass = budget.is_over_budget ? 'over' : (budget.is_near_limit ? 'warning' : 'normal');

            return `
            <div class="budget-quick-card ${statusClass}">
                <div class="budget-quick-header">
                    <span class="budget-icon" style="color: ${cat.color || '#666'}">
                        ${renderIcon(cat.icon)}
                    </span>
                    <span class="budget-name">${cat.name_th || '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'}</span>
                </div>
                <div class="budget-quick-progress">
                    <div class="progress-bar">
                        <div class="progress-fill ${statusClass}" style="width: ${Math.min(usage, 100)}%"></div>
                    </div>
                    <div class="progress-stats">
                        <span>${usage}%</span>
                        <span>‡∏ø${(budget.spent_formatted || 0).toLocaleString('th-TH')} / ‡∏ø${(budget.limit_amount_formatted || 0).toLocaleString('th-TH')}</span>
                    </div>
                </div>
            </div>
        `;
        }).join('');

        lucide.createIcons();
        section.style.display = 'block';
        section.classList.add('fade-in');
    }

    // ===== RENDER BUDGET ALERTS =====
    function renderBudgetAlerts(alerts) {
        if (!alerts || alerts.length === 0) return;

        const section = document.getElementById('alerts-section');
        const container = document.getElementById('alerts-list');

        if (!section || !container) return;

        container.innerHTML = alerts.map(alert => `
        <div class="alert alert-${alert.type}">
            <span class="alert-icon">${renderIcon(alert.icon)}</span>
            <div class="alert-content">
                <strong>${alert.category}</strong>
                <span>${alert.message}</span>
            </div>
        </div>
    `).join('');

        // Initialize Lucide icons ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô SVG
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        section.style.display = 'block';
        section.classList.add('fade-in');
    }

    // ===== AI AUTO-PILOT PLANNER =====
    const aiPlannerModal = document.getElementById('ai-planner-modal');

    function openAIPlannerModal() {
        aiPlannerModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        generateAIPlan();
        lucide.createIcons();
    }

    function closeAIPlannerModal() {
        aiPlannerModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    async function generateAIPlan() {
        const loadingEl = document.getElementById('ai-planner-loading');
        const contentEl = document.getElementById('ai-planner-content');
        const emptyEl = document.getElementById('ai-planner-empty');
        const errorEl = document.getElementById('ai-planner-error');
        const genBtn = document.getElementById('btn-generate-plan');

        // Reset states
        loadingEl.style.display = 'flex';
        contentEl.style.display = 'none';
        emptyEl.style.display = 'none';
        errorEl.style.display = 'none';
        genBtn.disabled = true;
        lucide.createIcons();

        try {
            // Generate monthly plan
            const planResponse = await fetch('/api/v1/ai/generate-monthly-plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const planData = await planResponse.json();

            // Get recurring expenses
            const recurringResponse = await fetch('/api/v1/ai/recurring-expenses');
            const recurringData = await recurringResponse.json();

            // Get tax estimation
            const taxResponse = await fetch('/api/v1/ai/tax-estimation');
            const taxData = await taxResponse.json();

            loadingEl.style.display = 'none';

            if (!planData.success && !recurringData.success) {
                emptyEl.style.display = 'block';
                genBtn.disabled = false;
                lucide.createIcons();
                return;
            }

            // Show content
            contentEl.style.display = 'block';

            // --- Populate Summary ---
            const plan = planData.plan || {};
            document.getElementById('ai-plan-summary-text').textContent =
                plan.summary || 'AI ‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß';

            // --- Populate Budget List ---
            const budgetList = document.getElementById('ai-budget-list');
            const budgets = plan.monthly_plan?.budgets || [];
            if (budgets.length > 0) {
                budgetList.innerHTML = budgets.map(b => `
                    <div class="ai-budget-item">
                        <div class="ai-budget-name">${b.category}</div>
                        <div class="ai-budget-amount">‡∏ø${Number(b.amount).toLocaleString()}</div>
                        <div class="ai-budget-reason">${b.reason || ''}</div>
                    </div>
                `).join('');
            } else {
                budgetList.innerHTML = '<p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>';
            }

            // --- Populate Recurring ---
            const recurringList = document.getElementById('ai-recurring-list');
            const recurring = recurringData.recurring || plan.recurring_detected || [];
            if (recurring.length > 0) {
                recurringList.innerHTML = recurring.map(r => `
                    <div class="ai-list-item">
                        <i data-lucide="repeat"></i>
                        <div class="ai-list-content">
                            <div class="ai-list-title">${r.name}</div>
                            <div class="ai-list-meta">‡∏ø${Number(r.amount).toLocaleString()} / ${r.frequency || 'monthly'}</div>
                        </div>
                        <div class="ai-confidence">${Math.round((r.confidence || 0.8) * 100)}%</div>
                    </div>
                `).join('');
            } else {
                recurringList.innerHTML = '<p class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>';
            }

            // --- Populate Tax ---
            const taxCard = document.getElementById('ai-tax-estimation');
            const tax = taxData.tax || {};
            if (tax.estimated_tax !== undefined) {
                taxCard.innerHTML = `
                    <div class="ai-tax-grid">
                        <div class="ai-tax-item">
                            <span class="ai-tax-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</span>
                            <span class="ai-tax-value">‡∏ø${Number(tax.annual_income || 0).toLocaleString()}</span>
                        </div>
                        <div class="ai-tax-item">
                            <span class="ai-tax-label">‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô</span>
                            <span class="ai-tax-value">‡∏ø${Number(tax.total_deductions || 0).toLocaleString()}</span>
                        </div>
                        <div class="ai-tax-item highlight">
                            <span class="ai-tax-label">‡∏†‡∏≤‡∏©‡∏µ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                            <span class="ai-tax-value">‡∏ø${Number(tax.estimated_tax || 0).toLocaleString()}</span>
                        </div>
                        <div class="ai-tax-item">
                            <span class="ai-tax-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                            <span class="ai-tax-value">‡∏ø${Number(tax.monthly_tax_reserve || 0).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                taxCard.innerHTML = '<p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>';
            }

            // --- Populate Tips ---
            const tipsList = document.getElementById('ai-tips-list');
            const allTips = [...(plan.tips || []), ...(plan.alerts || []), ...(tax.tips || [])];
            if (allTips.length > 0) {
                tipsList.innerHTML = allTips.slice(0, 5).map(t => `
                    <div class="ai-tip-item">
                        <i data-lucide="lightbulb"></i>
                        <span>${t}</span>
                    </div>
                `).join('');
            } else {
                tipsList.innerHTML = '<p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>';
            }

            lucide.createIcons();

        } catch (error) {
            console.error('AI Planner error:', error);
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            document.getElementById('ai-planner-error-text').textContent =
                '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || 'Unknown error');
            lucide.createIcons();
        } finally {
            genBtn.disabled = false;
        }
    }

    // ===== SMART INSIGHTS =====
    const insightsModal = document.getElementById('insights-modal');
    const insightsCloseBtn = insightsModal.querySelector('.modal-close');
    const insightsOverlay = insightsModal.querySelector('.modal-overlay');

    function openInsightsModal() {
        insightsModal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Show loading state
        const containers = ['insights-alerts-container', 'insights-trends-container',
            'insights-recommendations-container', 'insights-reminders-container'];
        containers.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        // Show loading indicator
        const emptyState = document.getElementById('insights-empty');
        if (emptyState) {
            emptyState.style.display = 'block';
            emptyState.innerHTML = `
            <i data-lucide="loader" class="spinning"></i>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            <p class="empty-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Load both insights and AI Coach
        loadInsightsData();
        loadAICoachData();
    }

    // ===== AI FINANCIAL COACH =====
    async function loadAICoachData() {
        const loadingEl = document.getElementById('ai-coach-loading');
        const motivationalEl = document.getElementById('ai-motivational');
        const insightsListEl = document.getElementById('ai-insights-list');
        const recommendationsListEl = document.getElementById('ai-recommendations-list');
        const alertsListEl = document.getElementById('ai-alerts-list');
        const spendingAnalysisEl = document.getElementById('ai-spending-analysis');

        try {
            loadingEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';

            const data = await API.get(buildApiUrl('ai/financial-coach'));
            const coach = data.coach;

            loadingEl.style.display = 'none';

            // Motivational message
            if (coach.motivational_message) {
                document.getElementById('ai-motivational-text').textContent = coach.motivational_message;
                motivationalEl.style.display = 'flex';
            }

            // Insights
            if (coach.insights && coach.insights.length > 0) {
                insightsListEl.innerHTML = coach.insights.map(i => `
                    <div class="ai-insight-item">
                        <i data-lucide="info"></i>
                        <span>${i}</span>
                    </div>
                `).join('');
                insightsListEl.style.display = 'block';
            }

            // Recommendations
            if (coach.recommendations && coach.recommendations.length > 0) {
                document.getElementById('ai-recommendations-content').innerHTML = coach.recommendations.map(r => `
                    <div class="ai-recommendation-item">
                        <i data-lucide="check-circle"></i>
                        <span>${r}</span>
                    </div>
                `).join('');
                recommendationsListEl.style.display = 'block';
            }

            // Alerts
            if (coach.alerts && coach.alerts.length > 0) {
                alertsListEl.innerHTML = coach.alerts.map(a => `
                    <div class="ai-alert-item">
                        <i data-lucide="alert-triangle"></i>
                        <span>${a}</span>
                    </div>
                `).join('');
                alertsListEl.style.display = 'block';
            }

            // Spending analysis
            if (coach.spending_analysis) {
                document.getElementById('ai-spending-text').textContent = coach.spending_analysis;
                spendingAnalysisEl.style.display = 'block';
            }

            lucide.createIcons();

        } catch (error) {
            console.error('Error loading AI Coach:', error);
            loadingEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI ‡πÑ‡∏î‡πâ';
        }
    }


    function closeInsightsModal() {
        insightsModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    insightsCloseBtn.addEventListener('click', closeInsightsModal);
    insightsOverlay.addEventListener('click', closeInsightsModal);

    async function loadInsightsData() {
        try {
            const result = await API.get(buildApiUrl('insights/all'));

            // Show/hide sections based on data
            const hasAlerts = result.alerts && result.alerts.length > 0;
            const hasTrends = result.trends && Object.keys(result.trends).length > 0;
            const hasRecommendations = result.recommendations && result.recommendations.length > 0;
            const hasReminders = result.reminders && result.reminders.length > 0;

            const hasAnyInsights = hasAlerts || hasTrends || hasRecommendations || hasReminders;

            // Show/hide containers
            document.getElementById('insights-alerts-container').style.display = hasAlerts ? 'block' : 'none';
            document.getElementById('insights-trends-container').style.display = hasTrends ? 'block' : 'none';
            document.getElementById('insights-recommendations-container').style.display = hasRecommendations ? 'block' : 'none';
            document.getElementById('insights-reminders-container').style.display = hasReminders ? 'block' : 'none';
            document.getElementById('insights-empty').style.display = hasAnyInsights ? 'none' : 'block';

            if (hasAlerts) renderInsightsAlerts(result.alerts);
            if (hasTrends) renderSpendingTrends(result.trends);
            if (hasRecommendations) renderRecommendations(result.recommendations);
            if (hasReminders) renderRecurringReminders(result.reminders);

        } catch (error) {
            console.error('Error loading insights:', error);
            // Show empty state on error
            document.getElementById('insights-alerts-container').style.display = 'none';
            document.getElementById('insights-trends-container').style.display = 'none';
            document.getElementById('insights-recommendations-container').style.display = 'none';
            document.getElementById('insights-reminders-container').style.display = 'none';
            document.getElementById('insights-empty').style.display = 'block';
        }
    }

    function renderInsightsAlerts(alerts) {
        const container = document.getElementById('insights-alerts');

        container.innerHTML = alerts.map(alert => `
        <div class="alert-card alert-${alert.type} fade-in">
            <div class="alert-icon-wrapper">
                ${alert.icon}
            </div>
            <div class="alert-content">
                <div class="alert-title">${alert.title}</div>
                <div class="alert-category">${alert.category_icon} ${alert.category}</div>
                <div class="alert-message">${alert.message}</div>
            </div>
        </div>
    `).join('');

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function renderSpendingTrends(trends) {
        const container = document.getElementById('insights-trends');
        const containerWrapper = document.getElementById('insights-trends-container');

        const change = trends.change;
        let trendIcon, trendIconName;
        if (change.direction === 'up') {
            trendIconName = 'trending-up';
        } else if (change.direction === 'down') {
            trendIconName = 'trending-down';
        } else {
            trendIconName = 'minus';
        }
        const trendClass = change.direction === 'up' ? 'trend-up' : change.direction === 'down' ? 'trend-down' : 'trend-same';

        container.innerHTML = `
        <div class="insight-card fade-in">
            <div class="insight-header">
                <div class="insight-title">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
                <div class="insight-badge ${trendClass}">
                    <i data-lucide="${trendIconName}"></i>
                    <span>${Math.abs(change.percentage).toFixed(0)}%</span>
                </div>
            </div>
            <div class="insight-stats">
                <div class="insight-stat">
                    <div class="insight-stat-label">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</div>
                    <div class="insight-stat-value">‡∏ø${(trends.current_week.total / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 })}</div>
                </div>
                <div class="insight-stat">
                    <div class="insight-stat-label">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô</div>
                    <div class="insight-stat-value">‡∏ø${(trends.previous_week.total / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 })}</div>
                </div>
            </div>
            ${trends.top_categories && trends.top_categories.length > 0 ? `
                <div class="insight-categories">
                    <div class="insight-subtitle">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
                    ${trends.top_categories.map(cat => `
                        <div class="insight-category-item">
                            <div class="insight-category-name">
                                <span>${cat.icon}</span>
                                <span>${cat.category}</span>
                            </div>
                            <div class="insight-category-change ${cat.change_percentage > 0 ? 'positive' : 'negative'}">
                                <i data-lucide="${cat.change_percentage > 0 ? 'arrow-up' : 'arrow-down'}"></i>
                                ${Math.abs(cat.change_percentage).toFixed(0)}%
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;

        containerWrapper.style.display = 'block';

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function renderRecommendations(recommendations) {
        const container = document.getElementById('insights-recommendations');
        const containerWrapper = document.getElementById('insights-recommendations-container');

        container.innerHTML = recommendations.slice(0, 3).map(rec => `
        <div class="insight-card fade-in">
            <div class="insight-header">
                <div class="insight-icon">${rec.icon}</div>
                <div class="insight-content">
                    <div class="insight-title">${rec.title}</div>
                    <div class="insight-message">${rec.message}</div>
                    <div class="insight-action">
                        <i data-lucide="lightbulb"></i>
                        <span>${rec.action}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

        containerWrapper.style.display = 'block';

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function renderRecurringReminders(reminders) {
        const container = document.getElementById('insights-reminders');
        const containerWrapper = document.getElementById('insights-reminders-container');

        container.innerHTML = reminders.map(reminder => `
        <div class="insight-card fade-in">
            <div class="insight-icon ${reminder.type}">
                ${reminder.icon}
            </div>
            <div class="insight-info">
                <div class="insight-category">${reminder.category}</div>
                <div class="insight-date">
                    <i data-lucide="calendar"></i>
                    ${reminder.next_run_date}
                    <span class="insight-days-badge">${reminder.days_until} ‡∏ß‡∏±‡∏ô</span>
                </div>
            </div>
            <div class="insight-amount ${reminder.type}">
                ${reminder.type === 'expense' ? '-' : '+'}‡∏ø${(reminder.amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 })}
            </div>
        </div>
    `).join('');

        containerWrapper.style.display = 'block';

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // ===== QUICK TEMPLATES =====
    async function loadQuickTemplates() {
        try {
            const data = await API.get(buildApiUrl('quick-templates?include_suggestions=true'));
            displayQuickTemplates(data);
        } catch (error) {
            console.error('Error loading quick templates:', error);
        }
    }

    function displayQuickTemplates(data) {
        const container = document.getElementById('quick-templates-list');
        const emptyEl = document.getElementById('quick-templates-empty');

        const templates = data.templates || [];
        const suggestions = data.suggestions || [];

        // Combine templates and suggestions (max 6)
        const allItems = [...templates, ...suggestions.map(s => ({ ...s, isSuggestion: true }))].slice(0, 6);

        if (allItems.length === 0) {
            emptyEl.style.display = 'flex';
            return;
        }

        emptyEl.style.display = 'none';

        // Render template buttons
        container.innerHTML = allItems.map(t => `
            <button class="quick-template-btn ${t.isSuggestion ? 'suggestion' : ''}" 
                    onclick="${t.isSuggestion ? `saveSuggestedTemplate('${escapeHtml(JSON.stringify(t))}')` : `useQuickTemplate('${t.id}')`}"
                    title="${t.note || t.name}">
                <span class="template-icon">${t.icon || 'üìù'}</span>
                <span class="template-name">${t.name}</span>
                <span class="template-amount">‡∏ø${(t.amount_formatted || t.amount / 100).toLocaleString('th-TH')}</span>
                ${t.isSuggestion ? '<span class="suggestion-badge">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : ''}
            </button>
        `).join('') + `<div class="quick-template-empty" id="quick-templates-empty" style="display: none;">
                <i data-lucide="sparkles"></i>
                <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ template<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</span>
            </div>`;

        lucide.createIcons();
    }

    async function useQuickTemplate(templateId) {
        try {
            const data = await API.post(buildApiUrl(`quick-templates/${templateId}/use`), {});
            showToast('success', data.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            await loadDashboard(); // Refresh dashboard
        } catch (error) {
            console.error('Error using template:', error);
            showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    async function saveSuggestedTemplate(jsonStr) {
        try {
            const suggestion = JSON.parse(jsonStr);

            // Create template from suggestion
            const template = await API.post(buildApiUrl('quick-templates'), {
                name: suggestion.name,
                icon: suggestion.icon,
                category_id: suggestion.category_id,
                amount: suggestion.amount / 100,
                note: suggestion.note,
                type: suggestion.type,
                is_auto_generated: true
            });

            // Then use it
            await useQuickTemplate(template.template.id);

        } catch (error) {
            console.error('Error saving suggested template:', error);
            showToast('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    function openCreateTemplateModal() {
        // For now, redirect to modal or alert
        showToast('info', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á');
    }

    function showToast(type, message) {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }

    // Load on page ready
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCategories(); // Load categories first
        await loadDashboard(); // First load - no skeleton reset needed
        await loadQuickTemplates(); // Load quick templates
        loadAIInsights(); // Load AI insights (async, no await)
        handleDeepLink();
    });

    // ===== AUTO AI INSIGHTS =====
    async function loadAIInsights() {
        const contentEl = document.getElementById('ai-insights-content');

        try {
            const response = await fetch('/api/v1/ai/auto-insights');
            const data = await response.json();

            if (!data.success || !data.insights) {
                contentEl.innerHTML = '<p class="ai-insights-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>';
                lucide.createIcons();
                return;
            }

            const insights = data.insights;
            let html = '';

            // Cards
            if (insights.cards && insights.cards.length > 0) {
                html += '<div class="ai-insights-grid">';
                insights.cards.forEach(card => {
                    const statusClass = card.status === 'warning' ? 'warning' :
                        card.status === 'success' ? 'success' : '';
                    html += `
                        <div class="ai-insight-mini-card ${statusClass}">
                            <i data-lucide="${card.icon || 'info'}"></i>
                            <div class="ai-insight-mini-content">
                                <div class="ai-insight-mini-title">${card.title}</div>
                                <div class="ai-insight-mini-value">${card.value}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Alerts
            if (insights.alerts && insights.alerts.length > 0) {
                insights.alerts.forEach(alert => {
                    const alertClass = alert.severity === 'alert' ? 'danger' : 'warning';
                    html += `
                        <div class="ai-insight-alert ${alertClass}">
                            <i data-lucide="alert-circle"></i>
                            <span>${alert.message}</span>
                        </div>
                    `;
                });
            }

            // Tips
            if (insights.tips && insights.tips.length > 0) {
                html += '<div class="ai-insight-tips">';
                insights.tips.forEach(tip => {
                    html += `<div class="ai-insight-tip"><i data-lucide="lightbulb"></i><span>${tip}</span></div>`;
                });
                html += '</div>';
            }

            if (!html) {
                html = '<p class="ai-insights-empty">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π insights</p>';
            }

            contentEl.innerHTML = html;
            lucide.createIcons();

        } catch (error) {
            console.error('Load AI Insights error:', error);
            contentEl.innerHTML = '<p class="ai-insights-empty">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î insights</p>';
        }
    }
</script>
{% endblock %}