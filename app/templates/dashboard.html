{% extends "base.html" %}

{% block title %}‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="sparkles"></i>
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ{% if user %}, {{ user.display_name }}{% endif %}!
            </h1>
            <p class="subtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-section">
        <div class="summary-card income">
            <div class="summary-icon">
                <i data-lucide="trending-up"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="summary-amount" id="income-amount">‡∏ø0</div>
            </div>
        </div>

        <div class="summary-card expense">
            <div class="summary-icon">
                <i data-lucide="trending-down"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="summary-amount" id="expense-amount">‡∏ø0</div>
            </div>
        </div>

        <div class="summary-card balance">
            <div class="summary-icon">
                <i data-lucide="wallet"></i>
            </div>
            <div class="summary-content">
                <div class="summary-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="summary-amount" id="balance-amount">‡∏ø0</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn expense" id="btn-add-expense">
            <i data-lucide="minus-circle"></i>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
        </button>
        <button class="quick-action-btn income" id="btn-add-income">
            <i data-lucide="plus-circle"></i>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
        </button>
    </div>

    <!-- Recent Transactions -->
    <div class="section">
        <div class="section-header">
            <h2>
                <i data-lucide="list"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            </h2>
        </div>

        <div class="transactions-list" id="transactions-list">
            <div class="empty-state">
                <i data-lucide="inbox"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>
        </div>
    </div>

    <!-- Bottom spacing for footer menu -->
    <div class="footer-spacing"></div>
</div>

<!-- Modal: Expense Category Selector (Bottom Sheet) -->
<div class="modal bottom-sheet" id="expense-category-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
        </div>
        <div class="bottom-sheet-body">
            <div class="category-grid">
                <div class="category-grid-item" data-category="food">
                    <div class="category-grid-icon">üçî</div>
                    <div class="category-grid-label">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                </div>
                <div class="category-grid-item" data-category="transport">
                    <div class="category-grid-icon">üöó</div>
                    <div class="category-grid-label">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</div>
                </div>
                <div class="category-grid-item" data-category="housing">
                    <div class="category-grid-icon">üè†</div>
                    <div class="category-grid-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢</div>
                </div>
                <div class="category-grid-item" data-category="utilities">
                    <div class="category-grid-icon">üí°</div>
                    <div class="category-grid-label">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</div>
                </div>
                <div class="category-grid-item" data-category="healthcare">
                    <div class="category-grid-icon">üè•</div>
                    <div class="category-grid-label">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                </div>
                <div class="category-grid-item" data-category="entertainment">
                    <div class="category-grid-icon">üé¨</div>
                    <div class="category-grid-label">‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</div>
                </div>
                <div class="category-grid-item" data-category="education">
                    <div class="category-grid-icon">üìö</div>
                    <div class="category-grid-label">‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
                </div>
                <div class="category-grid-item" data-category="shopping">
                    <div class="category-grid-icon">üõçÔ∏è</div>
                    <div class="category-grid-label">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</div>
                </div>
                <div class="category-grid-item" data-category="tax">
                    <div class="category-grid-icon">üí∞</div>
                    <div class="category-grid-label">‡∏†‡∏≤‡∏©‡∏µ/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</div>
                </div>
                <div class="category-grid-item" data-category="installment">
                    <div class="category-grid-icon">üí≥</div>
                    <div class="category-grid-label">‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div>
                </div>
                <div class="category-grid-item" data-category="other">
                    <div class="category-grid-icon">üì¶</div>
                    <div class="category-grid-label">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Income Category Selector (Bottom Sheet) -->
<div class="modal bottom-sheet" id="income-category-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
        </div>
        <div class="bottom-sheet-body">
            <div class="category-grid">
                <div class="category-grid-item" data-category="salary">
                    <div class="category-grid-icon">üí∞</div>
                    <div class="category-grid-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
                <div class="category-grid-item" data-category="bonus">
                    <div class="category-grid-icon">üéÅ</div>
                    <div class="category-grid-label">‡πÇ‡∏ö‡∏ô‡∏±‡∏™</div>
                </div>
                <div class="category-grid-item" data-category="other-income">
                    <div class="category-grid-icon">üìà</div>
                    <div class="category-grid-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Expense Transaction -->
<div class="modal" id="expense-form-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="expense-form">
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" class="form-input" id="expense-category-display" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" class="form-input" id="expense-date" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                <input type="time" class="form-input" id="expense-time" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <textarea class="form-textarea" id="expense-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏á" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="expense-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Add Income Transaction -->
<div class="modal" id="income-form-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header income">
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="income-form">
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" class="form-input" id="income-category-display" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" class="form-input" id="income-date" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                <input type="time" class="form-input" id="income-time" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <textarea class="form-textarea" id="income-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="income-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'home' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
// ===== MODAL SYSTEM =====
const modals = {
    expenseCategory: document.getElementById('expense-category-modal'),
    incomeCategory: document.getElementById('income-category-modal'),
    expenseForm: document.getElementById('expense-form-modal'),
    incomeForm: document.getElementById('income-form-modal')
};

let selectedCategory = null;
let selectedCategoryLabel = null;

// Helper functions
function openModal(modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modal) {
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

function closeAllModals() {
    Object.values(modals).forEach(modal => closeModal(modal));
}

// ===== QUICK ACTIONS =====
document.getElementById('btn-add-expense').addEventListener('click', () => {
    openModal(modals.expenseCategory);
});

document.getElementById('btn-add-income').addEventListener('click', () => {
    openModal(modals.incomeCategory);
});

// ===== EXPENSE CATEGORY SELECTION =====
document.querySelectorAll('#expense-category-modal .category-grid-item').forEach(item => {
    item.addEventListener('click', () => {
        selectedCategory = item.dataset.category;
        selectedCategoryLabel = item.querySelector('.category-grid-label').textContent;

        // Close category modal
        closeModal(modals.expenseCategory);

        // Open expense form with selected category
        setTimeout(() => {
            document.getElementById('expense-category-display').value = selectedCategoryLabel;
            setDefaultDateTime('expense');
            openModal(modals.expenseForm);
        }, 300);
    });
});

// ===== INCOME CATEGORY SELECTION =====
document.querySelectorAll('#income-category-modal .category-grid-item').forEach(item => {
    item.addEventListener('click', () => {
        selectedCategory = item.dataset.category;
        selectedCategoryLabel = item.querySelector('.category-grid-label').textContent;

        // Close category modal
        closeModal(modals.incomeCategory);

        // Open income form with selected category
        setTimeout(() => {
            document.getElementById('income-category-display').value = selectedCategoryLabel;
            setDefaultDateTime('income');
            openModal(modals.incomeForm);
        }, 300);
    });
});

// ===== SET DEFAULT DATE/TIME =====
function setDefaultDateTime(type) {
    const now = new Date();
    const date = now.toISOString().split('T')[0];
    const time = now.toTimeString().slice(0, 5);

    document.getElementById(`${type}-date`).value = date;
    document.getElementById(`${type}-time`).value = time;
}

// ===== CLOSE BUTTONS =====
document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
        closeAllModals();
    });
});

// ===== OVERLAY CLICKS =====
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', () => {
        closeAllModals();
    });
});

// ===== ESC KEY =====
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeAllModals();
    }
});

// ===== EXPENSE FORM SUBMISSION =====
document.getElementById('expense-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Validation
    const amount = parseFloat(document.getElementById('expense-amount').value);
    if (!selectedCategory) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Prepare data
    const date = document.getElementById('expense-date').value;
    const time = document.getElementById('expense-time').value;
    const occurred_at = `${date}T${time}:00`;

    const payload = {
        type: 'expense',
        category_id: selectedCategory,
        amount: amount,
        occurred_at: occurred_at,
        note: document.getElementById('expense-note').value || null
    };

    try {
        const result = await API.post(buildApiUrl('transactions'), payload);

        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

        // Reset form
        document.getElementById('expense-form').reset();
        selectedCategory = null;
        selectedCategoryLabel = null;
        closeAllModals();

        // Reload dashboard
        await loadDashboard();

    } catch (error) {
        console.error('Transaction error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// ===== INCOME FORM SUBMISSION =====
document.getElementById('income-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Validation
    const amount = parseFloat(document.getElementById('income-amount').value);
    if (!selectedCategory) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Prepare data
    const date = document.getElementById('income-date').value;
    const time = document.getElementById('income-time').value;
    const occurred_at = `${date}T${time}:00`;

    const payload = {
        type: 'income',
        category_id: selectedCategory,
        amount: amount,
        occurred_at: occurred_at,
        note: document.getElementById('income-note').value || null
    };

    try {
        const result = await API.post(buildApiUrl('transactions'), payload);

        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

        // Reset form
        document.getElementById('income-form').reset();
        selectedCategory = null;
        selectedCategoryLabel = null;
        closeAllModals();

        // Reload dashboard
        await loadDashboard();

    } catch (error) {
        console.error('Transaction error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// ===== DASHBOARD DATA =====
async function loadDashboard() {
    try {
        // Fetch recent transactions
        const result = await API.get(buildApiUrl('transactions') + '?per_page=10&page=1');

        if (result.transactions && result.transactions.length > 0) {
            // TODO: Update transaction list UI with real data
            console.log('Transactions loaded:', result.transactions);
        } else {
            console.log('No transactions yet');
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
        // Don't show error toast on load - user might not have project yet
    }
}

// ===== DEEP LINKING SUPPORT =====
function handleDeepLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const modalType = urlParams.get('openModal');

    if (modalType === 'expense') {
        setTimeout(() => openModal(modals.expenseCategory), 100);
    } else if (modalType === 'income') {
        setTimeout(() => openModal(modals.incomeCategory), 100);
    }
}

// Load on page ready
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
    handleDeepLink();
});
</script>
{% endblock %}
