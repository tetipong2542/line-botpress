{% extends "base.html" %}

{% block title %}‡∏´‡∏°‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container page-loading">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="folder"></i>
                ‡∏´‡∏°‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
        </div>
    </div>

    <!-- Category Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="expense">
            <i data-lucide="minus-circle"></i>
            <span>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
        </button>
        <button class="tab" data-tab="income">
            <i data-lucide="plus-circle"></i>
            <span>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
        </button>
    </div>

    <!-- Categories List - Expense -->
    <div class="tab-content active" id="expense-categories">
        <div class="category-list">
            <!-- Loading skeleton -->
            <div class="loading-skeleton">
                <div class="skeleton-item"></div>
                <div class="skeleton-item"></div>
                <div class="skeleton-item"></div>
            </div>
        </div>
    </div>

    <!-- Categories List - Income -->
    <div class="tab-content" id="income-categories">
        <div class="category-list">
            <!-- Loading skeleton -->
            <div class="loading-skeleton">
                <div class="skeleton-item"></div>
                <div class="skeleton-item"></div>
            </div>
        </div>
    </div>

    <!-- Add Category Button -->
    <div class="floating-action">
        <button class="btn-fab" id="add-category-btn">
            <i data-lucide="plus"></i>
        </button>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Modal: Add/Edit Category -->
<div class="modal" id="category-modal">
    <div class="modal-overlay" onclick="closeCategoryModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="category-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
            <button class="modal-close" onclick="closeCategoryModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="category-form">
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select class="form-select" id="category-type" required>
                    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</label>
                <button type="button" class="icon-picker-trigger" onclick="openIconPicker()">
                    <i data-lucide="folder" id="selected-icon-preview"></i>
                    <span id="selected-icon-name">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</span>
                </button>
                <input type="hidden" id="category-icon" value="folder" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" class="form-input" id="category-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏™‡∏µ</label>
                <div class="color-picker">
                    <input type="color" id="category-color" value="#EF4444">
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Icon Picker -->
<div class="modal" id="icon-picker-modal">
    <div class="modal-overlay" onclick="closeIconPicker()"></div>
    <div class="modal-content icon-picker-content">
        <div class="modal-header">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</h2>
            <button class="modal-close" onclick="closeIconPicker()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="text" class="form-input" id="icon-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô..." onkeyup="filterIcons()">
            <div class="icon-grid" id="icon-grid">
                <!-- Icons will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal: Category Usage Details -->
<div class="modal" id="category-usage-modal">
    <div class="modal-overlay" onclick="closeCategoryUsage()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="usage-modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
            <button class="modal-close" onclick="closeCategoryUsage()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="usage-summary">
                <div class="usage-category-info">
                    <div id="usage-category-icon" class="usage-icon">üìÅ</div>
                    <div>
                        <h3 id="usage-category-name">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                        <span id="usage-category-type" class="category-type-badge">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                    </div>
                </div>
            </div>

            <div class="usage-stats">
                <h4>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h4>
                <div class="usage-list">
                    <div class="usage-item">
                        <div class="usage-item-icon">
                            <i data-lucide="receipt"></i>
                        </div>
                        <div class="usage-item-info">
                            <span class="usage-item-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</span>
                            <span class="usage-item-count" id="usage-transactions">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    </div>

                    <div class="usage-item">
                        <div class="usage-item-icon">
                            <i data-lucide="refresh-cw"></i>
                        </div>
                        <div class="usage-item-info">
                            <span class="usage-item-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</span>
                            <span class="usage-item-count" id="usage-recurring">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    </div>

                    <div class="usage-item">
                        <div class="usage-item-icon">
                            <i data-lucide="wallet"></i>
                        </div>
                        <div class="usage-item-info">
                            <span class="usage-item-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                            <span class="usage-item-count" id="usage-budgets">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    </div>

                    <div class="usage-item">
                        <div class="usage-item-icon">
                            <i data-lucide="target"></i>
                        </div>
                        <div class="usage-item-info">
                            <span class="usage-item-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
                            <span class="usage-item-count" id="usage-goals">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    </div>
                </div>

                <div class="usage-total">
                    <strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong>
                    <strong id="usage-total-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong>
                </div>
            </div>

            <div class="usage-actions">
                <button type="button" class="btn-secondary" onclick="closeCategoryUsage()">
                    <i data-lucide="x"></i>
                    <span>‡∏õ‡∏¥‡∏î</span>
                </button>
                <button type="button" class="btn-primary" id="edit-category-from-usage">
                    <i data-lucide="edit-2"></i>
                    <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.icon-picker-trigger {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    text-align: left;
}

.icon-picker-trigger:hover {
    background: var(--border);
}

.icon-picker-trigger i {
    width: 24px;
    height: 24px;
}

.color-picker input {
    width: 100%;
    height: 48px;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
}

.icon-picker-content {
    max-width: 500px;
}

.icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 16px;
}

.icon-item {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    background: var(--bg-secondary);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.icon-item:hover {
    background: var(--border);
    border-color: var(--primary);
}

.icon-item.selected {
    background: var(--primary-light);
    border-color: var(--primary);
}

.icon-item i {
    width: 24px;
    height: 24px;
}

/* Usage Modal Styles */
.usage-summary {
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 1.5rem;
}

.usage-category-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.usage-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    background: var(--card-bg);
    border-radius: 12px;
    border: 2px solid var(--border-color);
}

.usage-icon i {
    width: 32px;
    height: 32px;
}

#usage-category-name {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.category-type-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    background: var(--primary-color);
    color: white;
}

.usage-stats {
    margin-bottom: 1.5rem;
}

.usage-stats h4 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.usage-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.usage-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1.5px solid var(--border-color);
    transition: all 0.2s ease;
}

.usage-item:hover {
    border-color: var(--primary-color);
    background: color-mix(in srgb, var(--primary-color) 5%, var(--bg-secondary));
}

.usage-item-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: color-mix(in srgb, var(--primary-color) 15%, transparent);
    border-radius: 10px;
    color: var(--primary-color);
}

.usage-item-icon i {
    width: 20px;
    height: 20px;
}

.usage-item-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.usage-item-label {
    font-size: 0.9375rem;
    color: var(--text-primary);
    font-weight: 500;
}

.usage-item-count {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.usage-total {
    display: flex;
    justify-content: space-between;
    padding: 1rem;
    margin-top: 1rem;
    background: color-mix(in srgb, var(--primary-color) 10%, transparent);
    border-radius: 12px;
    border: 2px solid var(--primary-color);
}

.usage-total strong {
    font-size: 1rem;
    color: var(--text-primary);
}

.usage-actions {
    display: flex;
    gap: 0.75rem;
}

.usage-actions button {
    flex: 1;
}

/* Loading Skeleton */
.loading-skeleton {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem;
}

.skeleton-item {
    height: 70px;
    background: linear-gradient(
        90deg,
        var(--bg-secondary) 25%,
        var(--border-color) 50%,
        var(--bg-secondary) 75%
    );
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 12px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}
</style>

<!-- Sticky Footer Menu -->
{% set current_page = 'categories' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Tab switching
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;

        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update active content
        tabContents.forEach(content => {
            if (content.id === `${targetTab}-categories`) {
                content.classList.add('active');
            } else {
                content.classList.remove('active');
            }
        });
    });
});

// Add category button
document.getElementById('add-category-btn').addEventListener('click', async () => {
    const activeTab = document.querySelector('.category-tab.active').dataset.tab;
    const categoryName = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà:');

    if (!categoryName || !categoryName.trim()) {
        return;
    }

    try {
        await API.post(buildApiUrl('categories'), {
            name_th: categoryName.trim(),
            type: activeTab,
            icon: activeTab === 'expense' ? 'üìÅ' : 'üí∞',
            color: '#6B7280'
        });

        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        await loadCategories();

    } catch (error) {
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏î‡πâ', 'error');
    }
});

// Load categories with usage counts
async function loadCategories() {
    try {
        const result = await API.get(buildApiUrl('categories'));

        if (result.categories && result.categories.length > 0) {
            const categories = result.categories;

            // Separate by type
            const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
            const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

            // Helper to render icon (Lucide or Emoji)
            const renderIcon = (iconName) => {
                const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName || '');
                if (isEmoji || !iconName) {
                    return `<div class="category-icon">${iconName || 'üìÅ'}</div>`;
                } else {
                    return `<div class="category-icon"><i data-lucide="${iconName}"></i></div>`;
                }
            };

            // Fetch usage counts for all categories in parallel
            const usageCounts = await Promise.all(
                categories.map(async (cat) => {
                    try {
                        const usageResult = await API.get(buildApiUrl('categories', cat.id) + '/usage');
                        return { id: cat.id, count: usageResult.usage.total };
                    } catch {
                        return { id: cat.id, count: 0 };
                    }
                })
            );

            const usageMap = {};
            usageCounts.forEach(item => {
                usageMap[item.id] = item.count;
            });

            // Update expense categories
            const expenseContent = document.querySelector('#expense-categories .category-list');
            if (expenseContent) {
                // Remove loading skeleton first
                const expenseSkeleton = expenseContent.querySelector('.loading-skeleton');
                if (expenseSkeleton) {
                    expenseSkeleton.remove();
                }

                expenseContent.innerHTML = expenseCategories.map(cat => `
                    <div class="category-item" onclick="showCategoryUsage('${cat.id}')" style="cursor: pointer;">
                        ${renderIcon(cat.icon)}
                        <div class="category-info">
                            <div class="category-name">${cat.name_th}</div>
                            <div class="category-meta">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‚Ä¢ ${usageMap[cat.id] || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        </div>
                        <div class="category-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); editCategory('${cat.id}', '${cat.name_th}')">
                                <i data-lucide="edit-2"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Update income categories
            const incomeContent = document.querySelector('#income-categories .category-list');
            if (incomeContent) {
                // Remove loading skeleton first
                const incomeSkeleton = incomeContent.querySelector('.loading-skeleton');
                if (incomeSkeleton) {
                    incomeSkeleton.remove();
                }

                incomeContent.innerHTML = incomeCategories.map(cat => `
                    <div class="category-item" onclick="showCategoryUsage('${cat.id}')" style="cursor: pointer;">
                        ${renderIcon(cat.icon)}
                        <div class="category-info">
                            <div class="category-name">${cat.name_th}</div>
                            <div class="category-meta">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‚Ä¢ ${usageMap[cat.id] || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        </div>
                        <div class="category-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); editCategory('${cat.id}', '${cat.name_th}')">
                                <i data-lucide="edit-2"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Initialize Lucide icons ONCE for all buttons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Delete category
async function deleteCategory(categoryId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    // Use LoadingManager with top loading bar
    await LoadingManager.withLoading(
        async () => {
            const result = await API.delete(buildApiUrl('categories') + `/${categoryId}`);

            if (result.warning) {
                showToast(result.warning, 'warning', 5000);
            } else {
                showToast('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }

            await loadCategories();
        },
        {
            topBar: true  // Show top loading bar during deletion
        }
    );
}

// Edit category - Now uses modal instead of prompt
async function editCategory(categoryId, currentName) {
    openCategoryModal(categoryId);
    // TODO: Fetch and pre-fill category data in modal
}

// Popular Lucide icons for categories
const CATEGORY_ICONS = [
    'utensils', 'coffee', 'shopping-bag', 'car', 'bus', 'train', 'plane',
    'home', 'zap', 'droplet', 'wifi', 'phone', 'smartphone', 'laptop',
    'tv', 'music', 'film', 'gamepad', 'gift', 'heart', 'star',
    'book', 'bookmark', 'briefcase', 'calendar', 'camera', 'clock',
    'credit-card', 'dollar-sign', 'trending-up', 'trending-down',
    'shopping-cart', 'package', 'truck', 'bicycle', 'football',
    'dumbbell', 'umbrella', 'sun', 'cloud', 'shirt', 'scissors'
];

let editingCategoryId = null;

// Modal functions
function openCategoryModal(categoryId = null) {
    const modal = document.getElementById('category-modal');
    const title = document.getElementById('category-modal-title');
    const form = document.getElementById('category-form');

    if (categoryId) {
        editingCategoryId = categoryId;
        title.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
        // Load category data (simplified - in real app, fetch from API)
    } else {
        editingCategoryId = null;
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
        form.reset();
    }

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Initialize icons only in modal
    setTimeout(() => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 50);
}

function closeCategoryModal() {
    document.getElementById('category-modal').classList.remove('active');
    document.body.style.overflow = '';
    editingCategoryId = null;
}

function openIconPicker() {
    const modal = document.getElementById('icon-picker-modal');
    const grid = document.getElementById('icon-grid');

    // Populate icon grid
    grid.innerHTML = CATEGORY_ICONS.map(icon => `
        <div class="icon-item" onclick="selectIcon('${icon}')">
            <i data-lucide="${icon}"></i>
        </div>
    `).join('');

    modal.classList.add('active');
    
    // Initialize icons only in icon picker
    setTimeout(() => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 50);
}

function closeIconPicker() {
    document.getElementById('icon-picker-modal').classList.remove('active');
}

function selectIcon(iconName) {
    document.getElementById('category-icon').value = iconName;
    document.getElementById('selected-icon-preview').setAttribute('data-lucide', iconName);
    document.getElementById('selected-icon-name').textContent = iconName;
    
    // Initialize only the preview icon
    setTimeout(() => {
        const preview = document.getElementById('selected-icon-preview');
        if (preview && typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 10);
    
    closeIconPicker();
}

function filterIcons() {
    const search = document.getElementById('icon-search').value.toLowerCase();
    const items = document.querySelectorAll('.icon-item');
    items.forEach(item => {
        const icon = item.querySelector('i').getAttribute('data-lucide');
        item.style.display = icon.includes(search) ? 'flex' : 'none';
    });
}

// Form submission
document.getElementById('add-category-btn').addEventListener('click', () => openCategoryModal());

document.getElementById('category-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');

    const payload = {
        type: document.getElementById('category-type').value,
        name_th: document.getElementById('category-name').value,
        icon: document.getElementById('category-icon').value,
        color: document.getElementById('category-color').value
    };

    // Use LoadingManager for automatic loading state management
    await LoadingManager.withLoading(
        async () => {
            if (editingCategoryId) {
                await API.put(buildApiUrl('categories', editingCategoryId), payload);
                showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
                await API.post(buildApiUrl('categories'), payload);
                showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }

            closeCategoryModal();
            await loadCategories();
        },
        {
            button: submitBtn,  // Automatic button loading state
            topBar: true        // Show top loading bar
        }
    );
});

// Show category usage details modal
let currentCategoryIdForUsage = null;

async function showCategoryUsage(categoryId) {
    try {
        const result = await API.get(buildApiUrl('categories', categoryId) + '/usage');

        if (!result || !result.category) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
        }

        const category = result.category;
        const usage = result.usage;

        currentCategoryIdForUsage = categoryId;

        // Update modal content
        document.getElementById('usage-modal-title').textContent = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
        document.getElementById('usage-category-name').textContent = category.name_th;
        document.getElementById('usage-category-type').textContent = category.type === 'expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';

        // Update icon
        const iconEl = document.getElementById('usage-category-icon');
        const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(category.icon || '');
        if (isEmoji || !category.icon) {
            iconEl.innerHTML = category.icon || 'üìÅ';
        } else {
            iconEl.innerHTML = `<i data-lucide="${category.icon}"></i>`;
        }

        // Update usage counts
        document.getElementById('usage-transactions').textContent = `${usage.transactions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        document.getElementById('usage-recurring').textContent = `${usage.recurring_transactions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        document.getElementById('usage-budgets').textContent = `${usage.budgets} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        document.getElementById('usage-goals').textContent = `${usage.goals} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        document.getElementById('usage-total-count').textContent = `${usage.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

        // Show modal
        const modal = document.getElementById('category-usage-modal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Initialize icons
        setTimeout(() => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }, 50);

    } catch (error) {
        console.error('Error loading category usage:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

function closeCategoryUsage() {
    const modal = document.getElementById('category-usage-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    currentCategoryIdForUsage = null;
}

// Edit category from usage modal
document.addEventListener('DOMContentLoaded', () => {
    const editBtn = document.getElementById('edit-category-from-usage');
    if (editBtn) {
        editBtn.addEventListener('click', () => {
            if (currentCategoryIdForUsage) {
                closeCategoryUsage();
                openCategoryModal(currentCategoryIdForUsage);
            }
        });
    }
});

// Load on page ready
document.addEventListener('DOMContentLoaded', () => {
    loadCategories();

    // Remove loading class and fade in
    const container = document.querySelector('.mobile-container');
    if (container) {
        container.classList.remove('page-loading');
        container.classList.add('fade-in');
    }

    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
