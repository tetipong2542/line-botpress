{% extends "base.html" %}

{% block title %}‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="wallet"></i>
                ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>
        </div>
    </div>

    <!-- Period Selector -->
    <div class="period-selector">
        <button class="period-nav" id="prev-period">
            <i data-lucide="chevron-left"></i>
        </button>
        <div class="period-display">
            <span id="current-period">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2026</span>
        </div>
        <button class="period-nav" id="next-period">
            <i data-lucide="chevron-right"></i>
        </button>
    </div>

    <!-- Budget Stats (matching goals-stats design) -->
    <div class="budgets-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i data-lucide="wallet"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="total-budgeted">‡∏ø0</div>
                <div class="stat-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
            </div>
        </div>

        <div class="stat-card expense">
            <div class="stat-icon">
                <i data-lucide="trending-down"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="total-spent">‡∏ø0</div>
                <div class="stat-label">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</div>
            </div>
        </div>

        <div class="stat-card income">
            <div class="stat-icon">
                <i data-lucide="piggy-bank"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="total-remaining">‡∏ø0</div>
                <div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            </div>
        </div>
    </div>

    <!-- Budget List -->
    <div class="section">
        <div id="budgets-list" class="budgets-list">
            <!-- Populated by JavaScript -->
            <div class="empty-state">
                <i data-lucide="wallet"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>
                <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡πà‡∏≤‡∏á‡πÜ</p>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action">
        <button class="btn-fab" id="btn-add-budget">
            <i data-lucide="plus"></i>
        </button>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Modal: Add/Edit Budget -->
<div class="modal" id="budget-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="budget-form">
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="form-select" id="budget-category" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</option>
                    <!-- Populated by JavaScript -->
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                <input type="month" class="form-input" id="budget-month" required>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="budget-amount" placeholder="0.00"
                        step="0.01" min="0" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>
                <select class="form-select" id="budget-rollover">
                    <option value="none">‡πÑ‡∏°‡πà‡∏¢‡∏Å‡∏¢‡∏≠‡∏î</option>
                    <option value="add">‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</option>
                    <option value="reset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</option>
                </select>
                <small class="form-hint">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</small>
            </div>

            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'budgets' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // ===== STATE =====
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let editingBudgetId = null;
    let allCategories = [];

    // Thai month names
    const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCategories();
        updatePeriodDisplay();
        await loadBudgets();
        setupEventListeners();
    });

    // ===== LOAD CATEGORIES =====
    async function loadCategories() {
        try {
            const result = await API.get(buildApiUrl('categories'));

            if (result.categories) {
                // Filter only expense categories (budgets are typically for expenses)
                allCategories = result.categories.filter(c => c.type === 'expense' && c.is_active);

                // Populate category dropdown
                const select = document.getElementById('budget-category');
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</option>' +
                    allCategories.map(cat => `
                    <option value="${cat.id}">${cat.icon || 'üìÅ'} ${cat.name_th}</option>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // ===== LOAD BUDGETS =====
    async function loadBudgets() {
        try {
            const month = formatMonthParam();

            const [budgetsResult, summaryResult] = await Promise.all([
                API.get(buildApiUrl(`budgets?month=${month}`)),
                API.get(buildApiUrl(`budgets/summary?month=${month}`))
            ]);

            const budgetCount = budgetsResult.budgets ? budgetsResult.budgets.length : 0;

            // Update summary cards with count
            if (summaryResult.summary) {
                updateSummaryCards(summaryResult.summary, budgetCount);
            }

            // Render budget list
            if (budgetsResult.budgets && budgetsResult.budgets.length > 0) {
                renderBudgets(budgetsResult.budgets);
            } else {
                showEmptyState();
            }

        } catch (error) {
            console.error('Error loading budgets:', error);
            showEmptyState();
        }
    }

    // ===== UPDATE SUMMARY CARDS =====
    function updateSummaryCards(summary, budgetCount = 0) {
        const formatMoney = (amount) => {
            return amount.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };

        // Update total budgeted
        document.getElementById('total-budgeted').textContent = `‡∏ø${formatMoney(summary.total_budgeted_formatted)}`;

        // Update spent
        document.getElementById('total-spent').textContent = `‡∏ø${formatMoney(summary.total_spent_formatted)}`;

        // Update remaining
        const remainingEl = document.getElementById('total-remaining');
        remainingEl.textContent = `‡∏ø${formatMoney(summary.total_remaining_formatted)}`;
    }

    // ===== RENDER BUDGETS =====
    function renderBudgets(budgets) {
        const container = document.getElementById('budgets-list');

        // Mapping Lucide icon names to display
        const lucideIconMap = {
            'utensils': 'utensils',
            'car': 'car',
            'shopping-bag': 'shopping-bag',
            'film': 'film',
            'heart': 'heart',
            'home': 'home',
            'book': 'book',
            'gift': 'gift',
            'coffee': 'coffee',
            'plane': 'plane',
            'gamepad-2': 'gamepad-2',
            'smartphone': 'smartphone',
            'shirt': 'shirt',
            'wifi': 'wifi',
            'zap': 'zap',
            'droplet': 'droplet',
            'baby': 'baby',
            'briefcase': 'briefcase',
            'graduation-cap': 'graduation-cap',
            'stethoscope': 'stethoscope'
        };

        // Function to check if string is emoji
        function isEmoji(str) {
            const emojiRegex = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u;
            return emojiRegex.test(str);
        }

        container.innerHTML = budgets.map(budget => {
            const progressColor = budget.is_over_budget ? 'over' : budget.is_near_limit ? 'warning' : 'normal';
            const statusText = budget.is_over_budget ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö' : budget.is_near_limit ? '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' : '‡∏õ‡∏Å‡∏ï‡∏¥';

            // Handle null category with fallback values
            const category = budget.category || {};
            const categoryName = category.name_th || '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const categoryIcon = category.icon || 'folder';
            const categoryColor = category.color || '#6366f1';

            // Determine if icon is emoji or Lucide name
            const isIconEmoji = isEmoji(categoryIcon);
            const iconHtml = isIconEmoji
                ? `<span class="budget-icon-emoji">${categoryIcon}</span>`
                : `<i data-lucide="${lucideIconMap[categoryIcon] || categoryIcon}" class="budget-lucide-icon"></i>`;

            return `
            <div class="budget-card ${budget.is_over_budget ? 'over-budget' : ''} ${budget.is_near_limit ? 'near-limit' : ''}" data-id="${budget.id}">
                <div class="budget-card-header">
                    <div class="budget-main-info">
                        <div class="budget-icon-wrapper" style="
                            background: color-mix(in srgb, ${categoryColor} 15%, transparent);
                            border-color: ${categoryColor};
                            color: ${categoryColor};
                        ">
                            ${iconHtml}
                        </div>
                        <div class="budget-title-section">
                            <h3 class="budget-title">${categoryName}</h3>
                            <span class="budget-subtitle ${progressColor}">
                                <i data-lucide="${budget.is_over_budget ? 'alert-circle' : budget.is_near_limit ? 'alert-triangle' : 'check-circle'}"></i>
                                ${statusText}
                            </span>
                        </div>
                    </div>
                    <div class="budget-menu-wrapper">
                        <button type="button" class="btn-menu" onclick="toggleBudgetMenu('${budget.id}')" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
                            <i data-lucide="more-vertical"></i>
                        </button>
                        <div class="dropdown-menu" id="menu-${budget.id}">
                            <button type="button" class="menu-item" onclick="editBudget('${budget.id}'); closeAllMenus();">
                                <i data-lucide="edit-2"></i>
                                <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                            </button>
                            <button type="button" class="menu-item danger" onclick="deleteBudget('${budget.id}'); closeAllMenus();">
                                <i data-lucide="trash-2"></i>
                                <span>‡∏•‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="budget-amount-section">
                    <div class="amount-item">
                        <span class="amount-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                        <span class="amount-value budget">‡∏ø${budget.limit_amount_formatted.toLocaleString('th-TH')}</span>
                    </div>
                    <div class="amount-item center">
                        <span class="amount-label">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>
                        <span class="amount-value spent">‡∏ø${budget.spent_formatted.toLocaleString('th-TH')}</span>
                    </div>
                    <div class="amount-item">
                        <span class="amount-label">
                            ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                            <i data-lucide="${budget.remaining < 0 ? 'alert-triangle' : 'check'}" class="remaining-icon ${budget.remaining < 0 ? 'negative' : 'positive'}"></i>
                        </span>
                        <span class="amount-value ${budget.remaining < 0 ? 'negative' : 'positive'}">‡∏ø${Math.abs(budget.remaining_formatted).toLocaleString('th-TH')}</span>
                    </div>
                </div>

                <div class="budget-progress-section">
                    <div class="progress-bar-large">
                        <div class="progress-fill-large ${progressColor}" style="width: ${Math.min(budget.usage_percentage, 100)}%">
                            <span class="progress-percentage">${budget.usage_percentage}%</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');

        lucide.createIcons();
    }

    // Menu toggle functions
    function toggleBudgetMenu(budgetId) {
        const menu = document.getElementById(`menu-${budgetId}`);
        const isOpen = menu.classList.contains('show');

        // Close all menus first
        closeAllMenus();

        // Toggle current menu
        if (!isOpen) {
            menu.classList.add('show');
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.budget-menu-wrapper')) {
            closeAllMenus();
        }
    });

    // ===== SHOW EMPTY STATE =====
    function showEmptyState() {
        const container = document.getElementById('budgets-list');
        container.innerHTML = `
        <div class="empty-state">
            <i data-lucide="wallet"></i>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>
            <p class="empty-subtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡πà‡∏≤‡∏á‡πÜ</p>
        </div>
    `;
        lucide.createIcons();
    }

    // ===== MODAL MANAGEMENT =====
    const modal = document.getElementById('budget-modal');

    function openModal() {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        editingBudgetId = null;
        document.getElementById('budget-form').reset();
        document.getElementById('modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì';
        // Re-enable fields for add mode
        document.getElementById('budget-category').disabled = false;
        document.getElementById('budget-month').disabled = false;
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
        // Add budget button
        document.getElementById('btn-add-budget').addEventListener('click', () => {
            editingBudgetId = null;
            document.getElementById('modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì';

            // Enable fields for add mode
            document.getElementById('budget-category').disabled = false;
            document.getElementById('budget-month').disabled = false;

            // Set default month to current period
            const defaultMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            document.getElementById('budget-month').value = defaultMonth;

            openModal();
        });

        // Close modal
        modal.querySelector('.modal-close').addEventListener('click', closeModal);
        modal.querySelector('.modal-overlay').addEventListener('click', closeModal);

        // Form submit
        document.getElementById('budget-form').addEventListener('submit', handleSubmit);

        // Period navigation
        document.getElementById('prev-period').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updatePeriodDisplay();
            loadBudgets();
        });

        document.getElementById('next-period').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updatePeriodDisplay();
            loadBudgets();
        });

        // ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    }

    // ===== FORM SUBMIT =====
    async function handleSubmit(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalContent = submitBtn.innerHTML;

        try {
            // Get form data
            const categoryId = document.getElementById('budget-category').value;
            const month = document.getElementById('budget-month').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            const rolloverPolicy = document.getElementById('budget-rollover').value;

            // Debug logging
            console.log('Form submit:', {
                editingBudgetId: editingBudgetId,
                categoryId: categoryId,
                month: month,
                amount: amount,
                rolloverPolicy: rolloverPolicy
            });

            // Validation - different for add vs edit mode
            if (editingBudgetId) {
                // Edit mode: only validate amount
                if (!amount || amount <= 0) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }
            } else {
                // Add mode: validate all fields
                if (!categoryId || !month || !amount || amount <= 0) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }
            }

            // Loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
            lucide.createIcons();

            if (editingBudgetId) {
                // Update existing budget - only send limit_amount and rollover_policy
                const updatePayload = {
                    limit_amount: Math.round(amount * 100), // Convert to satang
                    rollover_policy: rolloverPolicy
                };
                console.log('PUT request:', buildApiUrl('budgets', editingBudgetId), updatePayload);
                await API.put(buildApiUrl('budgets', editingBudgetId), updatePayload);
                showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
                // Create new budget - send all fields
                const createPayload = {
                    category_id: categoryId,
                    month: month,
                    limit_amount: Math.round(amount * 100), // Convert to satang
                    rollover_policy: rolloverPolicy
                };
                console.log('POST request:', buildApiUrl('budgets'), createPayload);
                await API.post(buildApiUrl('budgets'), createPayload);
                showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }

            closeModal();
            await loadBudgets();

        } catch (error) {
            console.error('Budget save error:', error);
            showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');

        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;
            lucide.createIcons();
        }
    }

    // ===== EDIT BUDGET =====
    async function editBudget(budgetId) {
        try {
            const result = await API.get(buildApiUrl('budgets', budgetId));
            const budget = result.budget;

            editingBudgetId = budgetId;
            console.log('Editing budget:', editingBudgetId, budget);
            document.getElementById('modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì';

            // Fill form
            document.getElementById('budget-category').value = budget.category_id;
            document.getElementById('budget-month').value = budget.month_yyyymm;
            document.getElementById('budget-amount').value = budget.limit_amount_formatted;
            document.getElementById('budget-rollover').value = budget.rollover_policy;

            // Disable category and month in edit mode (they are the composite key)
            document.getElementById('budget-category').disabled = true;
            document.getElementById('budget-month').disabled = true;

            openModal();

        } catch (error) {
            showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    }

    // ===== DELETE BUDGET =====
    async function deleteBudget(budgetId) {
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }

        try {
            await API.delete(buildApiUrl('budgets', budgetId));
            showToast('‡∏•‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            await loadBudgets();

        } catch (error) {
            showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
        }
    }

    // ===== UTILITY FUNCTIONS =====
    function formatMonthParam() {
        const month = String(currentMonth + 1).padStart(2, '0');
        return `${currentYear}-${month}`;
    }

    function updatePeriodDisplay() {
        const periodEl = document.getElementById('current-period');
        if (periodEl) {
            periodEl.textContent = `${thaiMonths[currentMonth]} ${currentYear + 543}`;
        }
    }
</script>

<style>
    /* ===== BUDGETS STATS (matching goals-stats) ===== */
    .budgets-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        padding: 0 1rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark, #4f46e5));
        color: white;
        flex-shrink: 0;
    }

    .stat-icon i {
        width: 20px;
        height: 20px;
    }

    .stat-card.income .stat-icon {
        background: linear-gradient(135deg, var(--income-color, #10b981), #34d399);
    }

    .stat-card.expense .stat-icon {
        background: linear-gradient(135deg, var(--expense-color, #ef4444), #f87171);
    }

    .stat-content {
        flex: 1;
        min-width: 0;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .stat-label {
        font-size: 11px;
        color: var(--text-secondary);
        font-weight: 500;
        margin-top: 2px;
    }

    /* ===== MINIMAL CARD DESIGN ===== */
    .budgets-list {
        padding: 0 1rem;
    }

    .budget-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1.5px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        animation: fadeInUp 0.3s ease;
    }

    .budget-card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .budget-card.near-limit {
        border-color: #f59e0b;
        border-width: 2px;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, var(--card-bg) 100%);
    }

    .budget-card.over-budget {
        border-color: var(--expense-color);
        border-width: 2px;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, var(--card-bg) 100%);
    }

    /* Card Header */
    .budget-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 14px;
    }

    .budget-main-info {
        display: flex;
        gap: 10px;
        flex: 1;
        align-items: flex-start;
    }

    .budget-icon-wrapper {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border: 2px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .budget-icon-emoji {
        font-size: 22px;
        filter: brightness(1.1);
    }

    .budget-lucide-icon {
        width: 24px;
        height: 24px;
        color: inherit;
    }

    .budget-icon-wrapper:has(.budget-lucide-icon) {
        color: var(--primary-color);
    }

    .budget-title-section {
        flex: 1;
        min-width: 0;
    }

    .budget-title {
        font-size: 17px;
        font-weight: 700;
        margin: 0 0 6px 0;
        color: var(--text-primary);
        line-height: 1.3;
    }

    .budget-subtitle {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .budget-subtitle i {
        width: 14px;
        height: 14px;
    }

    .budget-subtitle.normal {
        color: var(--income-color);
    }

    .budget-subtitle.warning {
        color: #f59e0b;
    }

    .budget-subtitle.over {
        color: var(--expense-color);
    }

    /* Menu Button & Dropdown */
    .budget-menu-wrapper {
        position: relative;
    }

    .btn-menu {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: none;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .btn-menu:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-menu:active {
        transform: scale(0.95);
    }

    .dropdown-menu {
        position: absolute;
        top: 42px;
        right: 0;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1.5px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        min-width: 180px;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px) scale(0.95);
        transition: all 0.2s ease;
    }

    .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° background opacity ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö theme mode */
    @supports (backdrop-filter: blur(10px)) {
        .dropdown-menu {
            background: color-mix(in srgb, var(--card-bg) 95%, transparent);
        }
    }

    .menu-item {
        width: 100%;
        padding: 12px 16px;
        border: none;
        background: transparent;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
        text-align: left;
        transition: all 0.15s ease;
    }

    .menu-item:first-child {
        border-radius: 12px 12px 0 0;
    }

    .menu-item:last-child {
        border-radius: 0 0 12px 12px;
    }

    .menu-item:hover {
        background: var(--bg-secondary);
    }

    .menu-item i {
        width: 18px;
        height: 18px;
    }

    .menu-item.danger {
        color: var(--expense-color);
    }

    /* Amount Section - Enhanced 3-Column Layout */
    .budget-amount-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0;
        margin-bottom: 12px;
        padding: 14px 12px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .amount-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
        text-align: center;
        padding: 0 8px;
    }

    .amount-item:not(:last-child) {
        border-right: 1px solid var(--border-color);
    }

    .amount-item.center {
        position: relative;
    }

    .amount-label {
        font-size: 10px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .remaining-icon {
        width: 12px;
        height: 12px;
    }

    .remaining-icon.positive {
        color: var(--income-color);
    }

    .remaining-icon.negative {
        color: var(--expense-color);
    }

    .amount-value {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .amount-value.budget {
        color: var(--primary-color);
    }

    .amount-value.spent {
        color: #f59e0b;
    }

    .amount-value.negative {
        color: var(--expense-color);
    }

    .amount-value.positive {
        color: var(--income-color);
    }

    /* Progress Section */
    .budget-progress-section {
        margin-top: 14px;
    }

    .progress-bar-large {
        height: 32px;
        background: var(--bg-secondary);
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        border: 1.5px solid var(--border-color);
    }

    .progress-fill-large {
        height: 100%;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        min-width: 50px;
    }

    .progress-fill-large.normal {
        background: linear-gradient(90deg, #22c55e, #4ade80);
    }

    .progress-fill-large.warning {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .progress-fill-large.over {
        background: linear-gradient(90deg, #ef4444, #f87171);
    }

    .progress-percentage {
        font-size: 13px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        z-index: 1;
        white-space: nowrap;
    }

    /* Period Selector */
    .period-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
    }

    .period-nav {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: var(--bg-secondary);
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .period-nav:hover {
        background: var(--primary-color);
        color: white;
    }

    .period-display {
        font-weight: 600;
        color: var(--text-primary);
        min-width: 150px;
        text-align: center;
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .summary-section {
            gap: 0.5rem;
            padding: 0 0.75rem;
        }

        .summary-card {
            padding: 0.625rem;
        }

        .summary-amount {
            font-size: 0.8rem;
        }

        .budget-card {
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 10px;
        }

        .budget-card:hover {
            padding: 13.5px;
        }

        .budget-card-header {
            margin-bottom: 12px;
        }

        .budget-icon-wrapper {
            width: 38px;
            height: 38px;
        }

        .budget-icon-emoji {
            font-size: 20px;
        }

        .budget-title {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .budget-subtitle {
            font-size: 12px;
        }

        .budget-amount-section {
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .amount-item {
            padding: 0 8px;
            gap: 3px;
        }

        .amount-label {
            font-size: 10px;
        }

        .amount-value {
            font-size: 14px;
        }

        .budget-progress-section {
            margin-top: 10px;
        }

        .progress-bar-large {
            height: 32px;
        }

        .progress-percentage {
            font-size: 13px;
        }

        .btn-menu {
            width: 32px;
            height: 32px;
            -webkit-tap-highlight-color: transparent;
        }

        .dropdown-menu {
            min-width: 160px;
        }
    }

    /* === Mobile Screen Fix (< 480px) === */
    @media (max-width: 480px) {
        .budgets-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .stat-card {
            padding: 10px 12px;
        }

        .stat-card:last-child {
            grid-column: span 2;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
        }

        .stat-value {
            font-size: 16px;
        }

        .stat-label {
            font-size: 11px;
        }

        .period-selector {
            padding: 8px 12px;
        }
    }

    /* === Budgets List Container Border === */
    .budgets-list {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 12px;
    }

    .budget-card {
        border: 1.5px solid var(--border-color);
    }

    /* === Dropdown Fixed Position Fix === */
    .dropdown-menu {
        position: fixed;
        max-height: 50vh;
        overflow-y: auto;
        z-index: 9999;
    }

    .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
    }
</style>
{% endblock %}