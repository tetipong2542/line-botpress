{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥ - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- App-Title Bar -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="refresh-cw"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥{% if user %} - {{ user.display_name }}{% endif %}
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥</p>
        </div>
    </div>

    <!-- Book-Switcher Strip (Account / Family Switcher) -->
    <div class="book-switcher">
        <button class="book-pill active" data-book="personal">
            Pond Titipong
        </button>
        <button class="book-pill" data-book="family">
            Family POND
        </button>
    </div>

    <!-- Summary Strip -->
    <div class="summary-strip">
        <div class="summary-col income">
            <div class="summary-strip-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
            <div class="summary-strip-amount">0.00</div>
        </div>
        <div class="summary-col expense">
            <div class="summary-strip-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
            <div class="summary-strip-amount">300.00</div>
        </div>
        <div class="summary-col balance">
            <div class="summary-strip-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div class="summary-strip-amount">-300.00</div>
        </div>
    </div>

    <!-- Recurring List -->
    <div class="section">
        <div class="recurring-list">
            <!-- Sample Recurring Item (Expense) -->
            <div class="recurring-card" data-id="1">
                <div class="recurring-icon expense">
                    <i data-lucide="tv"></i>
                </div>
                <div class="recurring-info">
                    <div class="recurring-title">Netflix</div>
                    <div class="recurring-meta">
                        <span class="recurring-category">‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</span>
                        <span class="recurring-freq">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</span>
                    </div>
                    <div class="recurring-alert">
                        <i data-lucide="bell"></i>
                        ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 3 ‡∏ß‡∏±‡∏ô ‚Ä¢ ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 01/02/2026
                    </div>
                </div>
                <div class="recurring-amount expense">
                    300.00
                </div>
            </div>

            <!-- Empty State (Hidden when has data) -->
            <div class="empty-state" style="display: none;">
                <i data-lucide="calendar-off"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
            </div>
        </div>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Floating Action Button -->
<div class="floating-action">
    <button class="btn-fab" id="add-recurring-btn">
        <i data-lucide="plus"></i>
    </button>
</div>

<!-- Modal: Add/Edit Recurring Transaction -->
<div class="modal" id="recurring-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="recurring-form">
            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select class="form-select" id="recurring-type">
                    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                </select>
            </div>

            <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="form-select" id="recurring-category">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" id="expense-categories">
                        <option value="food">üçî ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="transport">üöó ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
                        <option value="entertainment">üé¨ ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</option>
                        <option value="utilities">üí° ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
                        <option value="rent">üè† ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                    </optgroup>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" id="income-categories" style="display: none;">
                        <option value="salary">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="bonus">üéÅ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
                        <option value="investment">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</option>
                    </optgroup>
                </select>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                <select class="form-select" id="recurring-frequency">
                    <option value="monthly">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="weekly">‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                    <option value="yearly">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                </select>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <select class="form-select" id="recurring-day">
                    <option value="1">1</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="25">25</option>
                    <option value="28">28</option>
                </select>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" class="form-input" id="recurring-start-date" required>
            </div>

            <!-- ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Readonly) -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                <input type="text" class="form-input" id="recurring-next-date" readonly value="01/02/2026">
            </div>

            <!-- ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                <select class="form-select" id="recurring-reminder">
                    <option value="0">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
                    <option value="1">1 ‡∏ß‡∏±‡∏ô</option>
                    <option value="3" selected>3 ‡∏ß‡∏±‡∏ô</option>
                    <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
                </select>
            </div>

            <!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
            <div class="form-group">
                <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
                <textarea class="form-textarea" id="recurring-note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ" rows="2"></textarea>
            </div>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="recurring-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'recurring' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Book Switcher
const bookPills = document.querySelectorAll('.book-pill');
bookPills.forEach(pill => {
    pill.addEventListener('click', () => {
        bookPills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        // TODO: Load data for selected book
    });
});

// Modal controls
const modal = document.getElementById('recurring-modal');
const addBtn = document.getElementById('add-recurring-btn');
const closeBtn = modal.querySelector('.modal-close');
const overlay = modal.querySelector('.modal-overlay');

function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

addBtn.addEventListener('click', openModal);
closeBtn.addEventListener('click', closeModal);
overlay.addEventListener('click', closeModal);

// Type change - toggle header color and category options
const typeSelect = document.getElementById('recurring-type');
const modalHeader = modal.querySelector('.modal-header');
const expenseCategories = document.getElementById('expense-categories');
const incomeCategories = document.getElementById('income-categories');

typeSelect.addEventListener('change', (e) => {
    const type = e.target.value;

    if (type === 'expense') {
        modalHeader.classList.remove('income');
        modalHeader.classList.add('expense');
        expenseCategories.style.display = '';
        incomeCategories.style.display = 'none';
    } else {
        modalHeader.classList.remove('expense');
        modalHeader.classList.add('income');
        expenseCategories.style.display = 'none';
        incomeCategories.style.display = '';
    }
});

// Form submission
document.getElementById('recurring-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Get form values
    const frequency = document.getElementById('recurring-frequency').value;
    const day = parseInt(document.getElementById('recurring-day').value);
    const amount = parseFloat(document.getElementById('recurring-amount').value);
    const category_id = document.getElementById('recurring-category').value;

    // Validation
    if (!category_id) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Prepare payload based on frequency
    const payload = {
        type: document.getElementById('recurring-type').value,
        category_id: category_id,
        amount: amount,
        freq: frequency,
        start_date: document.getElementById('recurring-start-date').value,
        remind_days: parseInt(document.getElementById('recurring-reminder').value) || 0,
        note: document.getElementById('recurring-note').value || null
    };

    // Add day_of_month for monthly or day_of_week for weekly
    if (frequency === 'monthly') {
        payload.day_of_month = day;
    } else if (frequency === 'weekly') {
        payload.day_of_week = day;
    }

    try {
        let result;
        if (editingRecurringId) {
            // Update existing recurring rule
            result = await API.put(buildApiUrl('recurring', editingRecurringId), payload);
            showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            // Create new recurring rule
            result = await API.post(buildApiUrl('recurring'), payload);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Reset form and state
        document.getElementById('recurring-form').reset();
        editingRecurringId = null;

        // Reset modal header and button text
        const modalHeader = modal.querySelector('.modal-header h2');
        modalHeader.textContent = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
        const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        closeModal();

        // Reload recurring list
        await loadRecurringRules();

    } catch (error) {
        console.error('Recurring error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// Set default start date to today
document.getElementById('recurring-start-date').valueAsDate = new Date();

// Load recurring rules
async function loadRecurringRules() {
    try {
        const result = await API.get(buildApiUrl('recurring') + '?active_only=true');

        const recurringList = document.querySelector('.recurring-list');

        if (result.recurring_rules && result.recurring_rules.length > 0) {
            renderRecurringRules(result.recurring_rules);
        } else {
            // Show empty state
            recurringList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="calendar-off"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                    <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    } catch (error) {
        console.error('Error loading recurring rules:', error);
    }
}

// Render recurring rules
function renderRecurringRules(rules) {
    const recurringList = document.querySelector('.recurring-list');

    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
    };

    const formatAmount = (amount) => {
        return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const formatFrequency = (freq, dayOfWeek, dayOfMonth) => {
        if (freq === 'daily') return '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô';
        if (freq === 'weekly') {
            const days = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
            return `‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (${days[dayOfWeek]})`;
        }
        if (freq === 'monthly') return `‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayOfMonth})`;
        return freq;
    };

    const renderIcon = (iconName) => {
        const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName || '');
        if (isEmoji || !iconName) {
            return iconName || 'üìÅ';
        } else {
            return `<i data-lucide="${iconName}"></i>`;
        }
    };

    recurringList.innerHTML = rules.map(rule => `
        <div class="recurring-card" data-id="${rule.id}">
            <div class="recurring-icon ${rule.type}">
                ${renderIcon(rule.category?.icon)}
            </div>
            <div class="recurring-info">
                <div class="recurring-title">${rule.category?.name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div class="recurring-meta">
                    <span class="recurring-category">${rule.type === 'expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'}</span>
                    <span class="recurring-freq">${formatFrequency(rule.freq, rule.day_of_week, rule.day_of_month)}</span>
                </div>
                ${rule.next_run_date ? `
                    <div class="recurring-alert">
                        <i data-lucide="bell"></i>
                        ${rule.remind_days > 0 ? `‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ${rule.remind_days} ‡∏ß‡∏±‡∏ô ‚Ä¢ ` : ''}‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${formatDate(rule.next_run_date)}
                    </div>
                ` : ''}
            </div>
            <div class="recurring-amount ${rule.type}">
                ‡∏ø${formatAmount(rule.amount)}
            </div>
            <div class="recurring-actions">
                <button class="btn-icon btn-execute" onclick="executeRecurring('${rule.id}')" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢">
                    <i data-lucide="play"></i>
                </button>
                <button class="btn-icon btn-edit" onclick="editRecurring('${rule.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                    <i data-lucide="edit-2"></i>
                </button>
                <button class="btn-icon btn-delete" onclick="deleteRecurring('${rule.id}')" title="‡∏•‡∏ö">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        </div>
    `).join('');

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// Execute recurring rule now
async function executeRecurring(recurringId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    try {
        await API.post(buildApiUrl('recurring') + `/${recurringId}/execute`, {});
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        await loadRecurringRules();
    } catch (error) {
        showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Edit recurring rule
let editingRecurringId = null;

async function editRecurring(recurringId) {
    try {
        // Fetch recurring rule details
        const result = await API.get(buildApiUrl('recurring', recurringId));
        const rule = result.recurring_rule;

        editingRecurringId = recurringId;

        // Pre-fill form
        document.getElementById('recurring-type').value = rule.type;
        document.getElementById('recurring-category').value = rule.category_id;
        document.getElementById('recurring-frequency').value = rule.freq;
        document.getElementById('recurring-day').value = rule.day_of_month || rule.day_of_week || 1;
        document.getElementById('recurring-start-date').value = rule.start_date;
        document.getElementById('recurring-reminder').value = rule.remind_days || 0;
        document.getElementById('recurring-note').value = rule.note || '';
        document.getElementById('recurring-amount').value = (rule.amount / 100).toFixed(2);

        // Trigger type change to show correct categories
        document.getElementById('recurring-type').dispatchEvent(new Event('change'));

        // Change modal header and button text
        const modalHeader = modal.querySelector('.modal-header h2');
        modalHeader.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';

        const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
        submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';

        openModal();

    } catch (error) {
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

// Delete recurring rule
async function deleteRecurring(recurringId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    try {
        await API.delete(buildApiUrl('recurring') + `/${recurringId}`);
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        await loadRecurringRules();
    } catch (error) {
        showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Load categories for dropdown
async function loadCategories() {
    try {
        const result = await API.get(buildApiUrl('categories'));

        if (result.categories && result.categories.length > 0) {
            const categories = result.categories;

            const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
            const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

            const expenseGroup = document.getElementById('expense-categories');
            const incomeGroup = document.getElementById('income-categories');

            // Helper to get icon display (emoji stays as is, Lucide shows as text for dropdown)
            const getIconDisplay = (icon) => {
                // Check if it's emoji
                const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(icon || '');
                return isEmoji ? icon : 'üìÅ'; // Use folder emoji as fallback for Lucide icons in dropdown
            };

            if (expenseGroup) {
                expenseGroup.innerHTML = expenseCategories.map(cat =>
                    `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                ).join('');
            }

            if (incomeGroup) {
                incomeGroup.innerHTML = incomeCategories.map(cat =>
                    `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                ).join('');
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Load on page ready
document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories();
    await loadRecurringRules();
});
</script>
{% endblock %}
