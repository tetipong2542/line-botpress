{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥ - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container page-loading">
    <!-- App-Title Bar -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="refresh-cw"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥{% if user %} - {{ user.display_name }}{% endif %}
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥</p>
        </div>
    </div>

    <!-- Recurring Stats Cards (Simplified - 3 cards) -->
    <div class="recurring-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i data-lucide="list-checks"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="active-count">0</div>
                <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
        </div>
        
        <div class="stat-card income">
            <div class="stat-icon">
                <i data-lucide="trending-up"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="income-total">‡∏ø0</div>
                <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            </div>
        </div>
        
        <div class="stat-card expense">
            <div class="stat-icon">
                <i data-lucide="trending-down"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="expense-total">‡∏ø0</div>
                <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            </div>
        </div>
    </div>

    <!-- Simple Filter Bar -->
    <div class="section">
        <div class="simple-filter-bar">
            <!-- Search -->
            <div class="filter-search">
                <i data-lucide="search"></i>
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...">
            </div>

            <!-- Sort Options -->
            <div class="filter-sort">
                <button class="sort-btn active" data-sort="next_run_date" onclick="setSortBy('next_run_date')">
                    <i data-lucide="calendar"></i>
                    <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                </button>
                <button class="sort-btn" data-sort="amount" onclick="setSortBy('amount')">
                    <i data-lucide="dollar-sign"></i>
                    <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Recurring List -->
    <div class="section">
        <div class="recurring-list">
            <!-- Empty State (will be replaced by JavaScript when data loads) -->
            <div class="empty-state">
                <i data-lucide="calendar-off"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
            </div>
        </div>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Floating Action Button -->
<div class="floating-action">
    <button class="btn-fab" id="add-recurring-btn">
        <i data-lucide="plus"></i>
    </button>
</div>

<!-- Modal: Add/Edit Recurring Transaction -->
<div class="modal" id="recurring-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="recurring-form">
            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select class="form-select" id="recurring-type">
                    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                </select>
            </div>

            <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="form-select" id="recurring-category">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" id="expense-categories">
                        <option value="food">üçî ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="transport">üöó ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
                        <option value="entertainment">üé¨ ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</option>
                        <option value="utilities">üí° ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
                        <option value="rent">üè† ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                    </optgroup>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" id="income-categories" style="display: none;">
                        <option value="salary">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="bonus">üéÅ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
                        <option value="investment">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</option>
                    </optgroup>
                </select>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                <select class="form-select" id="recurring-frequency">
                    <option value="monthly">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="weekly">‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                    <option value="yearly">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                </select>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" class="form-input" id="recurring-start-date" required>
                <small class="form-hint">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</small>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (Optional) -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <input type="date" class="form-input" id="recurring-end-date">
                <small class="form-hint">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ</small>
            </div>

            <!-- ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Readonly) -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                <input type="text" class="form-input" id="recurring-next-date" readonly value="01/02/2026">
            </div>

            <!-- ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                <select class="form-select" id="recurring-reminder">
                    <option value="0">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
                    <option value="1">1 ‡∏ß‡∏±‡∏ô</option>
                    <option value="3" selected>3 ‡∏ß‡∏±‡∏ô</option>
                    <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
                </select>
            </div>

            <!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
            <div class="form-group">
                <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
                <textarea class="form-textarea" id="recurring-note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ" rows="2"></textarea>
            </div>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin-bottom: 0;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                    <button type="button" class="btn-auto-suggest" onclick="toggleRecurringAmountHint()" title="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">
                        <i data-lucide="sparkles" style="width: 14px; height: 14px;"></i>
                        Auto Suggest
                    </button>
                </div>

                <!-- Smart Amount Hint -->
                <div id="recurring-amount-hint" class="amount-hint" style="display: none;">
                    <i data-lucide="lightbulb"></i>
                    <span id="recurring-amount-hint-text"></span>
                </div>

                <!-- Quick Amount Buttons -->
                <div id="recurring-quick-amount-buttons" class="quick-amount-buttons" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>

                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="recurring-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'recurring' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Book Switcher
const bookPills = document.querySelectorAll('.book-pill');
bookPills.forEach(pill => {
    pill.addEventListener('click', () => {
        bookPills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        // TODO: Load data for selected book
    });
});

// Modal controls
const modal = document.getElementById('recurring-modal');
const addBtn = document.getElementById('add-recurring-btn');
const closeBtn = modal.querySelector('.modal-close');
const overlay = modal.querySelector('.modal-overlay');

function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

addBtn.addEventListener('click', openModal);
closeBtn.addEventListener('click', closeModal);
overlay.addEventListener('click', closeModal);

// Type change - toggle header color and category options
const typeSelect = document.getElementById('recurring-type');
const modalHeader = modal.querySelector('.modal-header');
const expenseCategories = document.getElementById('expense-categories');
const incomeCategories = document.getElementById('income-categories');

typeSelect.addEventListener('change', (e) => {
    const type = e.target.value;

    if (type === 'expense') {
        modalHeader.classList.remove('income');
        modalHeader.classList.add('expense');
        expenseCategories.style.display = '';
        incomeCategories.style.display = 'none';
    } else {
        modalHeader.classList.remove('expense');
        modalHeader.classList.add('income');
        expenseCategories.style.display = 'none';
        incomeCategories.style.display = '';
    }
});

// Calculate and update next run date
function updateNextRunDate() {
    const startDateInput = document.getElementById('recurring-start-date');
    const frequencySelect = document.getElementById('recurring-frequency');
    const nextDateInput = document.getElementById('recurring-next-date');

    const startDate = startDateInput.value;
    const frequency = frequencySelect.value;

    if (!startDate) {
        nextDateInput.value = '-';
        return;
    }

    // Parse start date
    const [year, month, day] = startDate.split('-').map(Number);
    const date = new Date(year, month - 1, day);

    // Calculate next run date based on frequency
    let nextDate = new Date(date);

    if (frequency === 'daily') {
        nextDate.setDate(nextDate.getDate() + 1);
    } else if (frequency === 'weekly') {
        nextDate.setDate(nextDate.getDate() + 7);
    } else if (frequency === 'monthly') {
        // Add 1 month
        let nextMonth = nextDate.getMonth() + 1;
        let nextYear = nextDate.getFullYear();
        if (nextMonth > 11) {
            nextMonth = 0;
            nextYear++;
        }

        // Handle day overflow (e.g., Jan 31 -> Feb 28/29)
        const targetDay = nextDate.getDate();
        nextDate = new Date(nextYear, nextMonth, 1);
        const lastDayOfMonth = new Date(nextYear, nextMonth + 1, 0).getDate();
        nextDate.setDate(Math.min(targetDay, lastDayOfMonth));
    } else if (frequency === 'yearly') {
        nextDate.setFullYear(nextDate.getFullYear() + 1);
    }

    // Format as DD/MM/YYYY
    const nextDay = String(nextDate.getDate()).padStart(2, '0');
    const nextMonth = String(nextDate.getMonth() + 1).padStart(2, '0');
    const nextYear = nextDate.getFullYear();

    nextDateInput.value = `${nextDay}/${nextMonth}/${nextYear}`;
}

// Listen to start date and frequency changes
document.getElementById('recurring-start-date').addEventListener('change', updateNextRunDate);
document.getElementById('recurring-frequency').addEventListener('change', updateNextRunDate);

// Initialize next run date on page load
updateNextRunDate();

// Form submission
document.getElementById('recurring-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Get form values
    const frequency = document.getElementById('recurring-frequency').value;
    const amount = parseFloat(document.getElementById('recurring-amount').value);
    const category_id = document.getElementById('recurring-category').value;
    const start_date = document.getElementById('recurring-start-date').value;
    const end_date = document.getElementById('recurring-end-date').value;

    // Validation
    if (!category_id) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }
    if (!start_date) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
        return;
    }

    // Validate end_date > start_date
    if (end_date && end_date <= start_date) {
        showToast('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Extract day from start_date
    const startDateObj = new Date(start_date);
    const day_of_month = startDateObj.getDate(); // 1-31
    const day_of_week = startDateObj.getDay(); // 0=Sunday, 6=Saturday

    // Prepare payload
    const payload = {
        type: document.getElementById('recurring-type').value,
        category_id: category_id,
        amount: parseFloat(amount), // Backend will convert to satang
        freq: frequency,
        start_date: start_date,
        end_date: end_date || null,
        remind_days: parseInt(document.getElementById('recurring-reminder').value) || 0,
        note: document.getElementById('recurring-note').value || null
    };

    // Add day_of_month for monthly or day_of_week for weekly (from start_date)
    if (frequency === 'monthly') {
        payload.day_of_month = day_of_month;
    } else if (frequency === 'weekly') {
        payload.day_of_week = day_of_week;
    }

    try {
        let result;
        if (editingRecurringId) {
            // Update existing recurring rule
            result = await API.put(buildApiUrl('recurring', editingRecurringId), payload);
            showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            // Create new recurring rule
            result = await API.post(buildApiUrl('recurring'), payload);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Reset form and state
        document.getElementById('recurring-form').reset();
        editingRecurringId = null;

        // Reset modal header and button text
        const modalHeader = modal.querySelector('.modal-header h2');
        modalHeader.textContent = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
        const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        closeModal();

        // Reload recurring list
        await loadRecurringRules();

    } catch (error) {
        console.error('Recurring error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// Set default start date to today
document.getElementById('recurring-start-date').valueAsDate = new Date();

// Load recurring rules
async function loadRecurringRules() {
    try {
        const result = await API.get(buildApiUrl('recurring') + '?active_only=true');

        const recurringList = document.querySelector('.recurring-list');

        if (result.recurring_rules && result.recurring_rules.length > 0) {
            renderRecurringRules(result.recurring_rules);
        } else {
            // Show empty state
            recurringList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="calendar-off"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                    <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    } catch (error) {
        console.error('Error loading recurring rules:', error);
    }
}

// ===== GLOBAL STATE (SIMPLIFIED) =====
let allRecurringRules = [];
let filteredRules = [];
let currentFilter = {
    search: ''
};
let currentSort = 'next_run_date';

// ===== RENDER FUNCTIONS =====
function renderRecurringRules(rules) {
    allRecurringRules = rules;
    
    // Update stats cards
    updateRecurringStats(rules);
    
    // Apply filters and sort
    applyFilters();
}

// ===== STATS CARDS UPDATE =====
function updateRecurringStats(rules) {
    const activeRules = rules.filter(r => r.is_active);
    
    const incomeTotal = activeRules
        .filter(r => r.type === 'income')
        .reduce((sum, r) => sum + r.amount, 0);
    
    const expenseTotal = activeRules
        .filter(r => r.type === 'expense')
        .reduce((sum, r) => sum + r.amount, 0);
    
    const formatAmount = (amount) => {
        return '‡∏ø' + (amount / 100).toLocaleString('th-TH', {minimumFractionDigits: 0});
    };
    
    document.getElementById('active-count').textContent = activeRules.length;
    document.getElementById('income-total').textContent = formatAmount(incomeTotal);
    document.getElementById('expense-total').textContent = formatAmount(expenseTotal);
}

function applyFilters() {
    let filtered = [...allRecurringRules];
    
    // Filter by search
    if (currentFilter.search) {
        const searchLower = currentFilter.search.toLowerCase();
        filtered = filtered.filter(r => 
            (r.category?.name_th || '').toLowerCase().includes(searchLower) ||
            (r.category?.name_en || '').toLowerCase().includes(searchLower) ||
            (r.note || '').toLowerCase().includes(searchLower)
        );
    }
    
    // Apply sort
    filtered = sortRules(filtered, currentSort);
    
    filteredRules = filtered;
    renderCards(filtered);
}

function sortRules(rules, sortBy) {
    const sorted = [...rules];
    
    switch(sortBy) {
        case 'next_run_date':
            sorted.sort((a, b) => {
                const dateA = new Date(a.next_run_date);
                const dateB = new Date(b.next_run_date);
                return dateA - dateB;
            });
            break;
        case 'amount':
            sorted.sort((a, b) => b.amount - a.amount);
            break;
    }
    
    return sorted;
}

function renderCards(rules) {
    const recurringList = document.querySelector('.recurring-list');
    
    if (rules.length === 0) {
        renderEmptyState();
        return;
    }
    
    recurringList.innerHTML = rules.map(rule => renderCard(rule)).join('');
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function renderCard(rule) {
    const formatDate = (dateStr) => {
        // Fix timezone issue by parsing as local date
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day); // month is 0-indexed
        return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
    };
    
    const formatAmount = (amount) => {
        return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 });
    };
    
    const formatFrequency = (freq, dayOfWeek, dayOfMonth) => {
        if (freq === 'daily') return '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
        if (freq === 'weekly') {
            const weekdays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            return `‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (${weekdays[dayOfWeek] || '‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'})`;
        }
        if (freq === 'monthly') return `‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayOfMonth})`;
        if (freq === 'yearly') return '‡∏£‡∏≤‡∏¢‡∏õ‡∏µ';
        return freq;
    };
    
    const renderIcon = (iconName) => {
        if (!iconName) return '<i data-lucide="circle-dashed"></i>';
        const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName);
        if (isEmoji) return iconName;
        return `<i data-lucide="${iconName}"></i>`;
    };
    
    return `
        <div class="recurring-card-v2 ${rule.type}" data-id="${rule.id}">
            <div class="card-header">
                <div class="card-icon ${rule.type}">
                    ${renderIcon(rule.category?.icon)}
                </div>
                <div class="card-title-amount">
                    <div class="card-title">${rule.category?.name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div class="card-amount ${rule.type}">
                        ${rule.type === 'expense' ? '-' : '+'}‡∏ø${formatAmount(rule.amount)}
                    </div>
                </div>
            </div>
            
            <div class="card-details">
                <span class="card-detail-item">
                    ${formatFrequency(rule.freq, rule.day_of_week, rule.day_of_month)}
                </span>
                ${rule.next_run_date ? `
                    <span class="card-detail-item">
                        <i data-lucide="calendar"></i> ${formatDate(rule.next_run_date)}
                    </span>
                ` : ''}
            </div>

            ${rule.note ? `
                <div class="card-note">
                    <i data-lucide="sticky-note"></i>
                    <span>${rule.note}</span>
                </div>
            ` : ''}

            <div class="card-actions">
                <button class="card-action-btn" onclick="editRecurring('${rule.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                    <i data-lucide="edit-2"></i>
                </button>
                <button class="card-action-btn delete" onclick="deleteRecurring('${rule.id}')" title="‡∏•‡∏ö">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        </div>
    `;
}

function renderEmptyState() {
    const recurringList = document.querySelector('.recurring-list');
    const isFiltered = currentFilter.search;
    
    if (isFiltered) {
        recurringList.innerHTML = `
            <div class="empty-state">
                <i data-lucide="search-x"></i>
                <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                <p>‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                <button class="btn-secondary" onclick="clearSearch()">
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
            </div>
        `;
    } else {
        recurringList.innerHTML = `
            <div class="empty-state">
                <i data-lucide="calendar-plus"></i>
                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h3>
                <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                <button class="btn-primary" onclick="openModal()">
                    <i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                </button>
            </div>
        `;
    }
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// ===== FILTER & SORT HANDLERS =====
function setSortBy(sortBy) {
    currentSort = sortBy;
    
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.sort === sortBy);
    });
    
    applyFilters();
}

function clearSearch() {
    document.getElementById('search-input').value = '';
    currentFilter.search = '';
    applyFilters();
}

// Real-time search
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            currentFilter.search = e.target.value;
            applyFilters();
        });
    }
});

// ===== EDIT & DELETE =====
let editingRecurringId = null;

async function editRecurring(recurringId) {
    try {
        // Fetch recurring rule details
        const result = await API.get(buildApiUrl('recurring', recurringId));
        const rule = result.recurring_rule;

        editingRecurringId = recurringId;

        // Pre-fill form
        document.getElementById('recurring-type').value = rule.type;
        document.getElementById('recurring-category').value = rule.category_id;
        document.getElementById('recurring-frequency').value = rule.freq;
        document.getElementById('recurring-start-date').value = rule.start_date;
        document.getElementById('recurring-end-date').value = rule.end_date || '';
        document.getElementById('recurring-reminder').value = rule.remind_days || 0;
        document.getElementById('recurring-note').value = rule.note || '';
        document.getElementById('recurring-amount').value = (rule.amount / 100).toFixed(2);

        // Trigger type change to show correct categories
        document.getElementById('recurring-type').dispatchEvent(new Event('change'));

        // Update next run date based on start_date and frequency
        updateNextRunDate();

        // Change modal header and button text
        const modalHeader = modal.querySelector('.modal-header h2');
        modalHeader.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';

        const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
        submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';

        openModal();

    } catch (error) {
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

// Delete recurring rule
async function deleteRecurring(recurringId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    try {
        await API.delete(buildApiUrl('recurring') + `/${recurringId}`);
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        await loadRecurringRules();
    } catch (error) {
        showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Load categories for dropdown
async function loadCategories() {
    try {
        const result = await API.get(buildApiUrl('categories'));

        if (result.categories && result.categories.length > 0) {
            const categories = result.categories;

            const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
            const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

            const expenseGroup = document.getElementById('expense-categories');
            const incomeGroup = document.getElementById('income-categories');

            // Helper to get icon display (emoji stays as is, Lucide shows as text for dropdown)
            const getIconDisplay = (icon) => {
                // Check if it's emoji
                const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(icon || '');
                return isEmoji ? icon : 'üìÅ'; // Use folder emoji as fallback for Lucide icons in dropdown
            };

            if (expenseGroup) {
                expenseGroup.innerHTML = expenseCategories.map(cat =>
                    `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                ).join('');
            }

            if (incomeGroup) {
                incomeGroup.innerHTML = incomeCategories.map(cat =>
                    `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                ).join('');
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// ===== SMART AMOUNT SUGGESTIONS =====
let recurringAmountSuggestionsCache = {};

async function loadRecurringAmountSuggestions(categoryId, type) {
    const hintEl = document.getElementById('recurring-amount-hint');
    const hintTextEl = document.getElementById('recurring-amount-hint-text');
    const quickButtonsEl = document.getElementById('recurring-quick-amount-buttons');

    // Reset
    hintEl.style.display = 'none';
    quickButtonsEl.style.display = 'none';

    // Check cache
    const cacheKey = categoryId ? `${categoryId}_${type}` : `all_${type}`;
    if (recurringAmountSuggestionsCache[cacheKey]) {
        displayRecurringAmountSuggestions(recurringAmountSuggestionsCache[cacheKey]);
        return;
    }

    try {
        // Build URL with optional category_id
        let url = `analytics/amount-suggestions?type=${type}`;
        if (categoryId) {
            url += `&category_id=${categoryId}`;
        }

        const data = await API.get(buildApiUrl(url));
        recurringAmountSuggestionsCache[cacheKey] = data;
        displayRecurringAmountSuggestions(data);
    } catch (error) {
        console.error('Error loading amount suggestions:', error);
    }
}

function displayRecurringAmountSuggestions(data) {
    const hintEl = document.getElementById('recurring-amount-hint');
    const hintTextEl = document.getElementById('recurring-amount-hint-text');
    const quickButtonsEl = document.getElementById('recurring-quick-amount-buttons');

    // Show hint if available
    if (data.category_hint) {
        hintTextEl.textContent = data.category_hint;
        hintEl.style.display = 'flex';
        lucide.createIcons();
    }

    // Show quick amount buttons
    if (data.suggestions && data.suggestions.quick_amounts_formatted) {
        const amounts = data.suggestions.quick_amounts_formatted;
        quickButtonsEl.innerHTML = amounts.map(amount => `
            <button type="button" class="quick-amount-btn" onclick="setRecurringQuickAmount(${amount})">
                ‡∏ø${amount.toLocaleString('th-TH')}
            </button>
        `).join('');
        quickButtonsEl.style.display = 'flex';
    }
}

function setRecurringQuickAmount(amount) {
    const amountInput = document.getElementById('recurring-amount');
    const currentAmount = parseFloat(amountInput.value) || 0;
    amountInput.value = (currentAmount + amount).toFixed(2);
    // Highlight the button temporarily
    document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function toggleRecurringAmountHint() {
    const hintEl = document.getElementById('recurring-amount-hint');
    const quickButtonsEl = document.getElementById('recurring-quick-amount-buttons');
    const categorySelect = document.getElementById('recurring-category');
    const typeSelect = document.getElementById('recurring-type');

    // Toggle visibility
    const isVisible = hintEl.style.display !== 'none';

    if (isVisible) {
        // Hide if currently visible
        hintEl.style.display = 'none';
        quickButtonsEl.style.display = 'none';
    } else {
        // Show if currently hidden - load suggestions from history
        const categoryId = categorySelect ? categorySelect.value : null;
        const type = typeSelect ? typeSelect.value : 'expense';

        // Load suggestions (with or without category filter)
        loadRecurringAmountSuggestions(categoryId || null, type);
    }
}

// Load on page ready
document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories();
    await loadRecurringRules();

    // Remove loading class and fade in
    const container = document.querySelector('.mobile-container');
    if (container) {
        container.classList.remove('page-loading');
        container.classList.add('fade-in');
    }

    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
