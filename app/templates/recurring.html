{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥ - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container page-loading">
    <!-- App-Title Bar -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="refresh-cw"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥{% if user %} - {{ user.display_name }}{% endif %}
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p>
        </div>
    </div>

    <!-- Tab Switcher -->
    <div class="tab-switcher">
        <button class="tab-btn active" data-tab="recurring" onclick="switchTab('recurring')">
            <i data-lucide="refresh-cw"></i>
            <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</span>
        </button>
        <button class="tab-btn" data-tab="loans" onclick="switchTab('loans')">
            <i data-lucide="credit-card"></i>
            <span>‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠/‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>
        </button>
    </div>

    <!-- ========== TAB: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ========== -->
    <div class="tab-content active" id="tab-recurring">
        <!-- Recurring Stats Cards (Simplified - 3 cards) -->
        <div class="recurring-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i data-lucide="list-checks"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="active-count">0</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
            </div>

            <div class="stat-card income">
                <div class="stat-icon">
                    <i data-lucide="trending-up"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="income-total">‡∏ø0</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
            </div>

            <div class="stat-card expense">
                <div class="stat-icon">
                    <i data-lucide="trending-down"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="expense-total">‡∏ø0</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
            </div>
        </div>

        <!-- Simple Filter Bar -->
        <div class="section">
            <div class="simple-filter-bar">
                <!-- Search -->
                <div class="filter-search">
                    <i data-lucide="search"></i>
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...">
                </div>

                <!-- Sort Options -->
                <div class="filter-sort">
                    <button class="sort-btn active" data-sort="next_run_date" onclick="setSortBy('next_run_date')">
                        <i data-lucide="calendar"></i>
                        <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                    </button>
                    <button class="sort-btn" data-sort="amount" onclick="setSortBy('amount')">
                        <i data-lucide="dollar-sign"></i>
                        <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Recurring List -->
        <div class="section">
            <div class="recurring-list">
                <!-- Empty State (will be replaced by JavaScript when data loads) -->
                <div class="empty-state">
                    <i data-lucide="calendar-off"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                    <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== TAB: ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠/‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ ========== -->
    <div class="tab-content" id="tab-loans">
        <!-- Loan Stats Cards -->
        <div class="recurring-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i data-lucide="file-text"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="loan-count">0</div>
                    <div class="stat-label">‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</div>
                </div>
            </div>

            <div class="stat-card expense">
                <div class="stat-icon">
                    <i data-lucide="wallet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="loan-balance">‡∏ø0</div>
                    <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i data-lucide="calendar-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="loan-next-payment">-</div>
                    <div class="stat-label">‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
                </div>
            </div>
        </div>

        <!-- Loan List -->
        <div class="section">
            <div class="loan-list" id="loan-list">
                <!-- Empty State -->
                <div class="empty-state" id="loan-empty-state">
                    <i data-lucide="credit-card"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p>
                    <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</p>
                    <button class="btn-primary" onclick="openLoanModal()">
                        <i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Floating Action Button -->
<div class="floating-action">
    <button class="btn-fab" id="add-recurring-btn">
        <i data-lucide="plus"></i>
    </button>
</div>

<!-- Confirm Payment Modal -->
<div class="confirm-modal" id="confirm-payment-modal">
    <div class="confirm-overlay"></div>
    <div class="confirm-dialog">
        <div class="confirm-icon">
            <i data-lucide="alert-circle"></i>
        </div>
        <h3 class="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞?</h3>
        <div class="confirm-details" id="confirm-details">
            <!-- Populated by JS -->
        </div>
        <div class="confirm-actions">
            <button class="btn-cancel" id="confirm-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-confirm" id="confirm-proceed">
                <i data-lucide="check"></i>
                <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>
            </button>
        </div>
    </div>
</div>

<!-- Undo Toast -->
<div class="undo-toast" id="undo-toast">
    <div class="undo-content">
        <i data-lucide="check-circle" class="undo-icon"></i>
        <span class="undo-message">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</span>
    </div>
    <button class="undo-btn" id="undo-btn">
        <i data-lucide="undo-2"></i>
        <span>Undo</span>
        <span class="undo-countdown" id="undo-countdown">10</span>
    </button>
    <div class="undo-progress" id="undo-progress"></div>
</div>

<!-- Modal: Add/Edit Recurring Transaction -->
<div class="modal" id="recurring-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="recurring-form">
            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select class="form-select" id="recurring-type">
                    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                </select>
            </div>

            <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="form-select" id="recurring-category">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" id="expense-categories">
                        <option value="food">üçî ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="transport">üöó ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
                        <option value="entertainment">üé¨ ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</option>
                        <option value="utilities">üí° ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
                        <option value="rent">üè† ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                    </optgroup>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" id="income-categories" style="display: none;">
                        <option value="salary">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="bonus">üéÅ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
                        <option value="investment">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</option>
                    </optgroup>
                </select>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                <div class="frequency-input-group">
                    <span class="freq-prefix">‡∏ó‡∏∏‡∏Å‡πÜ</span>
                    <input type="number" class="form-input freq-interval-input" id="recurring-freq-interval" min="1"
                        max="365" value="1">
                    <select class="form-select freq-unit-select" id="recurring-frequency">
                        <option value="daily">‡∏ß‡∏±‡∏ô</option>
                        <option value="weekly">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                        <option value="monthly" selected>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    </select>
                </div>
                <small class="form-hint">‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∏‡∏Å 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏∏‡∏Å 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</small>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" class="form-input" id="recurring-start-date" required>
                <small class="form-hint">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</small>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (Optional) -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <input type="date" class="form-input" id="recurring-end-date">
                <small class="form-hint">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ</small>
            </div>

            <!-- ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Readonly) -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                <input type="text" class="form-input" id="recurring-next-date" readonly value="01/02/2026">
            </div>

            <!-- ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                <select class="form-select" id="recurring-reminder">
                    <option value="0">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
                    <option value="1">1 ‡∏ß‡∏±‡∏ô</option>
                    <option value="3" selected>3 ‡∏ß‡∏±‡∏ô</option>
                    <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
                </select>
            </div>

            <!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
            <div class="form-group">
                <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
                <textarea class="form-textarea" id="recurring-note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ"
                    rows="2"></textarea>
            </div>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin-bottom: 0;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                    <button type="button" class="btn-auto-suggest" onclick="toggleRecurringAmountHint()"
                        title="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">
                        <i data-lucide="sparkles" style="width: 14px; height: 14px;"></i>
                        Auto Suggest
                    </button>
                </div>

                <!-- Smart Amount Hint -->
                <div id="recurring-amount-hint" class="amount-hint" style="display: none;">
                    <i data-lucide="lightbulb"></i>
                    <span id="recurring-amount-hint-text"></span>
                </div>

                <!-- Quick Amount Buttons -->
                <div id="recurring-quick-amount-buttons" class="quick-amount-buttons" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>

                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="recurring-amount" placeholder="0.00"
                        step="0.01" required>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Add/Edit Loan -->
<div class="modal" id="loan-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2 id="loan-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</h2>
            <button class="modal-close" onclick="closeLoanModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="loan-form">
            <input type="hidden" id="loan-edit-id">

            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ -->
            <div class="form-group">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</label>
                <input type="text" class="form-input" id="loan-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô, ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå" required>
            </div>

            <!-- ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="loan-principal" placeholder="500000"
                        required>
                </div>
            </div>

            <!-- ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ -->
            <div class="form-group">
                <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label>
                <input type="number" class="form-input" id="loan-interest-rate" placeholder="3.5" step="0.01" required>
            </div>

            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ -->
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label>
                <select class="form-select" id="loan-interest-type">
                    <option value="reducing">‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏•‡∏î‡∏î‡∏≠‡∏Å (Reducing Balance)</option>
                    <option value="flat">Flat Rate (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</option>
                </select>
            </div>

            <!-- ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                <input type="number" class="form-input" id="loan-term-months" placeholder="60" min="1" max="600"
                    required>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" class="form-input" id="loan-start-date" required>
            </div>

            <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <textarea class="form-textarea" id="loan-note" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" rows="2"></textarea>
            </div>

            <!-- Preview Calculation -->
            <div class="loan-preview" id="loan-preview" style="display: none;">
                <div class="preview-header">
                    <i data-lucide="calculator"></i>
                    <span>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span>
                </div>
                <div class="preview-grid">
                    <div class="preview-item">
                        <span class="preview-label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                        <span class="preview-value" id="preview-monthly">‡∏ø0</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</span>
                        <span class="preview-value" id="preview-interest">‡∏ø0</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <span class="preview-value" id="preview-total">‡∏ø0</span>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span id="loan-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Record Payment -->
<div class="modal" id="payment-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header income">
            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h2>
            <button class="modal-close" onclick="closePaymentModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="payment-form">
            <input type="hidden" id="payment-loan-id">

            <!-- Payment Info -->
            <div class="payment-info" id="payment-info">
                <!-- Populated by JavaScript -->
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞ -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label>
                <input type="date" class="form-input" id="payment-date" required>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</span>
            </button>
        </form>
    </div>
</div>

<!-- Modal: Amortization Schedule -->
<div class="modal" id="schedule-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="schedule-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h2>
            <button class="modal-close" onclick="closeScheduleModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="schedule-summary" id="schedule-summary">
                <!-- Populated by JavaScript -->
            </div>
            <div class="schedule-table-container">
                <table class="schedule-table" id="schedule-table">
                    <thead>
                        <tr>
                            <th>‡∏á‡∏ß‡∏î</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th>
                            <th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th>
                            <th>‡∏£‡∏ß‡∏°</th>
                            <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'recurring' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // Book Switcher
    const bookPills = document.querySelectorAll('.book-pill');
    bookPills.forEach(pill => {
        pill.addEventListener('click', () => {
            bookPills.forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            // TODO: Load data for selected book
        });
    });

    // Modal controls
    const modal = document.getElementById('recurring-modal');
    const addBtn = document.getElementById('add-recurring-btn');
    const closeBtn = modal.querySelector('.modal-close');
    const overlay = modal.querySelector('.modal-overlay');

    function openModal() {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // FAB click handler - opens correct modal based on current tab
    function handleFabClick() {
        if (typeof currentTab !== 'undefined' && currentTab === 'loans') {
            openLoanModal();
        } else {
            openModal();
        }
    }

    addBtn.addEventListener('click', handleFabClick);
    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    // Type change - toggle header color and category options
    const typeSelect = document.getElementById('recurring-type');
    const modalHeader = modal.querySelector('.modal-header');
    const expenseCategories = document.getElementById('expense-categories');
    const incomeCategories = document.getElementById('income-categories');

    typeSelect.addEventListener('change', (e) => {
        const type = e.target.value;

        if (type === 'expense') {
            modalHeader.classList.remove('income');
            modalHeader.classList.add('expense');
            expenseCategories.style.display = '';
            incomeCategories.style.display = 'none';
        } else {
            modalHeader.classList.remove('expense');
            modalHeader.classList.add('income');
            expenseCategories.style.display = 'none';
            incomeCategories.style.display = '';
        }
    });

    // Calculate and update next run date
    function updateNextRunDate() {
        const startDateInput = document.getElementById('recurring-start-date');
        const frequencySelect = document.getElementById('recurring-frequency');
        const nextDateInput = document.getElementById('recurring-next-date');

        const startDate = startDateInput.value;
        const frequency = frequencySelect.value;

        if (!startDate) {
            nextDateInput.value = '-';
            return;
        }

        // Parse start date
        const [year, month, day] = startDate.split('-').map(Number);
        const date = new Date(year, month - 1, day);

        // Calculate next run date based on frequency
        let nextDate = new Date(date);

        if (frequency === 'daily') {
            nextDate.setDate(nextDate.getDate() + 1);
        } else if (frequency === 'weekly') {
            nextDate.setDate(nextDate.getDate() + 7);
        } else if (frequency === 'monthly') {
            // Add 1 month
            let nextMonth = nextDate.getMonth() + 1;
            let nextYear = nextDate.getFullYear();
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }

            // Handle day overflow (e.g., Jan 31 -> Feb 28/29)
            const targetDay = nextDate.getDate();
            nextDate = new Date(nextYear, nextMonth, 1);
            const lastDayOfMonth = new Date(nextYear, nextMonth + 1, 0).getDate();
            nextDate.setDate(Math.min(targetDay, lastDayOfMonth));
        } else if (frequency === 'yearly') {
            nextDate.setFullYear(nextDate.getFullYear() + 1);
        }

        // Format as DD/MM/YYYY
        const nextDay = String(nextDate.getDate()).padStart(2, '0');
        const nextMonth = String(nextDate.getMonth() + 1).padStart(2, '0');
        const nextYear = nextDate.getFullYear();

        nextDateInput.value = `${nextDay}/${nextMonth}/${nextYear}`;
    }

    // Listen to start date and frequency changes
    document.getElementById('recurring-start-date').addEventListener('change', updateNextRunDate);
    document.getElementById('recurring-frequency').addEventListener('change', updateNextRunDate);

    // Initialize next run date on page load
    updateNextRunDate();

    // Form submission
    document.getElementById('recurring-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnContent = submitBtn.innerHTML;

        // Get form values
        const frequency = document.getElementById('recurring-frequency').value;
        const amount = parseFloat(document.getElementById('recurring-amount').value);
        const category_id = document.getElementById('recurring-category').value;
        const start_date = document.getElementById('recurring-start-date').value;
        const end_date = document.getElementById('recurring-end-date').value;

        // Validation
        if (!category_id) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
            return;
        }
        if (!amount || amount <= 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
        }
        if (!start_date) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
            return;
        }

        // Validate end_date > start_date
        if (end_date && end_date <= start_date) {
            showToast('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
            return;
        }

        // Loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
        lucide.createIcons();

        // Extract day from start_date
        const startDateObj = new Date(start_date);
        const day_of_month = startDateObj.getDate(); // 1-31
        const day_of_week = startDateObj.getDay(); // 0=Sunday, 6=Saturday

        // Prepare payload
        const freqInterval = parseInt(document.getElementById('recurring-freq-interval').value) || 1;
        const payload = {
            type: document.getElementById('recurring-type').value,
            category_id: category_id,
            amount: parseFloat(amount), // Backend will convert to satang
            freq: frequency,
            freq_interval: freqInterval,
            start_date: start_date,
            end_date: end_date || null,
            remind_days: parseInt(document.getElementById('recurring-reminder').value) || 0,
            note: document.getElementById('recurring-note').value || null
        };

        // Add day_of_month for monthly or day_of_week for weekly (from start_date)
        if (frequency === 'monthly') {
            payload.day_of_month = day_of_month;
        } else if (frequency === 'weekly') {
            payload.day_of_week = day_of_week;
        }

        try {
            let result;
            if (editingRecurringId) {
                // Update existing recurring rule
                result = await API.put(buildApiUrl('recurring', editingRecurringId), payload);
                showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
                // Create new recurring rule
                result = await API.post(buildApiUrl('recurring'), payload);
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }

            // Reset form and state
            document.getElementById('recurring-form').reset();
            editingRecurringId = null;

            // Reset modal header and button text
            const modalHeader = modal.querySelector('.modal-header h2');
            modalHeader.textContent = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
            const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
            submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

            closeModal();

            // Reload recurring list
            await loadRecurringRules();

        } catch (error) {
            console.error('Recurring error:', error);
            showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnContent;
            lucide.createIcons();
        }
    });

    // Set default start date to today
    document.getElementById('recurring-start-date').valueAsDate = new Date();

    // Load recurring rules
    async function loadRecurringRules() {
        try {
            const result = await API.get(buildApiUrl('recurring') + '?active_only=true');
            const recurringList = document.querySelector('.recurring-list');

            if (result.recurring_rules && result.recurring_rules.length > 0) {
                renderRecurringRules(result.recurring_rules);
            } else {
                // Show empty state
                recurringList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="calendar-off"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                    <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
            `;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        } catch (error) {
            console.error('Error loading recurring rules:', error);
        }
    }

    // ===== GLOBAL STATE (SIMPLIFIED) =====
    let allRecurringRules = [];
    let filteredRules = [];
    let currentFilter = {
        search: ''
    };
    let currentSort = 'next_run_date';

    // ===== RENDER FUNCTIONS =====
    function renderRecurringRules(rules) {
        allRecurringRules = rules;

        // Update stats cards
        updateRecurringStats(rules);

        // Apply filters and sort
        applyFilters();
    }

    // ===== STATS CARDS UPDATE =====
    function updateRecurringStats(rules) {
        const activeRules = rules.filter(r => r.is_active);

        const incomeTotal = activeRules
            .filter(r => r.type === 'income')
            .reduce((sum, r) => sum + r.amount, 0);

        const expenseTotal = activeRules
            .filter(r => r.type === 'expense')
            .reduce((sum, r) => sum + r.amount, 0);

        const formatAmount = (amount) => {
            return '‡∏ø' + (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 });
        };

        document.getElementById('active-count').textContent = activeRules.length;
        document.getElementById('income-total').textContent = formatAmount(incomeTotal);
        document.getElementById('expense-total').textContent = formatAmount(expenseTotal);
    }

    function applyFilters() {
        let filtered = [...allRecurringRules];

        // Filter by search
        if (currentFilter.search) {
            const searchLower = currentFilter.search.toLowerCase();
            filtered = filtered.filter(r =>
                (r.category?.name_th || '').toLowerCase().includes(searchLower) ||
                (r.category?.name_en || '').toLowerCase().includes(searchLower) ||
                (r.note || '').toLowerCase().includes(searchLower)
            );
        }

        // Apply sort
        filtered = sortRules(filtered, currentSort);

        filteredRules = filtered;
        renderCards(filtered);
    }

    function sortRules(rules, sortBy) {
        const sorted = [...rules];

        switch (sortBy) {
            case 'next_run_date':
                sorted.sort((a, b) => {
                    const dateA = new Date(a.next_run_date);
                    const dateB = new Date(b.next_run_date);
                    return dateA - dateB;
                });
                break;
            case 'amount':
                sorted.sort((a, b) => b.amount - a.amount);
                break;
        }

        return sorted;
    }

    function renderCards(rules) {
        const recurringList = document.querySelector('.recurring-list');

        if (rules.length === 0) {
            renderEmptyState();
            return;
        }

        recurringList.innerHTML = rules.map(rule => renderCard(rule)).join('');

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function renderCard(rule) {
        const formatDate = (dateStr) => {
            // Fix timezone issue by parsing as local date
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day); // month is 0-indexed
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        };

        const formatAmount = (amount) => {
            return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 });
        };

        const formatFrequency = (freq, dayOfWeek, dayOfMonth) => {
            if (freq === 'daily') return '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
            if (freq === 'weekly') {
                const weekdays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
                return `‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (${weekdays[dayOfWeek] || '‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'})`;
            }
            if (freq === 'monthly') return `‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayOfMonth})`;
            if (freq === 'yearly') return '‡∏£‡∏≤‡∏¢‡∏õ‡∏µ';
            return freq;
        };

        const renderIcon = (iconName) => {
            if (!iconName) return '<i data-lucide="circle-dashed"></i>';
            const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName);
            if (isEmoji) return iconName;
            return `<i data-lucide="${iconName}"></i>`;
        };

        return `
        <div class="recurring-card-v2 ${rule.type}" data-id="${rule.id}">
            <div class="card-header">
                <div class="card-icon ${rule.type}">
                    ${renderIcon(rule.category?.icon)}
                </div>
                <div class="card-title-amount">
                    <div class="card-title">${rule.category?.name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div class="card-amount ${rule.type}">
                        ${rule.type === 'expense' ? '-' : '+'}‡∏ø${formatAmount(rule.amount)}
                    </div>
                </div>
            </div>
            
            <div class="card-details">
                <span class="card-detail-item">
                    ${formatFrequency(rule.freq, rule.day_of_week, rule.day_of_month)}
                </span>
                ${rule.next_run_date ? `
                    <span class="card-detail-item">
                        <i data-lucide="calendar"></i> ${formatDate(rule.next_run_date)}
                    </span>
                ` : ''}
            </div>

            ${rule.note ? `
                <div class="card-note">
                    <i data-lucide="sticky-note"></i>
                    <span>${rule.note}</span>
                </div>
            ` : ''}

            <div class="card-actions">
                <button class="btn-mark ${rule.is_paid_this_period ? 'marked' : ''}" 
                        onclick="markRecurringPaid('${rule.id}', event)" 
                        title="${rule.is_paid_this_period ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ' : '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ'}"
                        ${rule.is_paid_this_period ? 'disabled' : ''}>
                    <i data-lucide="${rule.is_paid_this_period ? 'check-circle' : 'check'}"></i>
                    <span>${rule.is_paid_this_period ? '‚úì ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}</span>
                </button>
                ${rule.is_paid_this_period ? `
                    <button class="btn-cancel-payment" 
                            onclick="cancelRecurringPayment('${rule.id}', event)" 
                            title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ">
                        <i data-lucide="x-circle"></i>
                        <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                    </button>
                ` : ''}
                <button class="card-action-btn" onclick="editRecurring('${rule.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                    <i data-lucide="edit-2"></i>
                </button>
                <button class="card-action-btn delete" onclick="deleteRecurring('${rule.id}')" title="‡∏•‡∏ö">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        </div>
    `;
    }

    function renderEmptyState() {
        const recurringList = document.querySelector('.recurring-list');
        const isFiltered = currentFilter.search;

        if (isFiltered) {
            recurringList.innerHTML = `
            <div class="empty-state">
                <i data-lucide="search-x"></i>
                <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                <p>‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                <button class="btn-secondary" onclick="clearSearch()">
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
            </div>
        `;
        } else {
            recurringList.innerHTML = `
            <div class="empty-state">
                <i data-lucide="calendar-plus"></i>
                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h3>
                <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                <button class="btn-primary" onclick="openModal()">
                    <i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                </button>
            </div>
        `;
        }

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // ===== FILTER & SORT HANDLERS =====
    function setSortBy(sortBy) {
        currentSort = sortBy;

        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.sort === sortBy);
        });

        applyFilters();
    }

    function clearSearch() {
        document.getElementById('search-input').value = '';
        currentFilter.search = '';
        applyFilters();
    }

    // Real-time search
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                currentFilter.search = e.target.value;
                applyFilters();
            });
        }
    });

    // ===== EDIT & DELETE =====
    let editingRecurringId = null;

    async function editRecurring(recurringId) {
        try {
            // Fetch recurring rule details
            const result = await API.get(buildApiUrl('recurring', recurringId));
            const rule = result.recurring_rule;

            editingRecurringId = recurringId;

            // Pre-fill form
            document.getElementById('recurring-type').value = rule.type;
            document.getElementById('recurring-category').value = rule.category_id;
            document.getElementById('recurring-frequency').value = rule.freq;
            document.getElementById('recurring-freq-interval').value = rule.freq_interval || 1;
            document.getElementById('recurring-start-date').value = rule.start_date;
            document.getElementById('recurring-end-date').value = rule.end_date || '';
            document.getElementById('recurring-reminder').value = rule.remind_days || 0;
            document.getElementById('recurring-note').value = rule.note || '';
            document.getElementById('recurring-amount').value = (rule.amount / 100).toFixed(2);

            // Trigger type change to show correct categories
            document.getElementById('recurring-type').dispatchEvent(new Event('change'));

            // Update next run date based on start_date and frequency
            updateNextRunDate();

            // Change modal header and button text
            const modalHeader = modal.querySelector('.modal-header h2');
            modalHeader.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';

            const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';

            openModal();

        } catch (error) {
            showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    }

    // Delete recurring rule
    async function deleteRecurring(recurringId) {
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }

        try {
            await API.delete(buildApiUrl('recurring') + `/${recurringId}`);
            showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            await loadRecurringRules();
        } catch (error) {
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    }

    // Mark recurring as paid for this month (creates a transaction)
    async function markRecurringPaid(recurringId, event) {
        event.stopPropagation();

        const rule = allRecurringRules.find(r => r.id === recurringId);
        if (!rule) return;

        // Check if already paid
        if (rule.is_paid_this_period) {
            showToast('‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ', 'info');
            return;
        }

        // Show confirm dialog
        showConfirmDialog(rule, async () => {
            await executeMarkPaid(rule);
        });
    }

    // Show confirm dialog before payment
    function showConfirmDialog(rule, onConfirm) {
        const modal = document.getElementById('confirm-payment-modal');
        const details = document.getElementById('confirm-details');
        const cancelBtn = document.getElementById('confirm-cancel');
        const confirmBtn = document.getElementById('confirm-proceed');

        // Populate details
        const amount = (rule.amount / 100).toLocaleString('th-TH');
        const categoryName = rule.category?.name_th || rule.category?.name || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
        details.innerHTML = `
            <div class="confirm-amount">‡∏ø${amount}</div>
            <div class="confirm-category">${categoryName}</div>
            ${rule.note ? `<div class="confirm-note">${rule.note}</div>` : ''}
        `;

        // Show modal
        modal.classList.add('show');
        lucide.createIcons();

        // Cancel handler
        const handleCancel = () => {
            modal.classList.remove('show');
            cancelBtn.removeEventListener('click', handleCancel);
            confirmBtn.removeEventListener('click', handleConfirm);
        };

        // Confirm handler
        const handleConfirm = () => {
            modal.classList.remove('show');
            cancelBtn.removeEventListener('click', handleCancel);
            confirmBtn.removeEventListener('click', handleConfirm);
            onConfirm();
        };

        cancelBtn.addEventListener('click', handleCancel);
        confirmBtn.addEventListener('click', handleConfirm);
    }

    // Execute the actual payment mark
    let lastPaymentData = null;
    let undoTimeout = null;

    async function executeMarkPaid(rule) {
        try {
            // Call mark-paid API
            await API.post(buildApiUrl(`recurring/${rule.id}/mark-paid`));

            // Create transaction
            const today = new Date();
            const transactionData = {
                amount: rule.amount,
                type: rule.type,
                category_id: rule.category_id,
                note: `${rule.note || rule.category?.name || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥'} (‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥)`,
                transaction_date: today.toISOString().split('T')[0]
            };
            const transactionResult = await API.post(buildApiUrl('transactions'), transactionData);

            // Store for undo
            lastPaymentData = {
                ruleId: rule.id,
                transactionId: transactionResult.transaction?.id
            };

            // Show undo toast
            showUndoToast(async () => {
                // Undo action - delete transaction if exists
                if (lastPaymentData?.transactionId) {
                    try {
                        await API.delete(buildApiUrl(`transactions/${lastPaymentData.transactionId}`));
                        showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadRecurringRules();
                    } catch (e) {
                        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ', 'error');
                    }
                }
            });

            // Reload to show updated state
            await loadRecurringRules();

        } catch (error) {
            console.error('Mark paid error:', error);
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    }

    // Show undo toast with countdown
    function showUndoToast(onUndo) {
        const toast = document.getElementById('undo-toast');
        const undoBtn = document.getElementById('undo-btn');
        const countdown = document.getElementById('undo-countdown');
        const progress = document.getElementById('undo-progress');

        let timeLeft = 10;

        // Clear any existing timeout
        if (undoTimeout) {
            clearTimeout(undoTimeout);
        }

        // Show toast
        toast.classList.add('show');
        countdown.textContent = timeLeft;
        progress.style.width = '100%';
        lucide.createIcons();

        // Update progress
        const interval = setInterval(() => {
            timeLeft--;
            countdown.textContent = timeLeft;
            progress.style.width = `${(timeLeft / 10) * 100}%`;

            if (timeLeft <= 0) {
                clearInterval(interval);
                hideUndoToast();
            }
        }, 1000);

        // Undo handler
        const handleUndo = () => {
            clearInterval(interval);
            hideUndoToast();
            onUndo();
            undoBtn.removeEventListener('click', handleUndo);
        };

        undoBtn.addEventListener('click', handleUndo);

        // Auto hide after timeout
        undoTimeout = setTimeout(() => {
            clearInterval(interval);
            hideUndoToast();
            undoBtn.removeEventListener('click', handleUndo);
        }, 10000);
    }

    function hideUndoToast() {
        document.getElementById('undo-toast').classList.remove('show');
    }

    // Cancel recurring payment (reset paid status for this period)
    async function cancelRecurringPayment(recurringId, event) {
        event.stopPropagation();

        const rule = allRecurringRules.find(r => r.id === recurringId);
        if (!rule) return;

        // Show confirm before cancel
        const confirmed = confirm(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ "${rule.category?.name_th || rule.note || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥'}" ‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ?

‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏•‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Transactions`);

        if (!confirmed) return;

        const btn = event.target.closest('.btn-cancel-payment');
        const originalContent = btn.innerHTML;

        try {
            btn.innerHTML = '<i data-lucide="loader" class="spinning"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // Call cancel API
            await API.post(buildApiUrl(`recurring/${recurringId}/cancel-payment`));

            showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

            // Reload to show updated state
            await loadRecurringRules();

        } catch (error) {
            console.error('Cancel payment error:', error);
            showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            btn.innerHTML = originalContent;
            btn.disabled = false;
            lucide.createIcons();
        }
    }


    // Load categories for dropdown
    async function loadCategories() {
        try {
            const result = await API.get(buildApiUrl('categories'));

            if (result.categories && result.categories.length > 0) {
                const categories = result.categories;

                const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
                const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

                const expenseGroup = document.getElementById('expense-categories');
                const incomeGroup = document.getElementById('income-categories');

                // Helper to get icon display (emoji stays as is, Lucide shows as text for dropdown)
                const getIconDisplay = (icon) => {
                    // Check if it's emoji
                    const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(icon || '');
                    return isEmoji ? icon : 'üìÅ'; // Use folder emoji as fallback for Lucide icons in dropdown
                };

                if (expenseGroup) {
                    expenseGroup.innerHTML = expenseCategories.map(cat =>
                        `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                    ).join('');
                }

                if (incomeGroup) {
                    incomeGroup.innerHTML = incomeCategories.map(cat =>
                        `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                    ).join('');
                }
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // ===== SMART AMOUNT SUGGESTIONS =====
    let recurringAmountSuggestionsCache = {};

    async function loadRecurringAmountSuggestions(categoryId, type) {
        const hintEl = document.getElementById('recurring-amount-hint');
        const hintTextEl = document.getElementById('recurring-amount-hint-text');
        const quickButtonsEl = document.getElementById('recurring-quick-amount-buttons');

        // Reset
        hintEl.style.display = 'none';
        quickButtonsEl.style.display = 'none';

        // Check cache
        const cacheKey = categoryId ? `${categoryId}_${type}` : `all_${type}`;
        if (recurringAmountSuggestionsCache[cacheKey]) {
            displayRecurringAmountSuggestions(recurringAmountSuggestionsCache[cacheKey]);
            return;
        }

        try {
            // Build URL with optional category_id
            let url = `analytics/amount-suggestions?type=${type}`;
            if (categoryId) {
                url += `&category_id=${categoryId}`;
            }

            const data = await API.get(buildApiUrl(url));
            recurringAmountSuggestionsCache[cacheKey] = data;
            displayRecurringAmountSuggestions(data);
        } catch (error) {
            console.error('Error loading amount suggestions:', error);
        }
    }

    function displayRecurringAmountSuggestions(data) {
        const hintEl = document.getElementById('recurring-amount-hint');
        const hintTextEl = document.getElementById('recurring-amount-hint-text');
        const quickButtonsEl = document.getElementById('recurring-quick-amount-buttons');

        // Show hint if available
        if (data.category_hint) {
            hintTextEl.textContent = data.category_hint;
            hintEl.style.display = 'flex';
            lucide.createIcons();
        }

        // Show quick amount buttons
        if (data.suggestions && data.suggestions.quick_amounts_formatted) {
            const amounts = data.suggestions.quick_amounts_formatted;
            quickButtonsEl.innerHTML = amounts.map(amount => `
            <button type="button" class="quick-amount-btn" onclick="setRecurringQuickAmount(${amount})">
                ‡∏ø${amount.toLocaleString('th-TH')}
            </button>
        `).join('');
            quickButtonsEl.style.display = 'flex';
        }
    }

    function setRecurringQuickAmount(amount) {
        const amountInput = document.getElementById('recurring-amount');
        const currentAmount = parseFloat(amountInput.value) || 0;
        amountInput.value = (currentAmount + amount).toFixed(2);
        // Highlight the button temporarily
        document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function toggleRecurringAmountHint() {
        const hintEl = document.getElementById('recurring-amount-hint');
        const quickButtonsEl = document.getElementById('recurring-quick-amount-buttons');
        const categorySelect = document.getElementById('recurring-category');
        const typeSelect = document.getElementById('recurring-type');

        // Toggle visibility
        const isVisible = hintEl.style.display !== 'none';

        if (isVisible) {
            // Hide if currently visible
            hintEl.style.display = 'none';
            quickButtonsEl.style.display = 'none';
        } else {
            // Show if currently hidden - load suggestions from history
            const categoryId = categorySelect ? categorySelect.value : null;
            const type = typeSelect ? typeSelect.value : 'expense';

            // Load suggestions (with or without category filter)
            loadRecurringAmountSuggestions(categoryId || null, type);
        }
    }

    // ============================================================================
    // TAB SWITCHER
    // ============================================================================

    let currentTab = 'recurring';

    function switchTab(tabName) {
        currentTab = tabName;

        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });

        // Update tab content - use 'active' class (CSS pattern)
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `tab-${tabName}`);
        });

        // FAB behavior is now handled by handleFabClick function
        // which checks currentTab value

        // Load data for the tab
        if (tabName === 'loans') {
            loadLoans();
        }

        // Re-initialize icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Check URL param and update
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.replaceState({}, '', url);
    }

    // ============================================================================
    // LOAN MANAGEMENT
    // ============================================================================

    let loansData = [];
    const projectId = '{{ project.id if project else "" }}';

    async function loadLoans() {
        if (!projectId) return;

        try {
            const response = await fetch(`/api/v1/projects/${projectId}/loans`);
            if (!response.ok) throw new Error('Failed to load loans');

            const data = await response.json();
            loansData = data.loans || [];

            renderLoans();
            updateLoanStats();

        } catch (error) {
            console.error('Error loading loans:', error);
        }
    }

    function updateLoanStats() {
        let totalBalance = 0;
        let nextPayment = null;

        loansData.forEach(loan => {
            if (loan.is_active && !loan.is_completed) {
                totalBalance += loan.remaining_balance;
                if (loan.next_payment_date && (!nextPayment || loan.next_payment_date < nextPayment.date)) {
                    nextPayment = {
                        date: loan.next_payment_date,
                        amount: loan.monthly_payment_formatted,
                        name: loan.name
                    };
                }
            }
        });

        document.getElementById('loan-count').textContent = loansData.filter(l => l.is_active && !l.is_completed).length;
        document.getElementById('loan-balance').textContent = `‡∏ø${(totalBalance / 100).toLocaleString()}`;

        if (nextPayment) {
            const date = new Date(nextPayment.date);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'short' });
            document.getElementById('loan-next-payment').textContent = `${day} ${month}`;
        } else {
            document.getElementById('loan-next-payment').textContent = '-';
        }
    }

    function renderLoans() {
        const container = document.getElementById('loan-list');
        const emptyState = document.getElementById('loan-empty-state');

        const activeLoans = loansData.filter(l => l.is_active);

        if (activeLoans.length === 0) {
            container.innerHTML = '';
            container.appendChild(emptyState.cloneNode(true));
            if (typeof lucide !== 'undefined') lucide.createIcons();
            return;
        }

        container.innerHTML = activeLoans.map(loan => `
            <div class="loan-card ${loan.is_completed ? 'completed' : ''}" data-id="${loan.id}">
                <div class="loan-card-header">
                    <div class="loan-info">
                        <h3 class="loan-name">${loan.name}</h3>
                        <span class="loan-type-badge">${loan.interest_type_label}</span>
                    </div>
                    <div class="loan-actions">
                        <button class="action-btn" onclick="showLoanMenu('${loan.id}')" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
                            <i data-lucide="more-vertical"></i>
                        </button>
                    </div>
                </div>
                
                <div class="loan-card-body">
                    <div class="loan-progress-section">
                        <div class="loan-progress-ring">
                            <svg viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                <path class="circle" stroke-dasharray="${loan.progress_percentage}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            </svg>
                            <span class="progress-text">${Math.round(loan.progress_percentage)}%</span>
                        </div>
                        <div class="loan-progress-info">
                            <div class="progress-item">
                                <span class="label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>
                                <span class="value">${loan.paid_installments}/${loan.term_months} ‡∏á‡∏ß‡∏î</span>
                            </div>
                            <div class="progress-item">
                                <span class="label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                                <span class="value expense-text">‡∏ø${loan.remaining_balance_formatted.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loan-details">
                        <div class="detail-item">
                            <span class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                            <span class="value">‡∏ø${loan.monthly_payment_formatted.toLocaleString()}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span>
                            <span class="value">${loan.interest_rate}% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</span>
                        </div>
                        ${!loan.is_completed && loan.next_payment_date ? `
                        <div class="detail-item next-payment">
                            <span class="label">‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                            <span class="value">${formatThaiDate(loan.next_payment_date)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${!loan.is_completed ? `
                <div class="loan-card-footer">
                    <button class="btn-secondary" onclick="openScheduleModal('${loan.id}')">
                        <i data-lucide="table"></i> ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    </button>
                    <button class="btn-primary" onclick="openPaymentModal('${loan.id}')">
                        <i data-lucide="check-circle"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î
                    </button>
                </div>
                ` : `
                <div class="loan-card-footer completed">
                    <span class="completed-badge"><i data-lucide="check-circle"></i> ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                `}
            </div>
        `).join('');

        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function formatThaiDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
    }

    // ============================================================================
    // LOAN MODAL
    // ============================================================================

    const loanModal = document.getElementById('loan-modal');
    const loanForm = document.getElementById('loan-form');

    function openLoanModal(loanId = null) {
        const title = document.getElementById('loan-modal-title');
        const submitText = document.getElementById('loan-submit-text');

        // Reset form
        loanForm.reset();
        document.getElementById('loan-edit-id').value = '';
        document.getElementById('loan-preview').style.display = 'none';

        // Set default date to today
        document.getElementById('loan-start-date').value = new Date().toISOString().split('T')[0];

        if (loanId) {
            // Edit mode
            const loan = loansData.find(l => l.id === loanId);
            if (loan) {
                title.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠';
                submitText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                document.getElementById('loan-edit-id').value = loanId;
                document.getElementById('loan-name').value = loan.name;
                document.getElementById('loan-principal').value = loan.principal / 100;
                document.getElementById('loan-interest-rate').value = loan.interest_rate;
                document.getElementById('loan-interest-type').value = loan.interest_type;
                document.getElementById('loan-term-months').value = loan.term_months;
                document.getElementById('loan-start-date').value = loan.start_date;
                document.getElementById('loan-note').value = loan.note || '';

                // Show preview
                calculateLoanPreview();
            }
        } else {
            // Add mode
            title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠';
            submitText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }

        loanModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeLoanModal() {
        loanModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Calculate preview when inputs change
    ['loan-principal', 'loan-interest-rate', 'loan-term-months', 'loan-interest-type'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', calculateLoanPreview);
            el.addEventListener('change', calculateLoanPreview);
        }
    });

    async function calculateLoanPreview() {
        const principal = parseFloat(document.getElementById('loan-principal').value) || 0;
        const interestRate = parseFloat(document.getElementById('loan-interest-rate').value) || 0;
        const termMonths = parseInt(document.getElementById('loan-term-months').value) || 0;
        const interestType = document.getElementById('loan-interest-type').value;

        if (principal <= 0 || termMonths <= 0) {
            document.getElementById('loan-preview').style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/v1/projects/${projectId}/loans/calculate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ principal, interest_rate: interestRate, term_months: termMonths, interest_type: interestType })
            });

            if (response.ok) {
                const data = await response.json();
                const calc = data.calculation;

                document.getElementById('preview-monthly').textContent = `‡∏ø${calc.monthly_payment_formatted.toLocaleString()}`;
                document.getElementById('preview-interest').textContent = `‡∏ø${calc.total_interest_formatted.toLocaleString()}`;
                document.getElementById('preview-total').textContent = `‡∏ø${calc.total_amount_formatted.toLocaleString()}`;
                document.getElementById('loan-preview').style.display = 'block';
            }
        } catch (error) {
            console.error('Error calculating loan:', error);
        }
    }

    loanForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const editId = document.getElementById('loan-edit-id').value;
        const loanData = {
            name: document.getElementById('loan-name').value,
            principal: parseFloat(document.getElementById('loan-principal').value),
            interest_rate: parseFloat(document.getElementById('loan-interest-rate').value),
            interest_type: document.getElementById('loan-interest-type').value,
            term_months: parseInt(document.getElementById('loan-term-months').value),
            start_date: document.getElementById('loan-start-date').value,
            note: document.getElementById('loan-note').value
        };

        try {
            const url = editId
                ? `/api/v1/projects/${projectId}/loans/${editId}`
                : `/api/v1/projects/${projectId}/loans`;

            const response = await fetch(url, {
                method: editId ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loanData)
            });

            if (response.ok) {
                closeLoanModal();
                await loadLoans();
                showToast(editId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                const error = await response.json();
                showToast(error.error?.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        } catch (error) {
            console.error('Error saving loan:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    });

    // ============================================================================
    // PAYMENT MODAL
    // ============================================================================

    const paymentModal = document.getElementById('payment-modal');
    const paymentForm = document.getElementById('payment-form');
    let currentPaymentLoan = null;

    async function openPaymentModal(loanId) {
        currentPaymentLoan = loansData.find(l => l.id === loanId);
        if (!currentPaymentLoan) return;

        document.getElementById('payment-loan-id').value = loanId;
        document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];

        // Fetch schedule to get current installment info
        try {
            const response = await fetch(`/api/v1/projects/${projectId}/loans/${loanId}/schedule`);
            if (response.ok) {
                const data = await response.json();
                const nextInstallment = data.schedule.find(s => !s.is_paid);

                if (nextInstallment) {
                    document.getElementById('payment-info').innerHTML = `
                        <div class="payment-info-card">
                            <h4>${currentPaymentLoan.name}</h4>
                            <div class="payment-details">
                                <div class="detail-row">
                                    <span>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</span>
                                    <span>${nextInstallment.installment} / ${currentPaymentLoan.term_months}</span>
                                </div>
                                <div class="detail-row">
                                    <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</span>
                                    <span>‡∏ø${nextInstallment.principal_formatted.toLocaleString()}</span>
                                </div>
                                <div class="detail-row">
                                    <span>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span>
                                    <span>‡∏ø${nextInstallment.interest_formatted.toLocaleString()}</span>
                                </div>
                                <div class="detail-row total">
                                    <span>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span>
                                    <span>‡∏ø${nextInstallment.total_formatted.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading payment info:', error);
        }

        paymentModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closePaymentModal() {
        paymentModal.classList.remove('active');
        document.body.style.overflow = '';
        currentPaymentLoan = null;
    }

    paymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const loanId = document.getElementById('payment-loan-id').value;
        const paymentDate = document.getElementById('payment-date').value;

        try {
            const response = await fetch(`/api/v1/projects/${projectId}/loans/${loanId}/pay`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payment_date: paymentDate })
            });

            if (response.ok) {
                closePaymentModal();
                await loadLoans();
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                const error = await response.json();
                showToast(error.error?.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        } catch (error) {
            console.error('Error recording payment:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    });

    // ============================================================================
    // SCHEDULE MODAL
    // ============================================================================

    const scheduleModal = document.getElementById('schedule-modal');

    async function openScheduleModal(loanId) {
        const loan = loansData.find(l => l.id === loanId);
        if (!loan) return;

        document.getElementById('schedule-title').textContent = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ - ${loan.name}`;

        try {
            const response = await fetch(`/api/v1/projects/${projectId}/loans/${loanId}/schedule`);
            if (response.ok) {
                const data = await response.json();

                // Summary
                document.getElementById('schedule-summary').innerHTML = `
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</span>
                            <span class="value">‡∏ø${(data.summary.principal / 100).toLocaleString()}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</span>
                            <span class="value">‡∏ø${(data.summary.total_interest / 100).toLocaleString()}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                            <span class="value">‡∏ø${(data.summary.total_amount / 100).toLocaleString()}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î</span>
                            <span class="value">‡∏ø${(data.summary.monthly_payment / 100).toLocaleString()}</span>
                        </div>
                    </div>
                `;

                // Table
                document.getElementById('schedule-body').innerHTML = data.schedule.map(row => `
                    <tr class="${row.is_paid ? 'paid' : ''}">
                        <td>${row.installment}</td>
                        <td>${formatThaiDate(row.payment_date)}</td>
                        <td>‡∏ø${row.principal_formatted.toLocaleString()}</td>
                        <td>‡∏ø${row.interest_formatted.toLocaleString()}</td>
                        <td>‡∏ø${row.total_formatted.toLocaleString()}</td>
                        <td>‡∏ø${row.remaining_balance_formatted.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading schedule:', error);
        }

        scheduleModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeScheduleModal() {
        scheduleModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // ============================================================================
    // LOAN ACTIONS MENU
    // ============================================================================

    function showLoanMenu(loanId) {
        const loan = loansData.find(l => l.id === loanId);
        if (!loan) return;

        // Simple menu using confirm/prompt
        const action = prompt(
            `${loan.name}\n\n` +
            `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:\n` +
            `1 = ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠\n` +
            `2 = ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠\n` +
            `\n‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î OK`
        );

        if (action === '1') {
            openLoanModal(loanId);
        } else if (action === '2') {
            deleteLoan(loanId);
        }
    }

    async function deleteLoan(loanId) {
        const loan = loansData.find(l => l.id === loanId);
        if (!loan) return;

        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${loan.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

        try {
            const response = await fetch(`/api/v1/projects/${projectId}/loans/${loanId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                await loadLoans();
                showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                const error = await response.json();
                showToast(error.error?.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        } catch (error) {
            console.error('Error deleting loan:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    }

    // Toast notification
    function showToast(message, type = 'info') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);

        if (typeof lucide !== 'undefined') lucide.createIcons();

        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Set up modal overlay clicks
    loanModal.querySelector('.modal-overlay').addEventListener('click', closeLoanModal);
    paymentModal.querySelector('.modal-overlay').addEventListener('click', closePaymentModal);
    scheduleModal.querySelector('.modal-overlay').addEventListener('click', closeScheduleModal);

    // Load on page ready
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCategories();
        await loadRecurringRules();

        // Check URL param for tab
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        if (tabParam === 'loans') {
            switchTab('loans');
        }

        // Remove loading class and fade in
        const container = document.querySelector('.mobile-container');
        if (container) {
            container.classList.remove('page-loading');
            container.classList.add('fade-in');
        }

        // Initialize icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
{% endblock %}