{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥ - ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢{% endblock %}

{% block content %}
<div class="mobile-container page-loading">
    <!-- App-Title Bar -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i data-lucide="refresh-cw"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥{% if user %} - {{ user.display_name }}{% endif %}
            </h1>
            <p class="subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥</p>
        </div>
    </div>

    <!-- Book-Switcher Strip (Account / Family Switcher) -->
    <div class="book-switcher">
        <button class="book-pill active" data-book="personal">
            Pond Titipong
        </button>
        <button class="book-pill" data-book="family">
            Family POND
        </button>
    </div>

    <!-- Summary Strip -->
    <div class="summary-strip">
        <div class="summary-col income">
            <div class="summary-strip-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
            <div class="summary-strip-amount">0.00</div>
        </div>
        <div class="summary-col expense">
            <div class="summary-strip-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
            <div class="summary-strip-amount">300.00</div>
        </div>
        <div class="summary-col balance">
            <div class="summary-strip-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div class="summary-strip-amount">-300.00</div>
        </div>
    </div>

    <!-- Filter & Sort Section -->
    <div class="section">
        <!-- Quick Filters -->
        <div class="quick-filters">
            <button class="qf-btn active" data-filter="all" onclick="setQuickFilter('all')">
                ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="qf-badge" id="badge-all">0</span>
            </button>
            <button class="qf-btn" data-filter="expense" onclick="setQuickFilter('expense')">
                üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ <span class="qf-badge" id="badge-expense">0</span>
            </button>
            <button class="qf-btn" data-filter="income" onclick="setQuickFilter('income')">
                üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö <span class="qf-badge" id="badge-income">0</span>
            </button>
        </div>

        <!-- Advanced Filter Toggle -->
        <button class="filter-toggle-btn" onclick="toggleAdvancedFilters()">
            <i data-lucide="sliders"></i>
            <span>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
            <i data-lucide="chevron-down" class="toggle-icon"></i>
        </button>

        <!-- Advanced Filters (Collapsible) -->
        <div class="advanced-filters" id="advanced-filters" style="display: none;">
            <!-- Search -->
            <div class="filter-group">
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                <input type="text" class="filter-input" id="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...">
            </div>

            <!-- Category Filter -->
            <div class="filter-group">
                <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="filter-select" id="category-filter">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <!-- Dynamic options from categories -->
                </select>
            </div>

            <!-- Frequency Filter -->
            <div class="filter-group">
                <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                <div class="chip-group">
                    <label class="chip-label">
                        <input type="checkbox" value="daily" onchange="applyFilters()"> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                    </label>
                    <label class="chip-label">
                        <input type="checkbox" value="weekly" onchange="applyFilters()"> ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                    </label>
                    <label class="chip-label">
                        <input type="checkbox" value="monthly" onchange="applyFilters()"> ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </label>
                </div>
            </div>

            <!-- Amount Range -->
            <div class="filter-group">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                <div class="range-inputs">
                    <input type="number" class="filter-input" id="amount-min" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î" min="0">
                    <span>-</span>
                    <input type="number" class="filter-input" id="amount-max" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î" min="0">
                </div>
            </div>

            <!-- Status Toggle -->
            <div class="filter-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="filter-active" checked onchange="applyFilters()">
                    <span>‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </label>
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button class="btn-secondary btn-sm" onclick="resetFilters()">
                    <i data-lucide="rotate-ccw"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
                <button class="btn-primary btn-sm" onclick="applyFilters()">
                    <i data-lucide="check"></i> ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                </button>
            </div>
        </div>

        <!-- Sort & Bulk Actions Bar -->
        <div class="toolbar">
            <!-- Sort Options -->
            <div class="sort-bar">
                <label class="toolbar-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏á:</label>
                <button class="sort-btn active" data-sort="date" onclick="setSortBy('date')">
                    <i data-lucide="calendar"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                </button>
                <button class="sort-btn" data-sort="amount" onclick="setSortBy('amount')">
                    <i data-lucide="dollar-sign"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                </button>
                <button class="sort-btn" data-sort="name" onclick="setSortBy('name')">
                    <i data-lucide="type"></i> ‡∏ä‡∏∑‡πà‡∏≠
                </button>
            </div>

            <!-- Bulk Actions Toggle -->
            <button class="bulk-toggle-btn" onclick="toggleBulkMode()">
                <i data-lucide="check-square"></i>
                <span id="bulk-toggle-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
            </button>
        </div>

        <!-- Bulk Action Bar (Hidden by default) -->
        <div class="bulk-action-bar" id="bulk-action-bar" style="display: none;">
            <div class="bulk-info">
                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                <label for="select-all">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                <span class="selected-count" id="selected-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="bulk-buttons">
                <button class="btn-danger btn-sm" onclick="bulkDelete()">
                    <i data-lucide="trash-2"></i> ‡∏•‡∏ö
                </button>
                <button class="btn-secondary btn-sm" onclick="bulkDeactivate()">
                    <i data-lucide="pause"></i> ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- Recurring List -->
    <div class="section">
        <div class="recurring-list">
            <!-- Sample Recurring Item (Expense) -->
            <div class="recurring-card" data-id="1">
                <div class="recurring-icon expense">
                    <i data-lucide="tv"></i>
                </div>
                <div class="recurring-info">
                    <div class="recurring-title">Netflix</div>
                    <div class="recurring-meta">
                        <span class="recurring-category">‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</span>
                        <span class="recurring-freq">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</span>
                    </div>
                    <div class="recurring-alert">
                        <i data-lucide="bell"></i>
                        ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 3 ‡∏ß‡∏±‡∏ô ‚Ä¢ ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 01/02/2026
                    </div>
                </div>
                <div class="recurring-amount expense">
                    300.00
                </div>
            </div>

            <!-- Empty State (Hidden when has data) -->
            <div class="empty-state" style="display: none;">
                <i data-lucide="calendar-off"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
            </div>
        </div>
    </div>

    <!-- Bottom spacing -->
    <div class="footer-spacing"></div>
</div>

<!-- Floating Action Button -->
<div class="floating-action">
    <button class="btn-fab" id="add-recurring-btn">
        <i data-lucide="plus"></i>
    </button>
</div>

<!-- Modal: Add/Edit Recurring Transaction -->
<div class="modal" id="recurring-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
        <div class="modal-header expense">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h2>
            <button class="modal-close">
                <i data-lucide="x"></i>
            </button>
        </div>
        <form class="modal-body" id="recurring-form">
            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
            <div class="form-group">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select class="form-select" id="recurring-type">
                    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                </select>
            </div>

            <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select class="form-select" id="recurring-category">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" id="expense-categories">
                        <option value="food">üçî ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="transport">üöó ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
                        <option value="entertainment">üé¨ ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</option>
                        <option value="utilities">üí° ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
                        <option value="rent">üè† ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                    </optgroup>
                    <optgroup label="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" id="income-categories" style="display: none;">
                        <option value="salary">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="bonus">üéÅ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</option>
                        <option value="investment">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</option>
                    </optgroup>
                </select>
            </div>

            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                <select class="form-select" id="recurring-frequency">
                    <option value="monthly">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="weekly">‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                    <option value="yearly">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                </select>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <select class="form-select" id="recurring-day">
                    <option value="1">1</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="25">25</option>
                    <option value="28">28</option>
                </select>
            </div>

            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" class="form-input" id="recurring-start-date" required>
            </div>

            <!-- ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Readonly) -->
            <div class="form-group">
                <label class="form-label">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                <input type="text" class="form-input" id="recurring-next-date" readonly value="01/02/2026">
            </div>

            <!-- ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
            <div class="form-group">
                <label class="form-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                <select class="form-select" id="recurring-reminder">
                    <option value="0">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
                    <option value="1">1 ‡∏ß‡∏±‡∏ô</option>
                    <option value="3" selected>3 ‡∏ß‡∏±‡∏ô</option>
                    <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
                </select>
            </div>

            <!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
            <div class="form-group">
                <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
                <textarea class="form-textarea" id="recurring-note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ" rows="2"></textarea>
            </div>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="form-group">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)</label>
                <div class="amount-input-wrapper">
                    <span class="currency">‡∏ø</span>
                    <input type="number" class="form-input amount-input" id="recurring-amount" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-primary">
                <i data-lucide="check"></i>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </button>
        </form>
    </div>
</div>

<!-- Sticky Footer Menu -->
{% set current_page = 'recurring' %}
{% include 'components/footer_menu.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Book Switcher
const bookPills = document.querySelectorAll('.book-pill');
bookPills.forEach(pill => {
    pill.addEventListener('click', () => {
        bookPills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        // TODO: Load data for selected book
    });
});

// Modal controls
const modal = document.getElementById('recurring-modal');
const addBtn = document.getElementById('add-recurring-btn');
const closeBtn = modal.querySelector('.modal-close');
const overlay = modal.querySelector('.modal-overlay');

function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

addBtn.addEventListener('click', openModal);
closeBtn.addEventListener('click', closeModal);
overlay.addEventListener('click', closeModal);

// Type change - toggle header color and category options
const typeSelect = document.getElementById('recurring-type');
const modalHeader = modal.querySelector('.modal-header');
const expenseCategories = document.getElementById('expense-categories');
const incomeCategories = document.getElementById('income-categories');

typeSelect.addEventListener('change', (e) => {
    const type = e.target.value;

    if (type === 'expense') {
        modalHeader.classList.remove('income');
        modalHeader.classList.add('expense');
        expenseCategories.style.display = '';
        incomeCategories.style.display = 'none';
    } else {
        modalHeader.classList.remove('expense');
        modalHeader.classList.add('income');
        expenseCategories.style.display = 'none';
        incomeCategories.style.display = '';
    }
});

// Form submission
document.getElementById('recurring-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnContent = submitBtn.innerHTML;

    // Get form values
    const frequency = document.getElementById('recurring-frequency').value;
    const day = parseInt(document.getElementById('recurring-day').value);
    const amount = parseFloat(document.getElementById('recurring-amount').value);
    const category_id = document.getElementById('recurring-category').value;

    // Validation
    if (!category_id) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
    lucide.createIcons();

    // Prepare payload based on frequency
    const payload = {
        type: document.getElementById('recurring-type').value,
        category_id: category_id,
        amount: Math.round(amount * 100), // Convert baht to satang
        freq: frequency,
        start_date: document.getElementById('recurring-start-date').value,
        remind_days: parseInt(document.getElementById('recurring-reminder').value) || 0,
        note: document.getElementById('recurring-note').value || null
    };

    // Add day_of_month for monthly or day_of_week for weekly
    if (frequency === 'monthly') {
        payload.day_of_month = day;
    } else if (frequency === 'weekly') {
        payload.day_of_week = day;
    }

    try {
        let result;
        if (editingRecurringId) {
            // Update existing recurring rule
            result = await API.put(buildApiUrl('recurring', editingRecurringId), payload);
            showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        } else {
            // Create new recurring rule
            result = await API.post(buildApiUrl('recurring'), payload);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Reset form and state
        document.getElementById('recurring-form').reset();
        editingRecurringId = null;

        // Reset modal header and button text
        const modalHeader = modal.querySelector('.modal-header h2');
        modalHeader.textContent = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
        const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        closeModal();

        // Reload recurring list
        await loadRecurringRules();

    } catch (error) {
        console.error('Recurring error:', error);
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');

    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnContent;
        lucide.createIcons();
    }
});

// Set default start date to today
document.getElementById('recurring-start-date').valueAsDate = new Date();

// Load recurring rules
async function loadRecurringRules() {
    try {
        const result = await API.get(buildApiUrl('recurring') + '?active_only=true');

        const recurringList = document.querySelector('.recurring-list');

        if (result.recurring_rules && result.recurring_rules.length > 0) {
            renderRecurringRules(result.recurring_rules);
        } else {
            // Show empty state
            recurringList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="calendar-off"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
                    <p class="empty-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    } catch (error) {
        console.error('Error loading recurring rules:', error);
    }
}

// ===== GLOBAL STATE =====
let allRecurringRules = [];
let filteredRules = [];
let currentFilter = {
    type: 'all',
    activeOnly: true,
    search: '',
    category: 'all',
    frequencies: [],
    amountMin: null,
    amountMax: null
};
let currentSort = 'date';
let isBulkMode = false;
let selectedIds = new Set();

// ===== RENDER FUNCTIONS =====
function renderRecurringRules(rules) {
    allRecurringRules = rules;
    
    // Update count badges
    updateCountBadges(rules);
    
    // Populate category filter
    populateCategoryFilter(rules);
    
    // Apply filters and sort
    applyFilters();
}

function updateCountBadges(rules) {
    const counts = {
        all: rules.length,
        expense: rules.filter(r => r.type === 'expense').length,
        income: rules.filter(r => r.type === 'income').length
    };
    
    document.getElementById('badge-all').textContent = counts.all;
    document.getElementById('badge-expense').textContent = counts.expense;
    document.getElementById('badge-income').textContent = counts.income;
}

function populateCategoryFilter(rules) {
    const categories = new Map();
    rules.forEach(rule => {
        if (rule.category) {
            categories.set(rule.category.id, rule.category);
        }
    });
    
    const select = document.getElementById('category-filter');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = `${cat.icon || ''} ${cat.name_th}`;
        select.appendChild(option);
    });
    
    select.value = currentValue;
}

function applyFilters() {
    // Start with all rules
    let filtered = [...allRecurringRules];
    
    // Filter by type
    if (currentFilter.type !== 'all') {
        filtered = filtered.filter(r => r.type === currentFilter.type);
    }
    
    // Filter by active status
    if (currentFilter.activeOnly) {
        filtered = filtered.filter(r => r.is_active);
    }
    
    // Filter by search
    if (currentFilter.search) {
        const searchLower = currentFilter.search.toLowerCase();
        filtered = filtered.filter(r => 
            (r.category?.name_th || '').toLowerCase().includes(searchLower) ||
            (r.category?.name_en || '').toLowerCase().includes(searchLower) ||
            (r.note || '').toLowerCase().includes(searchLower)
        );
    }
    
    // Filter by category
    if (currentFilter.category !== 'all') {
        filtered = filtered.filter(r => r.category_id === currentFilter.category);
    }
    
    // Filter by frequencies
    if (currentFilter.frequencies.length > 0) {
        filtered = filtered.filter(r => currentFilter.frequencies.includes(r.freq));
    }
    
    // Filter by amount range
    if (currentFilter.amountMin !== null) {
        filtered = filtered.filter(r => r.amount >= currentFilter.amountMin * 100);
    }
    if (currentFilter.amountMax !== null) {
        filtered = filtered.filter(r => r.amount <= currentFilter.amountMax * 100);
    }
    
    // Apply sort
    filtered = sortRules(filtered, currentSort);
    
    filteredRules = filtered;
    renderCards(filtered);
}

function sortRules(rules, sortBy) {
    const sorted = [...rules];
    
    switch(sortBy) {
        case 'date':
            sorted.sort((a, b) => {
                const dateA = new Date(a.next_run_date);
                const dateB = new Date(b.next_run_date);
                return dateB - dateA;
            });
            break;
        case 'amount':
            sorted.sort((a, b) => b.amount - a.amount);
            break;
        case 'name':
            sorted.sort((a, b) => {
                const nameA = (a.category?.name_th || '').toLowerCase();
                const nameB = (b.category?.name_th || '').toLowerCase();
                return nameA.localeCompare(nameB, 'th');
            });
            break;
    }
    
    return sorted;
}

function renderCards(rules) {
    const recurringList = document.querySelector('.recurring-list');
    
    if (rules.length === 0) {
        renderEmptyState();
        return;
    }
    
    recurringList.innerHTML = rules.map(rule => renderCard(rule)).join('');
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function renderCard(rule) {
    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
    };
    
    const formatAmount = (amount) => {
        return (amount / 100).toLocaleString('th-TH', { minimumFractionDigits: 0 });
    };
    
    const formatFrequency = (freq, dayOfWeek, dayOfMonth) => {
        if (freq === 'daily') return 'üîÅ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
        if (freq === 'weekly') {
            const days = ['‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™', '‡∏≠‡∏≤'];
            return `üîÅ ${days[dayOfWeek]}`;
        }
        if (freq === 'monthly') return `üîÅ ${dayOfMonth}`;
        return freq;
    };
    
    const renderIcon = (iconName) => {
        if (!iconName) return 'üîÑ';
        const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(iconName);
        if (isEmoji) return iconName;
        return `<i data-lucide="${iconName}"></i>`;
    };
    
    const isSelected = selectedIds.has(rule.id);
    
    return `
        <div class="recurring-card-v2 ${rule.type}" 
             data-id="${rule.id}" 
             data-type="${rule.type}"
             data-freq="${rule.freq}"
             data-amount="${rule.amount}"
             data-category="${rule.category_id || ''}"
             data-active="${rule.is_active}"
             onclick="${isBulkMode ? `toggleCardSelection('${rule.id}')` : ''}">
            
            ${isBulkMode ? `
                <div class="card-checkbox-wrapper">
                    <input type="checkbox" 
                           class="card-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleCardSelection('${rule.id}')"
                           onclick="event.stopPropagation()">
                </div>
            ` : ''}
            
            <div class="card-header">
                <div class="card-icon ${rule.type}">
                    ${renderIcon(rule.category?.icon)}
                </div>
                <div class="card-title-amount">
                    <div class="card-title">${rule.category?.name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div class="card-amount ${rule.type}">
                        ${rule.type === 'expense' ? '-' : '+'}‡∏ø${formatAmount(rule.amount)}
                    </div>
                </div>
            </div>
            
            <div class="card-details">
                <span class="card-detail-item">
                    ${formatFrequency(rule.freq, rule.day_of_week, rule.day_of_month)}
                </span>
                ${rule.next_run_date ? `
                    <span class="card-detail-item">
                        üìÖ ${formatDate(rule.next_run_date)}
                    </span>
                ` : ''}
            </div>
            
            ${!isBulkMode ? `
                <div class="card-actions">
                    <button class="card-action-btn" 
                            onclick="event.stopPropagation(); editRecurring('${rule.id}')" 
                            title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                        <i data-lucide="edit-2"></i>
                    </button>
                    <button class="card-action-btn delete" 
                            onclick="event.stopPropagation(); deleteRecurring('${rule.id}')" 
                            title="‡∏•‡∏ö">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            ` : ''}
        </div>
    `;
}

function renderEmptyState() {
    const recurringList = document.querySelector('.recurring-list');
    const isFiltered = currentFilter.type !== 'all' || currentFilter.search || 
                      currentFilter.category !== 'all' || currentFilter.frequencies.length > 0;
    
    if (isFiltered) {
        recurringList.innerHTML = `
            <div class="empty-state">
                <i data-lucide="search-x"></i>
                <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                <p>‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</p>
                <button class="btn-secondary" onclick="resetFilters()">
                    ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                </button>
            </div>
        `;
    } else {
        recurringList.innerHTML = `
            <div class="empty-state">
                <i data-lucide="calendar-plus"></i>
                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h3>
                <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                <button class="btn-primary" onclick="openAddModal()">
                    <i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                </button>
            </div>
        `;
    }
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// ===== FILTER & SORT HANDLERS =====
function setQuickFilter(type) {
    currentFilter.type = type;
    
    // Update active button
    document.querySelectorAll('.qf-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === type);
    });
    
    applyFilters();
}

function toggleAdvancedFilters() {
    const advancedFilters = document.getElementById('advanced-filters');
    const toggleIcon = document.querySelector('.filter-toggle-btn .toggle-icon');
    const isVisible = advancedFilters.style.display !== 'none';
    
    advancedFilters.style.display = isVisible ? 'none' : 'block';
    toggleIcon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
}

function setSortBy(sortBy) {
    currentSort = sortBy;
    
    // Update active button
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.sort === sortBy);
    });
    
    applyFilters();
}

function resetFilters() {
    currentFilter = {
        type: 'all',
        activeOnly: true,
        search: '',
        category: 'all',
        frequencies: [],
        amountMin: null,
        amountMax: null
    };
    
    // Reset UI
    document.getElementById('search-input').value = '';
    document.getElementById('category-filter').value = 'all';
    document.getElementById('amount-min').value = '';
    document.getElementById('amount-max').value = '';
    document.getElementById('filter-active').checked = true;
    
    // Reset frequency checkboxes
    document.querySelectorAll('.chip-group input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset quick filter
    setQuickFilter('all');
}

// Real-time filter updates
document.addEventListener('DOMContentLoaded', () => {
    // Search input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            currentFilter.search = e.target.value;
            applyFilters();
        });
    }
    
    // Category filter
    const categoryFilter = document.getElementById('category-filter');
    if (categoryFilter) {
        categoryFilter.addEventListener('change', (e) => {
            currentFilter.category = e.target.value;
            applyFilters();
        });
    }
    
    // Amount range
    const amountMin = document.getElementById('amount-min');
    const amountMax = document.getElementById('amount-max');
    if (amountMin) {
        amountMin.addEventListener('change', (e) => {
            currentFilter.amountMin = e.target.value ? parseFloat(e.target.value) : null;
            applyFilters();
        });
    }
    if (amountMax) {
        amountMax.addEventListener('change', (e) => {
            currentFilter.amountMax = e.target.value ? parseFloat(e.target.value) : null;
            applyFilters();
        });
    }
    
    // Frequency checkboxes
    document.querySelectorAll('.chip-group input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            currentFilter.frequencies = Array.from(
                document.querySelectorAll('.chip-group input[type="checkbox"]:checked')
            ).map(cb => cb.value);
            applyFilters();
        });
    });
});

// ===== BULK ACTIONS =====
function toggleBulkMode() {
    isBulkMode = !isBulkMode;
    selectedIds.clear();
    
    const bulkActionBar = document.getElementById('bulk-action-bar');
    const bulkToggleText = document.getElementById('bulk-toggle-text');
    
    bulkActionBar.style.display = isBulkMode ? 'flex' : 'none';
    bulkToggleText.textContent = isBulkMode ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
    
    // Re-render cards with/without checkboxes
    renderCards(filteredRules);
    updateSelectedCount();
}

function toggleCardSelection(ruleId) {
    if (selectedIds.has(ruleId)) {
        selectedIds.delete(ruleId);
    } else {
        selectedIds.add(ruleId);
    }
    
    updateSelectedCount();
    
    // Update checkbox state
    const card = document.querySelector(`.recurring-card-v2[data-id="${ruleId}"]`);
    if (card) {
        const checkbox = card.querySelector('.card-checkbox');
        if (checkbox) {
            checkbox.checked = selectedIds.has(ruleId);
        }
    }
    
    // Update select-all checkbox
    const selectAllCheckbox = document.getElementById('select-all');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = selectedIds.size === filteredRules.length && filteredRules.length > 0;
    }
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    
    if (selectAllCheckbox.checked) {
        // Select all visible cards
        filteredRules.forEach(rule => selectedIds.add(rule.id));
    } else {
        // Deselect all
        selectedIds.clear();
    }
    
    updateSelectedCount();
    renderCards(filteredRules);
}

function updateSelectedCount() {
    const selectedCount = document.getElementById('selected-count');
    if (selectedCount) {
        selectedCount.textContent = `${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    }
}

async function bulkDelete() {
    if (selectedIds.size === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
        return;
    }
    
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) {
        return;
    }
    
    const deletePromises = Array.from(selectedIds).map(id => 
        API.delete(buildApiUrl('recurring', id))
    );
    
    try {
        await Promise.all(deletePromises);
        showToast(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
        
        selectedIds.clear();
        toggleBulkMode();
        await loadRecurringRules();
    } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
    }
}

async function bulkDeactivate() {
    if (selectedIds.size === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
        return;
    }
    
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) {
        return;
    }
    
    // Note: This requires an API endpoint for bulk update
    // For now, just show a message
    showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', 'info');
    
    // TODO: Implement bulk deactivate API endpoint
    // const updatePromises = Array.from(selectedIds).map(id => 
    //     API.put(buildApiUrl('recurring', id), { is_active: false })
    // );
}

// ===== EDIT & DELETE =====
let editingRecurringId = null;

async function editRecurring(recurringId) {
    try {
        // Fetch recurring rule details
        const result = await API.get(buildApiUrl('recurring', recurringId));
        const rule = result.recurring_rule;

        editingRecurringId = recurringId;

        // Pre-fill form
        document.getElementById('recurring-type').value = rule.type;
        document.getElementById('recurring-category').value = rule.category_id;
        document.getElementById('recurring-frequency').value = rule.freq;
        document.getElementById('recurring-day').value = rule.day_of_month || rule.day_of_week || 1;
        document.getElementById('recurring-start-date').value = rule.start_date;
        document.getElementById('recurring-reminder').value = rule.remind_days || 0;
        document.getElementById('recurring-note').value = rule.note || '';
        document.getElementById('recurring-amount').value = (rule.amount / 100).toFixed(2);

        // Trigger type change to show correct categories
        document.getElementById('recurring-type').dispatchEvent(new Event('change'));

        // Change modal header and button text
        const modalHeader = modal.querySelector('.modal-header h2');
        modalHeader.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥';

        const submitBtn = document.querySelector('#recurring-form button[type="submit"] span');
        submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó';

        openModal();

    } catch (error) {
        showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
    }
}

// Delete recurring rule
async function deleteRecurring(recurringId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    try {
        await API.delete(buildApiUrl('recurring') + `/${recurringId}`);
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        await loadRecurringRules();
    } catch (error) {
        showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Load categories for dropdown
async function loadCategories() {
    try {
        const result = await API.get(buildApiUrl('categories'));

        if (result.categories && result.categories.length > 0) {
            const categories = result.categories;

            const expenseCategories = categories.filter(cat => cat.type === 'expense' && cat.is_active);
            const incomeCategories = categories.filter(cat => cat.type === 'income' && cat.is_active);

            const expenseGroup = document.getElementById('expense-categories');
            const incomeGroup = document.getElementById('income-categories');

            // Helper to get icon display (emoji stays as is, Lucide shows as text for dropdown)
            const getIconDisplay = (icon) => {
                // Check if it's emoji
                const isEmoji = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(icon || '');
                return isEmoji ? icon : 'üìÅ'; // Use folder emoji as fallback for Lucide icons in dropdown
            };

            if (expenseGroup) {
                expenseGroup.innerHTML = expenseCategories.map(cat =>
                    `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                ).join('');
            }

            if (incomeGroup) {
                incomeGroup.innerHTML = incomeCategories.map(cat =>
                    `<option value="${cat.id}">${getIconDisplay(cat.icon)} ${cat.name_th}</option>`
                ).join('');
            }
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Load on page ready
document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories();
    await loadRecurringRules();
    
    // Remove loading class and fade in
    const container = document.querySelector('.mobile-container');
    if (container) {
        container.classList.remove('page-loading');
        container.classList.add('fade-in');
    }
    
    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
